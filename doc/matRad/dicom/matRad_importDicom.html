<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of matRad_importDicom</title>
  <meta name="keywords" content="matRad_importDicom">
  <meta name="description" content="matRad wrapper function to import a predefined set of dicom files">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../menu.html matRad --><!-- menu.html dicom -->
<h1>matRad_importDicom
</h1>

<h2><a name="_name"></a>Purpose <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box">matRad wrapper function to import a predefined set of dicom files</div>

<h2><a name="_synopsis"></a>Synopsis <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box">function [ct, cst, pln, resultGUI] = matRad_importDicom( files, dicomMetaBool ) </div>

<h2><a name="_description"></a>Description <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> matRad wrapper function to import a predefined set of dicom files 
 into matRad's native data formats
 
 call
 [ct, cst, pln, resultGUI] = matRad_importDicom( files )  
 [ct, cst, pln, resultGUI] = matRad_importDicom( files, dicomMetaBool )

 input
   files:          list of files to be imported (will contain cts and rt
                   structure set)
   dicomMetaBool:  (boolean, optional) import complete dicomInfo and
                   patientName

 output
   ct:        matRad ct struct
   cst:       matRad cst struct
   pln:       matRad plan struct
   resultGUI: matRad result struct holding data for visualization in GUI

 References
   -

 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

 Copyright 2015 the matRad development team. 
 
 This file is part of the matRad project. It is subject to the license 
 terms in the LICENSE file found in the top-level directory of this 
 distribution and at https://github.com/e0404/matRad/LICENSES.txt. No part 
 of the matRad project, including this file, may be copied, modified, 
 propagated, or distributed except according to the terms contained in the 
 LICENSE file.

 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>Cross-reference information <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-type:disc">
<li><a href="matRad_convRtssContours2Indices.html" class="code" title="function indices = matRad_convRtssContours2Indices(structure,ct)">matRad_convRtssContours2Indices</a>	matRad function to convert a polygon segmentation from an rt structure</li><li><a href="matRad_createCst.html" class="code" title="function cst = matRad_createCst(structures)">matRad_createCst</a>	matRad function to create a cst struct upon dicom import</li><li><a href="matRad_dummyCst.html" class="code" title="function cst = matRad_dummyCst(ct)">matRad_dummyCst</a>	matRad function to create a dummy cst struct for a ct</li><li><a href="matRad_importDicomCt.html" class="code" title="function ct = matRad_importDicomCt(ctList, resolution, dicomMetaBool, grid, visBool)">matRad_importDicomCt</a>	matRad function to import dicom ct data</li><li><a href="matRad_importDicomRTDose.html" class="code" title="function [resultGUI] = matRad_importDicomRTDose(ct, rtDoseFiles, pln)">matRad_importDicomRTDose</a>	matRad function to import dicom RTDOSE data</li><li><a href="matRad_importDicomRTPlan.html" class="code" title="function pln = matRad_importDicomRTPlan(ct, rtPlanFiles, dicomMetaBool)">matRad_importDicomRTPlan</a>	matRad function to import dicom RTPLAN data</li><li><a href="matRad_importDicomRtss.html" class="code" title="function structures = matRad_importDicomRtss(filename,dicomInfo,visBool)">matRad_importDicomRtss</a>	matRad function to read the data of the selected dicomRT structure set file</li><li><a href="matRad_importDicomSteeringParticles.html" class="code" title="function [stf, pln] = matRad_importDicomSteeringParticles(ct, pln, rtPlanFile)">matRad_importDicomSteeringParticles</a>	matRad function to import a matRad stf struct from dicom RTPLAN data</li><li><a href="matRad_importDicomSteeringPhotons.html" class="code" title="function [stf, pln] = matRad_importDicomSteeringPhotons(pln)">matRad_importDicomSteeringPhotons</a>	matRad function to import a matRad stf struct from dicom RTPLAN data</li><li><a href="../../matRad/tools/matRad_getEnvironment.html" class="code" title="function [env, versionString] = matRad_getEnvironment()">matRad_getEnvironment</a>	matRad function to get the software environment matRad is running on</li></ul>
This function is called by:
<ul style="list-style-type:disc">
<li><a href="matRad_importDicomGUI.html" class="code" title="function varargout = matRad_importDicomGUI(varargin)">matRad_importDicomGUI</a>	MATRAD_IMPORTDICOMGUI MATLAB code for matRad_importDicomGUI.fig</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>Source code <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [ct, cst, pln, resultGUI] = matRad_importDicom( files, dicomMetaBool )</a>
0002 <span class="comment">% matRad wrapper function to import a predefined set of dicom files</span>
0003 <span class="comment">% into matRad's native data formats</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% call</span>
0006 <span class="comment">% [ct, cst, pln, resultGUI] = matRad_importDicom( files )</span>
0007 <span class="comment">% [ct, cst, pln, resultGUI] = matRad_importDicom( files, dicomMetaBool )</span>
0008 <span class="comment">%</span>
0009 <span class="comment">% input</span>
0010 <span class="comment">%   files:          list of files to be imported (will contain cts and rt</span>
0011 <span class="comment">%                   structure set)</span>
0012 <span class="comment">%   dicomMetaBool:  (boolean, optional) import complete dicomInfo and</span>
0013 <span class="comment">%                   patientName</span>
0014 <span class="comment">%</span>
0015 <span class="comment">% output</span>
0016 <span class="comment">%   ct:        matRad ct struct</span>
0017 <span class="comment">%   cst:       matRad cst struct</span>
0018 <span class="comment">%   pln:       matRad plan struct</span>
0019 <span class="comment">%   resultGUI: matRad result struct holding data for visualization in GUI</span>
0020 <span class="comment">%</span>
0021 <span class="comment">% References</span>
0022 <span class="comment">%   -</span>
0023 <span class="comment">%</span>
0024 <span class="comment">% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0025 <span class="comment">%</span>
0026 <span class="comment">% Copyright 2015 the matRad development team.</span>
0027 <span class="comment">%</span>
0028 <span class="comment">% This file is part of the matRad project. It is subject to the license</span>
0029 <span class="comment">% terms in the LICENSE file found in the top-level directory of this</span>
0030 <span class="comment">% distribution and at https://github.com/e0404/matRad/LICENSES.txt. No part</span>
0031 <span class="comment">% of the matRad project, including this file, may be copied, modified,</span>
0032 <span class="comment">% propagated, or distributed except according to the terms contained in the</span>
0033 <span class="comment">% LICENSE file.</span>
0034 <span class="comment">%</span>
0035 <span class="comment">% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0036 
0037 [env, ~] = <a href="../../matRad/tools/matRad_getEnvironment.html" class="code" title="function [env, versionString] = matRad_getEnvironment()">matRad_getEnvironment</a>();
0038     
0039 <span class="comment">%%</span>
0040 <span class="keyword">if</span> ~exist(<span class="string">'dicomMetaBool'</span>,<span class="string">'var'</span>)
0041   dicomMetaBool = true;
0042 <span class="keyword">end</span>
0043 
0044 <span class="comment">%%</span>
0045 h = waitbar(0,<span class="string">'Please wait...'</span>);
0046 <span class="comment">%h.WindowStyle = 'Modal';</span>
0047 steps = 2;
0048 
0049 <span class="comment">%% import ct-cube</span>
0050 waitbar(1 / steps)
0051 resolution.x = files.resx;
0052 resolution.y = files.resy;
0053 resolution.z = files.resz; <span class="comment">% [mm] / lps coordinate system</span>
0054 <span class="keyword">if</span> files.useDoseGrid &amp;&amp; isfield(files,<span class="string">'rtdose'</span>)
0055     <span class="comment">% get grid from dose cube</span>
0056     <span class="keyword">if</span> verLessThan(<span class="string">'matlab'</span>,<span class="string">'9'</span>)
0057         doseInfo = dicominfo(files.rtdose{1,1});
0058     <span class="keyword">else</span>
0059         doseInfo = dicominfo(files.rtdose{1,1},<span class="string">'UseDictionaryVR'</span>,true);
0060     <span class="keyword">end</span>
0061     doseGrid{1} = doseInfo.ImagePositionPatient(1) + doseInfo.ImageOrientationPatient(1) * <span class="keyword">...</span>
0062                                                      doseInfo.PixelSpacing(1) * double(0:doseInfo.Columns - 1);
0063     doseGrid{2} = doseInfo.ImagePositionPatient(2) + doseInfo.ImageOrientationPatient(5) * <span class="keyword">...</span>
0064                                                      doseInfo.PixelSpacing(2) * double(0:doseInfo.Rows - 1);
0065     doseGrid{3} = doseInfo.ImagePositionPatient(3) + doseInfo.GridFrameOffsetVector(:)';
0066 
0067     <span class="comment">% get ct on grid</span>
0068     ct = <a href="matRad_importDicomCt.html" class="code" title="function ct = matRad_importDicomCt(ctList, resolution, dicomMetaBool, grid, visBool)">matRad_importDicomCt</a>(files.ct, resolution, dicomMetaBool,doseGrid); 
0069 
0070 <span class="keyword">else</span>
0071     ct = <a href="matRad_importDicomCt.html" class="code" title="function ct = matRad_importDicomCt(ctList, resolution, dicomMetaBool, grid, visBool)">matRad_importDicomCt</a>(files.ct, resolution, dicomMetaBool); 
0072 <span class="keyword">end</span>
0073 
0074 <span class="keyword">if</span> ~isempty(files.rtss)
0075     
0076     <span class="comment">%% import structure data</span>
0077     waitbar(2 / steps)
0078     structures = <a href="matRad_importDicomRtss.html" class="code" title="function structures = matRad_importDicomRtss(filename,dicomInfo,visBool)">matRad_importDicomRtss</a>(files.rtss{1},ct.dicomInfo);
0079     close(h)
0080 
0081     <span class="comment">%% creating structure cube</span>
0082     h = waitbar(0,<span class="string">'Please wait...'</span>);
0083     <span class="comment">%h.WindowStyle = 'Modal';</span>
0084     steps = numel(structures);
0085     <span class="keyword">for</span> i = 1:numel(structures)
0086         <span class="comment">% computations take place here</span>
0087         waitbar(i / steps)
0088         fprintf(<span class="string">'creating cube for %s volume...\n'</span>, structures(i).structName);
0089         structures(i).indices = <a href="matRad_convRtssContours2Indices.html" class="code" title="function indices = matRad_convRtssContours2Indices(structure,ct)">matRad_convRtssContours2Indices</a>(structures(i),ct);
0090     <span class="keyword">end</span>
0091     fprintf(<span class="string">'finished!\n'</span>);
0092     close(h)
0093 
0094     <span class="comment">%% creating cst</span>
0095     cst = <a href="matRad_createCst.html" class="code" title="function cst = matRad_createCst(structures)">matRad_createCst</a>(structures);
0096 
0097 <span class="keyword">else</span>
0098     
0099     cst = <a href="matRad_dummyCst.html" class="code" title="function cst = matRad_dummyCst(ct)">matRad_dummyCst</a>(ct);
0100     
0101 <span class="keyword">end</span>
0102 
0103 <span class="comment">%% determine pln parameters</span>
0104 <span class="keyword">if</span> isfield(files,<span class="string">'rtplan'</span>)
0105     <span class="keyword">if</span> ~(cellfun(@isempty,files.rtplan(1,:)))
0106         pln = <a href="matRad_importDicomRTPlan.html" class="code" title="function pln = matRad_importDicomRTPlan(ct, rtPlanFiles, dicomMetaBool)">matRad_importDicomRTPlan</a>(ct, files.rtplan, dicomMetaBool);
0107     <span class="keyword">end</span>
0108 <span class="keyword">end</span>
0109 
0110 <span class="comment">%% import stf</span>
0111 <span class="keyword">if</span> isfield(files,<span class="string">'rtplan'</span>)
0112     <span class="keyword">if</span> ~(cellfun(@isempty,files.rtplan(1,:)))
0113         <span class="keyword">if</span> (strcmp(pln.radiationMode,<span class="string">'protons'</span>) || strcmp(pln.radiationMode,<span class="string">'carbon'</span>))
0114             <span class="comment">%% import steering file</span>
0115             <span class="comment">% pln output because bixelWidth is determined via the stf</span>
0116             [stf, pln] = <a href="matRad_importDicomSteeringParticles.html" class="code" title="function [stf, pln] = matRad_importDicomSteeringParticles(ct, pln, rtPlanFile)">matRad_importDicomSteeringParticles</a>(ct, pln, files.rtplan);
0117         <span class="keyword">elseif</span> strcmp(pln.radiationMode, <span class="string">'photons'</span>) &amp;&amp; isfield(pln.propStf,<span class="string">'collimation'</span>)
0118             <span class="comment">% return correct angles in pln</span>
0119             [stf, pln] = <a href="matRad_importDicomSteeringPhotons.html" class="code" title="function [stf, pln] = matRad_importDicomSteeringPhotons(pln)">matRad_importDicomSteeringPhotons</a>(pln);
0120         <span class="keyword">else</span>
0121             warning(<span class="string">'No support for DICOM import of steering information for this modality.'</span>);
0122         <span class="keyword">end</span>
0123     <span class="keyword">end</span>
0124 <span class="keyword">end</span>
0125 
0126 <span class="comment">%% import dose cube</span>
0127 <span class="keyword">if</span> isfield(files,<span class="string">'rtdose'</span>)
0128     <span class="comment">% check if files.rtdose contains a path and is labeld as RTDose</span>
0129     <span class="comment">% only the first two elements are relevant for loading the rt dose</span>
0130     <span class="keyword">if</span> ~(cellfun(@isempty,files.rtdose(1,1:2))) 
0131         fprintf(<span class="string">'loading Dose files \n'</span>, structures(i).structName);
0132         <span class="comment">% parse plan in order to scale dose cubes to a fraction based dose</span>
0133         <span class="keyword">if</span> exist(<span class="string">'pln'</span>,<span class="string">'var'</span>)
0134             <span class="keyword">if</span> isfield(pln,<span class="string">'numOfFractions'</span>)
0135                 resultGUI = <a href="matRad_importDicomRTDose.html" class="code" title="function [resultGUI] = matRad_importDicomRTDose(ct, rtDoseFiles, pln)">matRad_importDicomRTDose</a>(ct, files.rtdose, pln);
0136             <span class="keyword">end</span>
0137         <span class="keyword">else</span>
0138             resultGUI = <a href="matRad_importDicomRTDose.html" class="code" title="function [resultGUI] = matRad_importDicomRTDose(ct, rtDoseFiles, pln)">matRad_importDicomRTDose</a>(ct, files.rtdose);
0139         <span class="keyword">end</span>
0140         <span class="keyword">if</span> size(resultGUI) == 0
0141            clear resultGUI;
0142         <span class="keyword">end</span>
0143     <span class="keyword">end</span>
0144 <span class="keyword">end</span>
0145 
0146 <span class="comment">%% put weight also into resultGUI</span>
0147 <span class="keyword">if</span> exist(<span class="string">'stf'</span>,<span class="string">'var'</span>) &amp;&amp; exist(<span class="string">'resultGUI'</span>,<span class="string">'var'</span>)
0148     resultGUI.w = [];
0149     <span class="keyword">for</span> i = 1:size(stf,2)
0150         resultGUI.w = [resultGUI.w; [stf(i).ray.weight]'];
0151     <span class="keyword">end</span>
0152 <span class="keyword">end</span>
0153 
0154 <span class="comment">%% save ct, cst, pln, dose</span>
0155 matRadFileName = [files.ct{1,3} <span class="string">'.mat'</span>]; <span class="comment">% use default from dicom</span>
0156 [FileName,PathName] = uiputfile(<span class="string">'*'</span>,<span class="string">'Save as...'</span>,matRadFileName);
0157 <span class="keyword">if</span> ischar(FileName)
0158     <span class="comment">% delete unnecessary variables</span>
0159     <span class="keyword">switch</span> env
0160     <span class="keyword">case</span> <span class="string">'MATLAB'</span>
0161         clearvars -except ct cst pln stf resultGUI FileName PathName;
0162     <span class="keyword">case</span> <span class="string">'OCTAVE'</span> 
0163         clear -x ct cst pln stf resultGUI FileName PathName;
0164     <span class="keyword">end</span>
0165     <span class="comment">% save all except FileName and PathName</span>
0166     save([PathName, FileName], <span class="string">'-regexp'</span>, <span class="string">'^(?!(FileName|PathName)$).'</span>,<span class="string">'-v7.3'</span>);
0167 <span class="keyword">end</span></pre></div>
<hr><address><a href="https://e0404.github.io/matRad/" target="_parent"><img src="https://camo.githubusercontent.com/0a593ef6a04757c975b9f4634f6731ea0b019bbd/68747470733a2f2f7261776769742e636f6d2f77696b692f65303430342f6d61745261642f696d616765732f6d61747261645f626c616e6b2e737667" height="12px"/></a> | Generated by  <a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>