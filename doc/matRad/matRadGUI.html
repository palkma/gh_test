<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of matRadGUI</title>
  <meta name="keywords" content="matRadGUI">
  <meta name="description" content="matRad GUI">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- menu.html matRad -->
<h1>matRadGUI
</h1>

<h2><a name="_name"></a>Purpose <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box">matRad GUI</div>

<h2><a name="_synopsis"></a>Synopsis <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box">function varargout = matRadGUI(varargin) </div>

<h2><a name="_description"></a>Description <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> matRad GUI

 call
      MATRADGUI, by itself, creates a new MATRADGUI or raises the existing
      singleton*.

      H = MATRADGUI returns the handle to a new MATRADGUI or the handle to
      the existing singleton*.

      MATRADGUI('CALLBACK',hObject,eventData,handles,...) calls the local
      function named CALLBACK in MATRADGUI.M with the given input arguments.

      MATRADGUI('Property','Value',...) creates a new MATRADGUI or raises the
      existing singleton*.  Starting from the left, property value pairs are
      applied to the GUI before matRadGUI_OpeningFcn gets called.  An
      unrecognized property name or invalid value makes property application
      stop.  All inputs are passed to matRadGUI_OpeningFcn via varargin.

      *See GUI Options on GUIDE's Tools menu.  Choose &quot;GUI allows only one
      instance to run (singleton)&quot;.

 See also: GUIDE, GUIDATA, GUIHANDLES

 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

 Copyright 2015 the <a href="matRad.html" class="code" title="">matRad</a> development team.

 This file is part of the <a href="matRad.html" class="code" title="">matRad</a> project. It is subject to the license
 terms in the LICENSE file found in the top-level directory of this
 distribution and at https://github.com/e0404/matRad/LICENSES.txt. No part
 of the <a href="matRad.html" class="code" title="">matRad</a> project, including this file, may be copied, modified,
 propagated, or distributed except according to the terms contained in the
 LICENSE file.

 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>Cross-reference information <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-type:disc">
<li><a href="../matRad/IO/matRad_exportGUI.html" class="code" title="function varargout = matRad_exportGUI(varargin)">matRad_exportGUI</a>	MATRAD_EXPORTGUI MATLAB code for matRad_exportGUI.fig</li><li><a href="../matRad/IO/matRad_importGUI.html" class="code" title="function varargout = matRad_importGUI(varargin)">matRad_importGUI</a>	MATRAD_IMPORTGUI MATLAB code for matRad_importGUI.fig</li><li><a href="../matRad/IO/matRad_readCube.html" class="code" title="function [cube, metadata] = matRad_readCube(filename)">matRad_readCube</a>	matRad Cube read wrapper</li><li><a href="../matRad/dicom/matRad_importDicomGUI.html" class="code" title="function varargout = matRad_importDicomGUI(varargin)">matRad_importDicomGUI</a>	MATRAD_IMPORTDICOMGUI MATLAB code for matRad_importDicomGUI.fig</li><li><a href="matRad_calcCubes.html" class="code" title="function resultGUI = matRad_calcCubes(w,dij,scenNum)">matRad_calcCubes</a>	matRad computation of all cubes for the resultGUI struct</li><li><a href="matRad_calcParticleDose.html" class="code" title="function dij = matRad_calcParticleDose(ct,stf,pln,cst,calcDoseDirect)">matRad_calcParticleDose</a>	matRad particle dose calculation wrapper</li><li><a href="matRad_calcPhotonDose.html" class="code" title="function dij = matRad_calcPhotonDose(ct,stf,pln,cst,calcDoseDirect)">matRad_calcPhotonDose</a>	matRad photon dose calculation wrapper</li><li><a href="matRad_directApertureOptimization.html" class="code" title="function [optResult,optimizer] = matRad_directApertureOptimization(dij,cst,apertureInfo,optResult,pln)">matRad_directApertureOptimization</a>	matRad function to run direct aperture optimization</li><li><a href="matRad_electronDensitiesToHU.html" class="code" title="function ct = matRad_electronDensitiesToHU(ct)">matRad_electronDensitiesToHU</a>	matRad function to calculate recalculate HU values from equivalent densities</li><li><a href="matRad_fluenceOptimization.html" class="code" title="function [resultGUI,optimizer] = matRad_fluenceOptimization(dij,cst,pln)">matRad_fluenceOptimization</a>	matRad inverse planning wrapper function</li><li><a href="matRad_generateStf.html" class="code" title="function stf = matRad_generateStf(ct,cst,pln,visMode)">matRad_generateStf</a>	matRad steering information generation</li><li><a href="matRad_getIsoCenter.html" class="code" title="function isoCenter = matRad_getIsoCenter(cst,ct,visBool)">matRad_getIsoCenter</a>	computes the isocenter [mm] as the joint center of gravity</li><li><a href="matRad_getRotationMatrix.html" class="code" title="function rotMat = matRad_getRotationMatrix(gantryAngle,couchAngle,system)">matRad_getRotationMatrix</a>	matRad function to return the rotation / transformation matrix</li><li><a href="matRad_indicatorWrapper.html" class="code" title="function [dvh,qi] = matRad_indicatorWrapper(cst,pln,resultGUI,refGy,refVol,param)">matRad_indicatorWrapper</a>	matRad indictor wrapper</li><li><a href="matRad_siddonRayTracer.html" class="code" title="function [alphas,l,rho,d12,ix] = matRad_siddonRayTracer(isocenter,resolution,sourcePoint,targetPoint,cubes)">matRad_siddonRayTracer</a>	siddon ray tracing through 3D cube to calculate the radiological depth</li><li><a href="matRad_siochiLeafSequencing.html" class="code" title="function resultGUI = matRad_siochiLeafSequencing(resultGUI,stf,dij,numOfLevels,visBool)">matRad_siochiLeafSequencing</a>	multileaf collimator leaf sequencing algorithm</li><li><a href="matRad_version.html" class="code" title="function [versionString,matRadVer] = matRad_version()">matRad_version</a>	matRad function to get the current matRad version</li><li><a href="matRad_visApertureInfo.html" class="code" title="function matRad_visApertureInfo(apertureInfo,mode)">matRad_visApertureInfo</a>	matRad function to visualize aperture shapes stored as struct</li><li><a href="../matRad/optimization/matRad_collapseDij.html" class="code" title="function dijNew = matRad_collapseDij(dij)">matRad_collapseDij</a>	matRad collapse dij function for simulation of 3D conformal treatments.</li><li><a href="../matRad/plotting/matRad_computeAllVoiSurfaces.html" class="code" title="function cst = matRad_computeAllVoiSurfaces(ct,cst)">matRad_computeAllVoiSurfaces</a>	matRad function that computes all VOI surfaces</li><li><a href="../matRad/plotting/matRad_computeIsoDoseContours.html" class="code" title="function isoDoseContours = matRad_computeIsoDoseContours(doseCube,isoLevels)">matRad_computeIsoDoseContours</a>	matRad function that computes all isodse contours</li><li><a href="../matRad/plotting/matRad_computeVoiContoursWrapper.html" class="code" title="function cst = matRad_computeVoiContoursWrapper(cst,ct)">matRad_computeVoiContoursWrapper</a>	matRad computation of VOI contours if not precomputed</li><li><a href="../matRad/plotting/matRad_getColormap.html" class="code" title="function output = matRad_getColormap(name,size)">matRad_getColormap</a>	matRad function wrapper for getting a colormap</li><li><a href="../matRad/plotting/matRad_plotAxisLabels.html" class="code" title="function  matRad_plotAxisLabels(axesHandle,ct,plane,slice,defaultFontSize,tickdist)">matRad_plotAxisLabels</a>	matRad function to plot x and y labels denoting the ct dimensions</li><li><a href="../matRad/plotting/matRad_plotColorbar.html" class="code" title="function cBarHandle = matRad_plotColorbar(axesHandle,cMap,window,varargin)">matRad_plotColorbar</a>	matRad function wrapper for plotting the colorbar</li><li><a href="../matRad/plotting/matRad_plotCtSlice.html" class="code" title="function [ctHandle,cMap,window] = matRad_plotCtSlice(axesHandle,ctCube,cubeIdx,plane,slice,cMap,window)">matRad_plotCtSlice</a>	matRad function that generates the plot for the CT in the GUI</li><li><a href="../matRad/plotting/matRad_plotCtSlice3D.html" class="code" title="function [ctHandle,cMap,window] = matRad_plotCtSlice3D(axesHandle,ct,cubeIdx,plane,ctSlice,cMap,window)">matRad_plotCtSlice3D</a>	matRad function that generates the plot for the CT in the GUI 3D view</li><li><a href="../matRad/plotting/matRad_plotDoseSlice.html" class="code" title="function [doseHandle,cMap,window] = matRad_plotDoseSlice(axesHandle,doseCube,plane,slice,threshold,alpha,cMap,window)">matRad_plotDoseSlice</a>	matRad function that generates a dose plot of a selected slice</li><li><a href="../matRad/plotting/matRad_plotDoseSlice3D.html" class="code" title="function [doseHandle,cMap,window] = matRad_plotDoseSlice3D(axesHandle,ct,doseCube,plane,slice,threshold,alpha,cMap,window)">matRad_plotDoseSlice3D</a>	matRad function that generates a dose plot of a selected slice in 3D view</li><li><a href="../matRad/plotting/matRad_plotIsoCenterMarker.html" class="code" title="function markerHandle = matRad_plotIsoCenterMarker(axesHandle,pln,ct,plane,slice,style)">matRad_plotIsoCenterMarker</a>	matRad function that plots an isocenter marker</li><li><a href="../matRad/plotting/matRad_plotIsoDoseLines.html" class="code" title="function isoLineHandles = matRad_plotIsoDoseLines(axesHandle,doseCube,isoContours,isoLevels,plotLabels,plane,slice,cMap,window,varargin)">matRad_plotIsoDoseLines</a>	matRad function that plots isolines, by precomputed contourc data</li><li><a href="../matRad/plotting/matRad_plotIsoDoseLines3D.html" class="code" title="function isoLineHandles = matRad_plotIsoDoseLines3D(axesHandle,ct,doseCube,isoContours,isoLevels,plane,slice,cMap,window,varargin)">matRad_plotIsoDoseLines3D</a>	matRad function that plots isolines in 3D, by precomputed contourc data</li><li><a href="../matRad/plotting/matRad_plotPlan3D.html" class="code" title="function matRad_plotPlan3D(axesHandle,pln,stf)">matRad_plotPlan3D</a>	matRad function to visualize a plan in 3D</li><li><a href="../matRad/plotting/matRad_plotProjectedGantryAngles.html" class="code" title="function matRad_plotProjectedGantryAngles(axesHandle,pln,ct,plane)">matRad_plotProjectedGantryAngles</a>	matRad function that plots all gantry angles</li><li><a href="../matRad/plotting/matRad_plotVoiContourSlice.html" class="code" title="function [voiContourHandles] = matRad_plotVoiContourSlice(axesHandle,cst,ct,ctIndex,selection,plane,slice,cMap,varargin)">matRad_plotVoiContourSlice</a>	matRad function that plots the contours of the segmentations given in cst</li><li><a href="../matRad/plotting/matRad_plotVois3D.html" class="code" title="function patches = matRad_plotVois3D(axesHandle,ct,cst,selection,cMap)">matRad_plotVois3D</a>	matRad function that plots 3D structures of the volumes of interest</li><li><a href="../matRad/tools/matRad_getEnvironment.html" class="code" title="function [env, versionString] = matRad_getEnvironment()">matRad_getEnvironment</a>	matRad function to get the software environment matRad is running on</li></ul>
This function is called by:
<ul style="list-style-type:disc">
<li><a href="../matRad/examples/matRad_example2_photons.html" class="code" title="">matRad_example2_photons</a>	% Example: Photon Treatment Plan</li><li><a href="../matRad/examples/matRad_example3_photonsDAO.html" class="code" title="">matRad_example3_photonsDAO</a>	% Example: Photon Treatment Plan with Direct aperture optimization</li><li><a href="matRad.html" class="code" title="">matRad</a>	matRad script</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>Subfunctions <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-type:disc">
<li><a href="#_sub1" class="code">function handles = resetGUI(hObject, handles, varargin)</a></li><li><a href="#_sub2" class="code">function initViewSliceSlider(handles)</a></li><li><a href="#_sub3" class="code">function handles = reloadGUI(hObject, handles, ct, cst)</a></li><li><a href="#_sub4" class="code">function matRadGUI_OpeningFcn(hObject, ~, handles, varargin)</a></li><li><a href="#_sub5" class="code">function validateModeValue(x)</a></li><li><a href="#_sub6" class="code">function Callback_StructVisibilty(source,~)</a></li><li><a href="#_sub7" class="code">function varargout = matRadGUI_OutputFcn(~, ~, handles)</a></li><li><a href="#_sub8" class="code">function btnLoadMat_Callback(hObject, ~, handles)</a></li><li><a href="#_sub9" class="code">function btnLoadDicom_Callback(hObject, ~, handles)</a></li><li><a href="#_sub10" class="code">function btn_export_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub11" class="code">function editBixelWidth_Callback(hObject, ~, handles)</a></li><li><a href="#_sub12" class="code">function editGantryAngle_Callback(hObject, ~, handles)</a></li><li><a href="#_sub13" class="code">function editCouchAngle_Callback(hObject, ~, handles)</a></li><li><a href="#_sub14" class="code">function popupRadMode_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub15" class="code">function btnCalcDose_Callback(hObject, ~, handles)</a></li><li><a href="#_sub16" class="code">function UpdatePlot(handles)</a></li><li><a href="#_sub17" class="code">function Update3DView(handles)</a></li><li><a href="#_sub18" class="code">function popupPlane_Callback(hObject, ~, handles)</a></li><li><a href="#_sub19" class="code">function sliderSlice_Callback(~, ~, handles)</a></li><li><a href="#_sub20" class="code">function radiobtnContour_Callback(~, ~, handles)</a></li><li><a href="#_sub21" class="code">function radiobtnDose_Callback(~, ~, handles)</a></li><li><a href="#_sub22" class="code">function radiobtnIsoDoseLines_Callback(~, ~, handles)</a></li><li><a href="#_sub23" class="code">function btnOptimize_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub24" class="code">function FlagValid = CheckValidityPln(cst)</a></li><li><a href="#_sub25" class="code">function popupTypeOfPlot_Callback(hObject, ~, handles)</a></li><li><a href="#_sub26" class="code">function popupDisplayOption_Callback(hObject, ~, handles)</a></li><li><a href="#_sub27" class="code">function sliderBeamSelection_Callback(hObject, ~, handles)</a></li><li><a href="#_sub28" class="code">function btnProfileType_Callback(hObject, ~, handles)</a></li><li><a href="#_sub29" class="code">function UpdateState(handles)</a></li><li><a href="#_sub30" class="code">function setPln(handles)</a></li><li><a href="#_sub31" class="code">function btnTableSave_Callback(~, ~, handles)</a></li><li><a href="#_sub32" class="code">function listBoxCmd_Callback(hObject, ~, ~)</a></li><li><a href="#_sub33" class="code">function sliderOffset_Callback(hObject, ~, handles)</a></li><li><a href="#_sub34" class="code">function flagValidity = CheckValidity(Val)</a></li><li><a href="#_sub35" class="code">function CheckOptimizerStatus(usedOptimizer,OptCase)</a></li><li><a href="#_sub36" class="code">function getPlnFromGUI(handles)</a></li><li><a href="#_sub37" class="code">function number = parseStringAsNum(stringIn,isVector)</a></li><li><a href="#_sub38" class="code">function handles = showError(handles,Message,ME)</a></li><li><a href="#_sub39" class="code">function handles = showWarning(handles,Message,ME)</a></li><li><a href="#_sub40" class="code">function flag = checkRadiationComposition(handles)</a></li><li><a href="#_sub41" class="code">function matRadScrollWheelFcn(src,event)</a></li><li><a href="#_sub42" class="code">function btnDVH_Callback(~, ~, handles)</a></li><li><a href="#_sub43" class="code">function radiobtnIsoDoseLinesLabels_Callback(~, ~, handles)</a></li><li><a href="#_sub44" class="code">function btnRefresh_Callback(hObject, ~, handles)</a></li><li><a href="#_sub45" class="code">function editFraction_Callback(hObject, ~, handles)</a></li><li><a href="#_sub46" class="code">function editSequencingLevel_Callback(~, ~, ~)</a></li><li><a href="#_sub47" class="code">function editIsoCenter_Callback(hObject, ~, handles)</a></li><li><a href="#_sub48" class="code">function checkIsoCenter_Callback(hObject, ~, handles)</a></li><li><a href="#_sub49" class="code">function btnRunSequencing_Callback(~, ~, handles)</a></li><li><a href="#_sub50" class="code">function btnRunDAO_Callback(~, ~, handles)</a></li><li><a href="#_sub51" class="code">function btnSetIsoDoseLevels_Callback(hObject, ~, handles)</a></li><li><a href="#_sub52" class="code">function popUpMachine_Callback(hObject, ~, handles)</a></li><li><a href="#_sub53" class="code">function toolbarLoad_ClickedCallback(hObject, eventdata, handles)</a></li><li><a href="#_sub54" class="code">function toolbarSave_ClickedCallback(hObject, eventdata, handles)</a></li><li><a href="#_sub55" class="code">function btnAbout_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub56" class="code">function figure1_CloseRequestFcn(hObject, ~, ~)</a></li><li><a href="#_sub57" class="code">function pushbutton_recalc_Callback(hObject, ~, handles)</a></li><li><a href="#_sub58" class="code">function btnSetTissue_Callback(hObject, ~, handles)</a></li><li><a href="#_sub59" class="code">function SaveTissueParameters(~, ~, handles,tissueTable)</a></li><li><a href="#_sub60" class="code">function tissueTable_CellEditCallback(hObject, eventdata, ~)</a></li><li><a href="#_sub61" class="code">function btnSaveToGUI_Callback(hObject, ~, handles)</a></li><li><a href="#_sub62" class="code">function SaveResultToGUI(~, ~, ~)</a></li><li><a href="#_sub63" class="code">function cst = precomputeContours(ct,cst)</a></li><li><a href="#_sub64" class="code">function handles = updateIsoDoseLineCache(handles)</a></li><li><a href="#_sub65" class="code">function popUpMachine_CreateFcn(hObject, ~, ~)</a></li><li><a href="#_sub66" class="code">function txtMaxVal_CreateFcn(hObject, ~, ~)</a></li><li><a href="#_sub67" class="code">function editIsoCenter_CreateFcn(hObject, ~, ~)</a></li><li><a href="#_sub68" class="code">function editSequencingLevel_CreateFcn(hObject, ~, ~)</a></li><li><a href="#_sub69" class="code">function slicerPrecision_CreateFcn(hObject, ~, ~)</a></li><li><a href="#_sub70" class="code">function editBixelWidth_CreateFcn(hObject, ~, ~)</a></li><li><a href="#_sub71" class="code">function editGantryAngle_CreateFcn(hObject, ~, ~)</a></li><li><a href="#_sub72" class="code">function editCouchAngle_CreateFcn(hObject, ~, ~)</a></li><li><a href="#_sub73" class="code">function popupRadMode_CreateFcn(hObject, ~, ~)</a></li><li><a href="#_sub74" class="code">function editFraction_CreateFcn(hObject, ~, ~)</a></li><li><a href="#_sub75" class="code">function popupPlane_CreateFcn(hObject, ~, ~)</a></li><li><a href="#_sub76" class="code">function sliderSlice_CreateFcn(hObject, ~, ~)</a></li><li><a href="#_sub77" class="code">function popupTypeOfPlot_CreateFcn(hObject, ~, ~)</a></li><li><a href="#_sub78" class="code">function popupDisplayOption_CreateFcn(hObject, ~, ~)</a></li><li><a href="#_sub79" class="code">function sliderBeamSelection_CreateFcn(hObject, ~, ~)</a></li><li><a href="#_sub80" class="code">function listBoxCmd_CreateFcn(hObject, ~, ~)</a></li><li><a href="#_sub81" class="code">function sliderOffset_CreateFcn(hObject, ~, ~)</a></li><li><a href="#_sub82" class="code">function legendTable_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub83" class="code">function legendTable_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub84" class="code">function importDoseButton_Callback(hObject,eventdata, handles)</a></li><li><a href="#_sub85" class="code">function pushbutton_importFromBinary_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub86" class="code">function radioBtnIsoCenter_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub87" class="code">function uipushtool_screenshot_ClickedCallback(hObject, eventdata, handles)</a></li><li><a href="#_sub88" class="code">function UpdateColormapOptions(handles)</a></li><li><a href="#_sub89" class="code">function popupmenu_chooseColorData_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub90" class="code">function popupmenu_chooseColorData_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub91" class="code">function slider_windowCenter_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub92" class="code">function slider_windowCenter_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub93" class="code">function slider_windowWidth_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub94" class="code">function slider_windowWidth_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub95" class="code">function popupmenu_chooseColormap_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub96" class="code">function popupmenu_chooseColormap_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub97" class="code">function edit_windowRange_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub98" class="code">function edit_windowRange_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub99" class="code">function edit_windowCenter_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub100" class="code">function edit_windowCenter_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub101" class="code">function edit_windowWidth_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub102" class="code">function edit_windowWidth_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub103" class="code">function uitoggletool8_ClickedCallback(hObject, eventdata, handles)</a></li><li><a href="#_sub104" class="code">function sliderOpacity_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub105" class="code">function sliderOpacity_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub106" class="code">function cursorText = dataCursorUpdateFunction(obj,event_obj)</a></li><li><a href="#_sub107" class="code">function popMenuBioOpt_Callback(hObject, ~, handles)</a></li><li><a href="#_sub108" class="code">function popMenuBioOpt_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub109" class="code">function btn3Dview_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub110" class="code">function radiobtnCT_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub111" class="code">function radiobtnPlan_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub112" class="code">function popupmenu_windowPreset_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub113" class="code">function popupmenu_windowPreset_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub114" class="code">function checkbox_lockColormap_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub115" class="code">function cst = updateStructureTable(handles,cst)</a></li><li><a href="#_sub116" class="code">function cst = generateCstTable(handles,cst)</a></li><li><a href="#_sub117" class="code">functionW = 6*buttonW;</a></li><li><a href="#_sub118" class="code">function uipanel3_SizeChangedFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub119" class="code">function btObjAdd_Callback(hObject, ~, handles)</a></li><li><a href="#_sub120" class="code">function btObjRemove_Callback(hObject, ~, handles)</a></li><li><a href="#_sub121" class="code">function editObjParam_Callback(hObject, ~, handles)</a></li><li><a href="#_sub122" class="code">function changeObjFunction_Callback(hObject, ~, handles)</a></li><li><a href="#_sub123" class="code">function editCstParams_Callback(hObject,~,handles)</a></li><li><a href="#_sub124" class="code">function radiobutton3Dconf_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub125" class="code">function x = matRad_checkForConnectedBixelRows(stf)</a></li><li><a href="#_sub126" class="code">function cstTableSlider_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub127" class="code">function cstTableSlider_CreateFcn(hObject, eventdata, handles)</a></li></ul>

<h2><a name="_source"></a>Source code <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function varargout = matRadGUI(varargin)</a>
0002 <span class="comment">% matRad GUI</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% call</span>
0005 <span class="comment">%      MATRADGUI, by itself, creates a new MATRADGUI or raises the existing</span>
0006 <span class="comment">%      singleton*.</span>
0007 <span class="comment">%</span>
0008 <span class="comment">%      H = MATRADGUI returns the handle to a new MATRADGUI or the handle to</span>
0009 <span class="comment">%      the existing singleton*.</span>
0010 <span class="comment">%</span>
0011 <span class="comment">%      MATRADGUI('CALLBACK',hObject,eventData,handles,...) calls the local</span>
0012 <span class="comment">%      function named CALLBACK in MATRADGUI.M with the given input arguments.</span>
0013 <span class="comment">%</span>
0014 <span class="comment">%      MATRADGUI('Property','Value',...) creates a new MATRADGUI or raises the</span>
0015 <span class="comment">%      existing singleton*.  Starting from the left, property value pairs are</span>
0016 <span class="comment">%      applied to the GUI before matRadGUI_OpeningFcn gets called.  An</span>
0017 <span class="comment">%      unrecognized property name or invalid value makes property application</span>
0018 <span class="comment">%      stop.  All inputs are passed to matRadGUI_OpeningFcn via varargin.</span>
0019 <span class="comment">%</span>
0020 <span class="comment">%      *See GUI Options on GUIDE's Tools menu.  Choose &quot;GUI allows only one</span>
0021 <span class="comment">%      instance to run (singleton)&quot;.</span>
0022 <span class="comment">%</span>
0023 <span class="comment">% See also: GUIDE, GUIDATA, GUIHANDLES</span>
0024 <span class="comment">%</span>
0025 <span class="comment">% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0026 <span class="comment">%</span>
0027 <span class="comment">% Copyright 2015 the matRad development team.</span>
0028 <span class="comment">%</span>
0029 <span class="comment">% This file is part of the matRad project. It is subject to the license</span>
0030 <span class="comment">% terms in the LICENSE file found in the top-level directory of this</span>
0031 <span class="comment">% distribution and at https://github.com/e0404/matRad/LICENSES.txt. No part</span>
0032 <span class="comment">% of the matRad project, including this file, may be copied, modified,</span>
0033 <span class="comment">% propagated, or distributed except according to the terms contained in the</span>
0034 <span class="comment">% LICENSE file.</span>
0035 <span class="comment">%</span>
0036 <span class="comment">% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0037 
0038 matRad_cfg = MatRad_Config.instance();
0039 
0040 <span class="keyword">if</span> matRad_cfg.disableGUI
0041     matRad_cfg.dispInfo(<span class="string">'matRad GUI disabled in matRad_cfg!\n'</span>);
0042     <span class="keyword">return</span>;
0043 <span class="keyword">end</span>
0044 
0045 <span class="keyword">if</span> ~isdeployed
0046     matRadRootDir = fileparts(mfilename(<span class="string">'fullpath'</span>));
0047     addpath(genpath(matRadRootDir));
0048 <span class="keyword">end</span>
0049 
0050 [env, versionString] = <a href="../matRad/tools/matRad_getEnvironment.html" class="code" title="function [env, versionString] = matRad_getEnvironment()">matRad_getEnvironment</a>();
0051 
0052 <span class="comment">% abort for octave</span>
0053 <span class="keyword">switch</span> env
0054      <span class="keyword">case</span> <span class="string">'MATLAB'</span>
0055          
0056      <span class="keyword">case</span> <span class="string">'OCTAVE'</span>
0057          matRad_cfg.dispInfo([<span class="string">'matRad GUI not available for '</span> env <span class="string">' '</span> versionString <span class="string">' \n'</span>]);
0058          <span class="keyword">return</span>;
0059      <span class="keyword">otherwise</span>
0060          matRad_cfg.dispInfo(<span class="string">'not yet tested'</span>);
0061  <span class="keyword">end</span>
0062         
0063 <span class="comment">% Begin initialization code - DO NOT EDIT</span>
0064 <span class="comment">% set platform specific look and feel</span>
0065 <span class="keyword">if</span> ispc
0066     lf = <span class="string">'com.sun.java.swing.plaf.windows.WindowsLookAndFeel'</span>;
0067 <span class="keyword">elseif</span> isunix
0068     lf = <span class="string">'com.jgoodies.looks.plastic.Plastic3DLookAndFeel'</span>;
0069 <span class="keyword">elseif</span> ismac
0070     lf = <span class="string">'com.apple.laf.AquaLookAndFeel'</span>;
0071 <span class="keyword">end</span>
0072 javax.swing.UIManager.setLookAndFeel(lf);
0073 
0074 gui_Singleton = 1;
0075 gui_State = struct(<span class="string">'gui_Name'</span>,       mfilename, <span class="keyword">...</span>
0076                    <span class="string">'gui_Singleton'</span>,  gui_Singleton, <span class="keyword">...</span>
0077                    <span class="string">'gui_OpeningFcn'</span>, @<a href="#_sub4" class="code" title="subfunction matRadGUI_OpeningFcn(hObject, ~, handles, varargin)">matRadGUI_OpeningFcn</a>, <span class="keyword">...</span>
0078                    <span class="string">'gui_OutputFcn'</span>,  @<a href="#_sub7" class="code" title="subfunction varargout = matRadGUI_OutputFcn(~, ~, handles)">matRadGUI_OutputFcn</a>, <span class="keyword">...</span>
0079                    <span class="string">'gui_LayoutFcn'</span>,  [] , <span class="keyword">...</span>
0080                    <span class="string">'gui_Callback'</span>,   []);
0081 <span class="keyword">if</span> nargin &amp;&amp; ischar(varargin{1})
0082     gui_State.gui_Callback = str2func(varargin{1});
0083 <span class="keyword">end</span>
0084 
0085 <span class="keyword">if</span> nargout
0086     [varargout{1:nargout}] = gui_mainfcn(gui_State, varargin{:});
0087 <span class="keyword">else</span>
0088     gui_mainfcn(gui_State, varargin{:});
0089 <span class="keyword">end</span>
0090 
0091 <span class="comment">% End initialization code - DO NOT EDIT</span>
0092 
0093 <a name="_sub1" href="#_subfunctions" class="code">function handles = resetGUI(hObject, handles, varargin)</a>
0094 <span class="comment">% enable opengl software rendering to visualize linewidths properly</span>
0095 <span class="keyword">if</span> ispc
0096   opengl software
0097 <span class="keyword">elseif</span> ismac
0098   <span class="comment">% opengl is not supported</span>
0099 <span class="keyword">end</span>
0100 
0101 <span class="comment">% Choose default command line output for matRadGUI</span>
0102 handles.output = hObject;
0103 <span class="comment">%show matrad logo</span>
0104 axes(handles.axesLogo)
0105 [im, ~, alpha] = imread(<span class="string">'matrad_logo.png'</span>);
0106 f = image(im);
0107 axis equal off
0108 set(f, <span class="string">'AlphaData'</span>, alpha);
0109 <span class="comment">% show dkfz logo</span>
0110 axes(handles.axesDKFZ)
0111 [im, ~, alpha] = imread(<span class="string">'DKFZ_Logo.png'</span>);
0112 f = image(im);
0113 axis equal off;
0114 set(f, <span class="string">'AlphaData'</span>, alpha);
0115 
0116 <span class="comment">% turn off the datacursormode (since it does not allow to set scrolling</span>
0117 <span class="comment">% callbacks</span>
0118 handles.dcm_obj = datacursormode(handles.figure1);
0119 set(handles.dcm_obj,<span class="string">'DisplayStyle'</span>,<span class="string">'window'</span>);
0120 <span class="keyword">if</span> strcmpi(get(handles.dcm_obj,<span class="string">'Enable'</span>),<span class="string">'on'</span>)
0121   set(handles.dcm_obj,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
0122 <span class="keyword">end</span>
0123 <span class="comment">%Add the callback for the datacursor display</span>
0124 set(handles.dcm_obj,<span class="string">'UpdateFcn'</span>,@<a href="#_sub106" class="code" title="subfunction cursorText = dataCursorUpdateFunction(obj,event_obj)">dataCursorUpdateFunction</a>);
0125 
0126 <span class="comment">% set callback for scroll wheel function</span>
0127 set(gcf,<span class="string">'WindowScrollWheelFcn'</span>,@<a href="#_sub41" class="code" title="subfunction matRadScrollWheelFcn(src,event)">matRadScrollWheelFcn</a>);
0128 
0129 <span class="comment">% change color of toobar but only the first time GUI is started</span>
0130 <span class="keyword">if</span> handles.initialGuiStart
0131   hToolbar = findall(hObject,<span class="string">'tag'</span>,<span class="string">'uitoolbar1'</span>);
0132   jToolbar = get(get(hToolbar,<span class="string">'JavaContainer'</span>),<span class="string">'ComponentPeer'</span>);
0133   jToolbar.setBorderPainted(false);
0134   color = java.awt.Color.gray;
0135   <span class="comment">% Remove the toolbar border, to blend into figure contents</span>
0136   jToolbar.setBackground(color);
0137   <span class="comment">% Remove the separator line between toolbar and contents</span>
0138   warning(<span class="string">'off'</span>,<span class="string">'MATLAB:HandleGraphics:ObsoletedProperty:JavaFrame'</span>);
0139   jFrame = get(handle(hObject),<span class="string">'JavaFrame'</span>);
0140   jFrame.showTopSeparator(false);
0141   jtbc = jToolbar.getComponents;
0142   <span class="keyword">for</span> idx=1:length(jtbc)
0143       jtbc(idx).setOpaque(false);
0144       jtbc(idx).setBackground(color);
0145       <span class="keyword">for</span> childIdx = 1 : length(jtbc(idx).getComponents)
0146           jtbc(idx).getComponent(childIdx-1).setBackground(color);
0147       <span class="keyword">end</span>
0148   <span class="keyword">end</span>
0149 <span class="keyword">end</span>
0150 
0151 
0152 set(handles.legendTable,<span class="string">'String'</span>,{<span class="string">'no data loaded'</span>});
0153 <span class="comment">% clear  VOIPlotFlag</span>
0154 <span class="keyword">if</span> isfield(handles,<span class="string">'VOIPlotFlag'</span>)
0155   handles = rmfield(handles,<span class="string">'VOIPlotFlag'</span>);
0156 <span class="keyword">end</span>
0157 
0158 <span class="comment">%seach for availabes machines</span>
0159 handles.Modalities = {<span class="string">'photons'</span>,<span class="string">'protons'</span>,<span class="string">'carbon'</span>};
0160 <span class="keyword">for</span> i = 1:length(handles.Modalities)
0161   pattern = [handles.Modalities{1,i} <span class="string">'_*'</span>];
0162   <span class="keyword">if</span> isdeployed
0163       baseroot = [ctfroot filesep <span class="string">'matRad'</span>];
0164   <span class="keyword">else</span>
0165       baseroot = fileparts(mfilename(<span class="string">'fullpath'</span>));
0166   <span class="keyword">end</span>
0167   Files = dir([baseroot filesep <span class="string">'basedata'</span> filesep pattern]);
0168   
0169   <span class="keyword">for</span> j = 1:length(Files)
0170       <span class="keyword">if</span> ~isempty(Files)
0171           MachineName = Files(j).name(numel(handles.Modalities{1,i})+2:end-4);
0172           <span class="keyword">if</span> isfield(handles,<span class="string">'Machines'</span>)
0173               <span class="keyword">if</span> sum(strcmp(handles.Machines,MachineName)) == 0
0174                 handles.Machines{size(handles.Machines,2)+1} = MachineName;
0175               <span class="keyword">end</span>
0176           <span class="keyword">else</span>
0177               handles.Machines = cell(1);
0178               handles.Machines{1} = MachineName;
0179           <span class="keyword">end</span>
0180       <span class="keyword">end</span>
0181   <span class="keyword">end</span>
0182 <span class="keyword">end</span>
0183 set(handles.popUpMachine,<span class="string">'String'</span>,handles.Machines);
0184 
0185 
0186 vChar = get(handles.editGantryAngle,<span class="string">'String'</span>);
0187 <span class="keyword">if</span> strcmp(vChar(1,1),<span class="string">'0'</span>) &amp;&amp; length(vChar)==6
0188   set(handles.editGantryAngle,<span class="string">'String'</span>,<span class="string">'0'</span>);
0189 <span class="keyword">end</span>
0190 vChar = get(handles.editCouchAngle,<span class="string">'String'</span>);
0191 <span class="keyword">if</span> strcmp(vChar(1,1),<span class="string">'0'</span>) &amp;&amp; length(vChar)==3
0192   set(handles.editCouchAngle,<span class="string">'String'</span>,<span class="string">'0'</span>)
0193 <span class="keyword">end</span>
0194 <span class="comment">%%</span>
0195 <span class="comment">% handles.State=0   no data available</span>
0196 <span class="comment">% handles.State=1   ct cst and pln available; ready for dose calculation</span>
0197 <span class="comment">% handles.State=2   ct cst and pln available and dij matric(s) are calculated;</span>
0198 <span class="comment">%                   ready for optimization</span>
0199 <span class="comment">% handles.State=3   plan is optimized</span>
0200 
0201 
0202 <span class="comment">% if plan is changed go back to state 1</span>
0203 <span class="comment">% if table VOI Type or Priorities changed go to state 1</span>
0204 <span class="comment">% if objective parameters changed go back to state 2</span>
0205 handles.CutOffLevel            = 0.01; <span class="comment">% relative cut off level for dose vis</span>
0206 handles.IsoDose.NewIsoDoseFlag = false;
0207 handles.TableChanged           = false;
0208 handles.State                  = 0;
0209 handles.doseOpacity            = 0.6;
0210 handles.IsoDose.Levels         = 0;
0211 handles.dispWindow             = cell(3,2); <span class="comment">% first dimension refers to the selected</span>
0212 
0213 <span class="comment">% do not calculate / suggest isoCenter new by default</span>
0214 set(handles.checkIsoCenter, <span class="string">'Value'</span>, 0);
0215 set(handles.editIsoCenter,<span class="string">'Enable'</span>,<span class="string">'on'</span>)
0216 
0217 <span class="comment">% suppose no ct cube in HU is available (because no ct could be available)</span>
0218 handles.cubeHUavailable = false;
0219 <span class="comment">% initial startup finished</span>
0220 handles.initialGuiStart = false;
0221 guidata(hObject, handles);  
0222 <span class="comment">% eof resetGUI</span>
0223 
0224 
0225 <span class="comment">% --- Initializes the slice slider for the current ct &amp; isocenter (or sets</span>
0226 <span class="comment">% it to default)</span>
0227 <a name="_sub2" href="#_subfunctions" class="code">function initViewSliceSlider(handles)</a>
0228 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0229 
0230 <span class="keyword">if</span> handles.State &gt; 0
0231     ct = evalin(<span class="string">'base'</span>, <span class="string">'ct'</span>);
0232     
0233     <span class="comment">%Helpers for managing the resolution and Matlab xy permutation</span>
0234     planePermute = [2 1 3];
0235     ctRes = [ct.resolution.x ct.resolution.y ct.resolution.z];
0236     planePermIx = planePermute(handles.plane);
0237     planeDim = ct.cubeDim(handles.plane);   
0238 
0239     <span class="comment">%Try to select the slice from defined isocenter</span>
0240     <span class="keyword">try</span>
0241         <span class="keyword">if</span> evalin(<span class="string">'base'</span>,<span class="string">'exist(''pln'',''var'')'</span>)
0242             currPln = evalin(<span class="string">'base'</span>,<span class="string">'pln'</span>);
0243             
0244             <span class="keyword">if</span> sum(currPln.propStf.isoCenter(:)) ~= 0
0245                 <span class="comment">%currSlice = round((currPln.propStf.isoCenter(1,planePermIx)+ctRes(planePermix)/2)/ctRes(planePermIx))-1;</span>
0246                 currSlice = round(currPln.propStf.isoCenter(1,planePermIx) / ctRes(planePermIx));
0247             <span class="keyword">end</span>
0248         <span class="keyword">end</span>
0249     <span class="keyword">catch</span>
0250         currSlice = 0; <span class="comment">%Set to zero for next if</span>
0251     <span class="keyword">end</span>
0252 
0253     <span class="comment">%If no isocenter or wrong value, choose central slice</span>
0254     <span class="keyword">if</span> currSlice &lt; 1 || currSlice &gt; planeDim
0255         currSlice = ceil(planeDim/2);
0256     <span class="keyword">end</span>
0257 
0258     set(handles.sliderSlice,<span class="string">'Min'</span>,1,<span class="string">'Max'</span>,planeDim,<span class="keyword">...</span>
0259         <span class="string">'Value'</span>,currSlice,<span class="keyword">...</span>
0260         <span class="string">'SliderStep'</span>,[1/(planeDim-1) 1/(planeDim-1)]);
0261 <span class="keyword">else</span>
0262     <span class="comment">% reset slider when nothing is loaded</span>
0263     set(handles.sliderSlice,<span class="string">'Min'</span>,0,<span class="string">'Max'</span>,1,<span class="string">'Value'</span>,0,<span class="string">'SliderStep'</span>,[1 1]);
0264 <span class="keyword">end</span>
0265 
0266 
0267 
0268 <a name="_sub3" href="#_subfunctions" class="code">function handles = reloadGUI(hObject, handles, ct, cst)</a>
0269 AllVarNames = handles.AllVarNames;
0270 
0271 <span class="keyword">if</span> nargin &gt;=3 &amp;&amp; ismember(<span class="string">'ct'</span>,AllVarNames)
0272     <span class="comment">% compute HU values</span>
0273     <span class="keyword">if</span> ~isfield(ct, <span class="string">'cubeHU'</span>)
0274         ct = <a href="matRad_electronDensitiesToHU.html" class="code" title="function ct = matRad_electronDensitiesToHU(ct)">matRad_electronDensitiesToHU</a>(ct);
0275         assignin(<span class="string">'base'</span>,<span class="string">'ct'</span>,ct);
0276     <span class="keyword">end</span>
0277     <span class="keyword">if</span> ~isfield(ct, <span class="string">'cubeHU'</span>)
0278         handles.cubeHUavailable = false;
0279     <span class="keyword">else</span>
0280         handles.cubeHUavailable = true;
0281     <span class="keyword">end</span>
0282 <span class="keyword">end</span>
0283 
0284 <span class="comment">%set plan if available - if not create one</span>
0285 <span class="keyword">try</span>   
0286     <span class="keyword">if</span> ismember(<span class="string">'pln'</span>,AllVarNames) &amp;&amp; handles.State &gt; 0
0287         <span class="comment">% check if you are working with a valid pln</span>
0288         pln = evalin(<span class="string">'base'</span>,<span class="string">'pln'</span>);
0289         <span class="keyword">if</span> ~isfield(pln,<span class="string">'propStf'</span>)
0290             handles = <a href="#_sub39" class="code" title="subfunction handles = showWarning(handles,Message,ME)">showWarning</a>(handles,<span class="string">'GUI OpeningFunc: Overwriting outdated pln format with default GUI pln'</span>);
0291             evalin(<span class="string">'base'</span>,<span class="string">'clear pln'</span>);
0292             <a href="#_sub36" class="code" title="subfunction getPlnFromGUI(handles)">getPlnFromGUI</a>(handles);
0293         <span class="keyword">end</span>
0294         <a href="#_sub30" class="code" title="subfunction setPln(handles)">setPln</a>(handles);
0295     <span class="keyword">elseif</span> handles.State &gt; 0 
0296          <a href="#_sub36" class="code" title="subfunction getPlnFromGUI(handles)">getPlnFromGUI</a>(handles);
0297          <a href="#_sub30" class="code" title="subfunction setPln(handles)">setPln</a>(handles);
0298     <span class="keyword">end</span>
0299         
0300 <span class="keyword">catch</span>
0301        handles.State = 0;
0302        handles = <a href="#_sub38" class="code" title="subfunction handles = showError(handles,Message,ME)">showError</a>(handles,<span class="string">'GUI OpeningFunc: Could not set or get pln'</span>);
0303 <span class="keyword">end</span>
0304 
0305 <span class="comment">% check for dij structure</span>
0306 <span class="keyword">if</span> ismember(<span class="string">'dij'</span>,AllVarNames)
0307     handles.State = 2;
0308 <span class="keyword">end</span>
0309 
0310 <span class="comment">% check for optimized results</span>
0311 <span class="keyword">if</span> ismember(<span class="string">'resultGUI'</span>,AllVarNames)
0312     handles.State = 3;
0313 <span class="keyword">end</span>
0314 
0315 <span class="comment">% set some default values</span>
0316 <span class="keyword">if</span> handles.State == 2 || handles.State == 3
0317     set(handles.popupDisplayOption,<span class="string">'String'</span>,<span class="string">'physicalDose'</span>);
0318     handles.SelectedDisplayOption =<span class="string">'physicalDose'</span>;
0319     handles.SelectedDisplayOptionIdx=1;
0320 <span class="keyword">else</span>
0321     handles.resultGUI = [];
0322     set(handles.popupDisplayOption,<span class="string">'String'</span>,<span class="string">'no option available'</span>);
0323     handles.SelectedDisplayOption=<span class="string">''</span>;
0324     handles.SelectedDisplayOptionIdx=1;
0325 <span class="keyword">end</span>
0326 
0327 <span class="comment">% precompute iso dose lines</span>
0328 <span class="keyword">if</span> handles.State == 3
0329     handles = <a href="#_sub64" class="code" title="subfunction handles = updateIsoDoseLineCache(handles)">updateIsoDoseLineCache</a>(handles);
0330 <span class="keyword">end</span>
0331 
0332 <span class="comment">%per default the first beam is selected for the profile plot</span>
0333 handles.selectedBeam = 1;
0334 handles.plane = get(handles.popupPlane,<span class="string">'Value'</span>);
0335 handles.DijCalcWarning = false;
0336 
0337 <span class="comment">% set slice slider</span>
0338 <a href="#_sub2" class="code" title="subfunction initViewSliceSlider(handles)">initViewSliceSlider</a>(handles);
0339 
0340 <span class="comment">% define context menu for structures</span>
0341 <span class="keyword">if</span> handles.State &gt; 0
0342     <span class="keyword">for</span> i = 1:size(cst,1)
0343         <span class="keyword">if</span> cst{i,5}.Visible
0344             handles.VOIPlotFlag(i) = true;
0345         <span class="keyword">else</span>
0346             handles.VOIPlotFlag(i) = false;
0347         <span class="keyword">end</span>
0348     <span class="keyword">end</span>
0349 <span class="keyword">end</span>
0350 
0351 <span class="comment">%Initialize colormaps and windows</span>
0352 handles.doseColorMap = <span class="string">'jet'</span>;
0353 handles.ctColorMap   = <span class="string">'bone'</span>;
0354 handles.cMapSize     = 64;
0355 handles.cBarChanged  = true;
0356 
0357 <span class="comment">%Set up the colormap selection box</span>
0358 availableColormaps = <a href="../matRad/plotting/matRad_getColormap.html" class="code" title="function output = matRad_getColormap(name,size)">matRad_getColormap</a>();
0359 set(handles.popupmenu_chooseColormap,<span class="string">'String'</span>,availableColormaps);
0360 
0361 currentCtMapIndex   = find(strcmp(availableColormaps,handles.ctColorMap));
0362 currentDoseMapIndex = find(strcmp(availableColormaps,handles.doseColorMap));
0363 
0364 <span class="keyword">if</span> handles.State &gt;= 1    
0365    set(handles.popupmenu_chooseColormap,<span class="string">'Value'</span>,currentCtMapIndex);
0366 <span class="keyword">end</span>
0367 
0368 <span class="keyword">if</span> handles.State &gt;= 3
0369     set(handles.popupmenu_chooseColormap,<span class="string">'Value'</span>,currentDoseMapIndex);
0370 <span class="keyword">end</span>
0371 
0372 <span class="comment">% Update handles structure</span>
0373 handles.profileOffset = 0;
0374 <a href="#_sub29" class="code" title="subfunction UpdateState(handles)">UpdateState</a>(handles)
0375 
0376 axes(handles.axesFig)
0377 
0378 handles.rememberCurrAxes = false;
0379 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles)
0380 handles.rememberCurrAxes = true;
0381 guidata(hObject, handles);  
0382 <span class="comment">% eof reloadGUI</span>
0383 
0384 <span class="comment">% --- Executes just before matRadGUI is made visible.</span>
0385 <a name="_sub4" href="#_subfunctions" class="code">function matRadGUI_OpeningFcn(hObject, ~, handles, varargin) </a>
0386 <span class="comment">%#ok&lt;*DEFNU&gt;</span>
0387 <span class="comment">%#ok&lt;*AGROW&gt;</span>
0388 <span class="comment">% This function has no output args, see OutputFcn.</span>
0389 <span class="comment">% hObject    handle to figure</span>
0390 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0391 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0392 <span class="comment">% varargin   command line arguments to matRadGUI (see VARARGIN)</span>
0393 
0394 <span class="comment">% variable to check whether GUI is opened or just refreshed / new data</span>
0395 <span class="comment">% loaded, since resetGUI needs to distinguish at one point</span>
0396 
0397 handles.initialGuiStart = true;
0398 
0399 p = inputParser;
0400 addParameter(p,<span class="string">'devMode'</span>,false,@<a href="#_sub5" class="code" title="subfunction validateModeValue(x)">validateModeValue</a>);
0401 addParameter(p,<span class="string">'eduMode'</span>,false,@<a href="#_sub5" class="code" title="subfunction validateModeValue(x)">validateModeValue</a>);
0402 p.KeepUnmatched = true; <span class="comment">%No error with incorrect parameters</span>
0403 
0404 parse(p,varargin{:});
0405 parsedInput = p.Results;
0406 
0407 <span class="keyword">if</span> ischar(parsedInput.devMode) || isstring(parsedInput.devMode)
0408     parsedInput.devMode = str2double(parsedInput.devMode);
0409 <span class="keyword">end</span>
0410 
0411 <span class="keyword">if</span> ischar(parsedInput.eduMode) || isstring(parsedInput.eduMode)
0412     parsedInput.eduMode = str2double(parsedInput.eduMode);
0413 <span class="keyword">end</span>
0414 
0415 <span class="comment">%If devMode is true, error dialogs will include the full stack trace of the error</span>
0416 <span class="comment">%If false, only the basic error message is shown (works for errors that</span>
0417 <span class="comment">%handle the MException object)</span>
0418 handles.devMode = logical(parsedInput.devMode);
0419 <span class="keyword">if</span> handles.devMode
0420     disp(<span class="string">'matRadGUI starting in developer mode!'</span>);
0421 <span class="keyword">end</span>
0422 
0423 <span class="comment">%Enables simple educational mode which removes certain functionality from</span>
0424 <span class="comment">%the GUI</span>
0425 handles.eduMode = logical(parsedInput.eduMode);
0426 <span class="keyword">if</span> handles.eduMode
0427     disp(<span class="string">'matRadGUI starting in educational mode!'</span>);
0428 <span class="keyword">end</span>
0429 
0430 
0431 set(handles.radiobtnPlan,<span class="string">'value'</span>,0);
0432 
0433 
0434 
0435 <span class="keyword">if</span> handles.eduMode
0436     <span class="comment">%Visisbility in Educational Mode</span>
0437     eduHideHandles =   {handles.radiobutton3Dconf,<span class="keyword">...</span>
0438         handles.btnRunDAO,<span class="keyword">...</span>
0439         handles.pushbutton_importFromBinary,<span class="keyword">...</span>
0440         handles.btnLoadDicom,<span class="keyword">...</span>
0441         handles.btn_export,<span class="keyword">...</span>
0442         handles.importDoseButton};
0443     eduDisableHandles = {handles.editCouchAngle,handles.popUpMachine};
0444     cellfun(@(h) set(h,<span class="string">'Visible'</span>,<span class="string">'Off'</span>),eduHideHandles);
0445     cellfun(@(h) set(h,<span class="string">'Enable'</span>,<span class="string">'Off'</span>),eduDisableHandles);   
0446 <span class="keyword">end</span>
0447 
0448 
0449 <span class="comment">%Alter matRad Version string positioning</span>
0450 vString = <a href="matRad_version.html" class="code" title="function [versionString,matRadVer] = matRad_version()">matRad_version</a>();
0451 vPos = get(handles.text15,<span class="string">'Position'</span>);
0452 urlPos = get(handles.text31,<span class="string">'Position'</span>);
0453 btnPos = get(handles.btnAbout,<span class="string">'Position'</span>);
0454 
0455 <span class="comment">%vPos([1 3]) = urlPos([1 3]);</span>
0456 vPos([1 3]) = [0 1];
0457 vPos(4) = vPos(4)*1.25;
0458 btnPos(2) = 0.05;
0459 urlPos(2) = btnPos(2)+btnPos(4)+0.05;
0460 vPos(2) = urlPos(2) + urlPos(4) + 0.05;
0461 vPos(4) = 0.98 - vPos(2);
0462 
0463 set(handles.btnAbout,<span class="string">'Position'</span>,btnPos);
0464 set(handles.text31,<span class="string">'String'</span>,<span class="string">'www.matRad.org'</span>,<span class="string">'Position'</span>,urlPos,<span class="string">'Enable'</span>,<span class="string">'inactive'</span>,<span class="string">'ButtonDownFcn'</span>, @(~,~) web(<span class="string">'www.matrad.org'</span>,<span class="string">'-browser'</span>));
0465 set(handles.text15,<span class="string">'String'</span>,vString,<span class="string">'Position'</span>,vPos);
0466 
0467 handles = <a href="#_sub1" class="code" title="subfunction handles = resetGUI(hObject, handles, varargin)">resetGUI</a>(hObject, handles);
0468 
0469 <span class="comment">%% parse variables from base workspace</span>
0470 AllVarNames = evalin(<span class="string">'base'</span>,<span class="string">'who'</span>);
0471 handles.AllVarNames = AllVarNames;
0472 <span class="keyword">try</span>
0473     <span class="keyword">if</span>  ismember(<span class="string">'ct'</span>,AllVarNames) &amp;&amp;  ismember(<span class="string">'cst'</span>,AllVarNames)
0474         ct  = evalin(<span class="string">'base'</span>,<span class="string">'ct'</span>);
0475         cst = evalin(<span class="string">'base'</span>,<span class="string">'cst'</span>);
0476         <span class="comment">%cst = setCstTable(handles,cst);</span>
0477         cst = <a href="#_sub116" class="code" title="subfunction cst = generateCstTable(handles,cst)">generateCstTable</a>(handles,cst);
0478         handles.State = 1;
0479         cst = <a href="../matRad/plotting/matRad_computeVoiContoursWrapper.html" class="code" title="function cst = matRad_computeVoiContoursWrapper(cst,ct)">matRad_computeVoiContoursWrapper</a>(cst,ct);
0480         assignin(<span class="string">'base'</span>,<span class="string">'cst'</span>,cst);
0481 
0482     <span class="keyword">elseif</span> ismember(<span class="string">'ct'</span>,AllVarNames) &amp;&amp;  ~ismember(<span class="string">'cst'</span>,AllVarNames)
0483          handles = <a href="#_sub38" class="code" title="subfunction handles = showError(handles,Message,ME)">showError</a>(handles,<span class="string">'GUI OpeningFunc: could not find cst file'</span>);
0484     <span class="keyword">elseif</span> ~ismember(<span class="string">'ct'</span>,AllVarNames) &amp;&amp;  ismember(<span class="string">'cst'</span>,AllVarNames)
0485          handles = <a href="#_sub38" class="code" title="subfunction handles = showError(handles,Message,ME)">showError</a>(handles,<span class="string">'GUI OpeningFunc: could not find ct file'</span>);
0486     <span class="keyword">end</span>
0487 <span class="keyword">catch</span>
0488    handles = <a href="#_sub38" class="code" title="subfunction handles = showError(handles,Message,ME)">showError</a>(handles,<span class="string">'GUI OpeningFunc: Could not load ct and cst file'</span>);
0489 <span class="keyword">end</span>
0490 
0491 <span class="keyword">if</span> ismember(<span class="string">'ct'</span>,AllVarNames) &amp;&amp;  ismember(<span class="string">'cst'</span>,AllVarNames)
0492     handles = <a href="#_sub3" class="code" title="subfunction handles = reloadGUI(hObject, handles, ct, cst)">reloadGUI</a>(hObject, handles, ct, cst);
0493 <span class="keyword">else</span>
0494     handles = <a href="#_sub3" class="code" title="subfunction handles = reloadGUI(hObject, handles, ct, cst)">reloadGUI</a>(hObject, handles);
0495 <span class="keyword">end</span>
0496 
0497 guidata(hObject, handles);
0498 
0499 <span class="comment">%Validates the attributes for the command line Modes</span>
0500 <a name="_sub5" href="#_subfunctions" class="code">function validateModeValue(x)</a>
0501 <span class="comment">%When passed from OS terminal (or inline in Command Window) everything is a string</span>
0502 <span class="keyword">if</span> isdeployed || ischar(x) || isstring(x)
0503     x=str2double(x);
0504 <span class="keyword">end</span>
0505 validateattributes(x,{<span class="string">'logical'</span>,<span class="string">'numeric'</span>},{<span class="string">'scalar'</span>,<span class="string">'binary'</span>});
0506 
0507 
0508 
0509 <a name="_sub6" href="#_subfunctions" class="code">function Callback_StructVisibilty(source,~)</a>
0510 
0511 handles = guidata(findobj(<span class="string">'Name'</span>,<span class="string">'matRadGUI'</span>));
0512 
0513 contextUiChildren = get(get(handles.figure1,<span class="string">'UIContextMenu'</span>),<span class="string">'Children'</span>);
0514 
0515 Idx = find(strcmp(get(contextUiChildren,<span class="string">'Label'</span>),get(source,<span class="string">'Label'</span>)));
0516 <span class="keyword">if</span> strcmp(get(source,<span class="string">'Checked'</span>),<span class="string">'on'</span>)
0517     set(contextUiChildren(Idx),<span class="string">'Checked'</span>,<span class="string">'off'</span>);
0518 <span class="keyword">else</span>
0519     set(contextUiChildren(Idx),<span class="string">'Checked'</span>,<span class="string">'on'</span>);
0520 <span class="keyword">end</span>
0521 <span class="comment">%guidata(findobj('Name','matRadGUI'), handles);</span>
0522 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles);
0523 
0524 <span class="comment">% --- Outputs from this function are returned to the command line.</span>
0525 <a name="_sub7" href="#_subfunctions" class="code">function varargout = matRadGUI_OutputFcn(~, ~, handles) </a>
0526 <span class="comment">% varargout  cell array for returning output args (see VARARGOUT);</span>
0527 <span class="comment">% hObject    handle to figure</span>
0528 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0529 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0530 
0531 <span class="comment">% Get default command line output from handles structure</span>
0532 varargout{1} = handles.output;
0533 
0534 <span class="comment">% set focus on error dialog</span>
0535 <span class="keyword">if</span> isfield(handles,<span class="string">'ErrorDlg'</span>)
0536     figure(handles.ErrorDlg)
0537 <span class="keyword">end</span>
0538 
0539 <span class="comment">% --- Executes on button press in btnLoadMat.</span>
0540 <a name="_sub8" href="#_subfunctions" class="code">function btnLoadMat_Callback(hObject, ~, handles)</a>
0541 <span class="comment">% hObject    handle to btnLoadMat (see GCBO)</span>
0542 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0543 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0544 
0545 [FileName, FilePath] = uigetfile(<span class="string">'*.mat'</span>);
0546 <span class="keyword">if</span> FileName == 0 <span class="comment">% user pressed cancel --&gt; do nothing.</span>
0547     <span class="keyword">return</span>;
0548 <span class="keyword">end</span>
0549 
0550 handles = <a href="#_sub1" class="code" title="subfunction handles = resetGUI(hObject, handles, varargin)">resetGUI</a>(hObject, handles);
0551 
0552 <span class="keyword">try</span> 
0553     
0554     <span class="comment">% delete existing workspace - parse variables from base workspace</span>
0555     AllVarNames = evalin(<span class="string">'base'</span>,<span class="string">'who'</span>);
0556     RefVarNames = {<span class="string">'ct'</span>,<span class="string">'cst'</span>,<span class="string">'pln'</span>,<span class="string">'stf'</span>,<span class="string">'dij'</span>,<span class="string">'resultGUI'</span>};
0557     
0558     <span class="keyword">for</span> i = 1:length(RefVarNames)  
0559         <span class="keyword">if</span> sum(ismember(AllVarNames,RefVarNames{i}))&gt;0
0560             evalin(<span class="string">'base'</span>,[<span class="string">'clear '</span>, RefVarNames{i}]);
0561         <span class="keyword">end</span>
0562     <span class="keyword">end</span>
0563 
0564     <span class="comment">% read new data</span>
0565     load([FilePath FileName]);
0566     set(handles.legendTable,<span class="string">'String'</span>,{<span class="string">'no data loaded'</span>});
0567     set(handles.popupDisplayOption,<span class="string">'String'</span>,<span class="string">'no option available'</span>);
0568     
0569 <span class="keyword">catch</span> ME
0570     handles = <a href="#_sub38" class="code" title="subfunction handles = showError(handles,Message,ME)">showError</a>(handles,<span class="string">'LoadMatFileFnc: Could not load *.mat file'</span>,ME); 
0571 
0572     guidata(hObject,handles);
0573     <a href="#_sub29" class="code" title="subfunction UpdateState(handles)">UpdateState</a>(handles);
0574     <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles);
0575     <span class="keyword">return</span>
0576 <span class="keyword">end</span>
0577 
0578 <span class="keyword">try</span>
0579     <a href="#_sub116" class="code" title="subfunction cst = generateCstTable(handles,cst)">generateCstTable</a>(handles,cst);
0580     handles.TableChanged = false;
0581     set(handles.popupTypeOfPlot,<span class="string">'Value'</span>,1);
0582     cst = <a href="../matRad/plotting/matRad_computeVoiContoursWrapper.html" class="code" title="function cst = matRad_computeVoiContoursWrapper(cst,ct)">matRad_computeVoiContoursWrapper</a>(cst,ct);
0583 
0584     assignin(<span class="string">'base'</span>,<span class="string">'ct'</span>,ct);
0585     assignin(<span class="string">'base'</span>,<span class="string">'cst'</span>,cst);
0586     handles.State = 1;
0587 <span class="keyword">catch</span> ME
0588     handles = <a href="#_sub38" class="code" title="subfunction handles = showError(handles,Message,ME)">showError</a>(handles,<span class="string">'LoadMatFileFnc: Could not load *.mat file'</span>,ME); 
0589 <span class="keyword">end</span>
0590 
0591 <span class="comment">% check if a optimized plan was loaded</span>
0592 <span class="keyword">if</span> exist(<span class="string">'stf'</span>,<span class="string">'var'</span>)
0593     assignin(<span class="string">'base'</span>,<span class="string">'stf'</span>,stf);
0594 <span class="keyword">end</span>
0595 <span class="keyword">if</span> exist(<span class="string">'pln'</span>,<span class="string">'var'</span>)
0596     assignin(<span class="string">'base'</span>,<span class="string">'pln'</span>,pln);
0597 <span class="keyword">end</span>
0598 <span class="keyword">if</span> exist(<span class="string">'dij'</span>,<span class="string">'var'</span>)
0599     assignin(<span class="string">'base'</span>,<span class="string">'dij'</span>,dij);
0600 <span class="keyword">end</span>
0601 <span class="comment">% if exist('stf','var') &amp;&amp; exist('dij','var')</span>
0602 <span class="comment">%     handles.State = 2;</span>
0603 <span class="comment">% end</span>
0604 
0605 <span class="keyword">if</span> exist(<span class="string">'resultGUI'</span>,<span class="string">'var'</span>)
0606     assignin(<span class="string">'base'</span>,<span class="string">'resultGUI'</span>,resultGUI);
0607     <span class="comment">% handles.State = 3;</span>
0608     <span class="comment">% handles.SelectedDisplayOption ='physicalDose';</span>
0609 <span class="keyword">end</span>
0610 
0611 <span class="comment">% recheck current workspace variables</span>
0612 AllVarNames = evalin(<span class="string">'base'</span>,<span class="string">'who'</span>);
0613 handles.AllVarNames = AllVarNames;
0614 
0615 <span class="keyword">if</span> ismember(<span class="string">'ct'</span>,AllVarNames) &amp;&amp;  ismember(<span class="string">'cst'</span>,AllVarNames)
0616     handles = <a href="#_sub3" class="code" title="subfunction handles = reloadGUI(hObject, handles, ct, cst)">reloadGUI</a>(hObject, handles, ct, cst);
0617 <span class="keyword">else</span>
0618     handles = <a href="#_sub3" class="code" title="subfunction handles = reloadGUI(hObject, handles, ct, cst)">reloadGUI</a>(hObject, handles);
0619 <span class="keyword">end</span>
0620 
0621 guidata(hObject,handles);
0622 
0623 <span class="comment">% --- Executes on button press in btnLoadDicom.</span>
0624 <a name="_sub9" href="#_subfunctions" class="code">function btnLoadDicom_Callback(hObject, ~, handles)</a>
0625 <span class="comment">% hObject    handle to btnLoadDicom (see GCBO)</span>
0626 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0627 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0628 <span class="keyword">try</span>
0629     <span class="comment">% delete existing workspace - parse variables from base workspace</span>
0630     set(handles.popupDisplayOption,<span class="string">'String'</span>,<span class="string">'no option available'</span>);
0631     AllVarNames = evalin(<span class="string">'base'</span>,<span class="string">'who'</span>);
0632     RefVarNames = {<span class="string">'ct'</span>,<span class="string">'cst'</span>,<span class="string">'pln'</span>,<span class="string">'stf'</span>,<span class="string">'dij'</span>,<span class="string">'resultGUI'</span>};
0633     <span class="keyword">for</span> i = 1:length(RefVarNames)  
0634         <span class="keyword">if</span> sum(ismember(AllVarNames,RefVarNames{i}))&gt;0
0635             evalin(<span class="string">'base'</span>,[<span class="string">'clear '</span>, RefVarNames{i}]);
0636         <span class="keyword">end</span>
0637     <span class="keyword">end</span>
0638     handles.State = 0;
0639     <a href="../matRad/dicom/matRad_importDicomGUI.html" class="code" title="function varargout = matRad_importDicomGUI(varargin)">matRad_importDicomGUI</a>;
0640  
0641 <span class="keyword">catch</span>
0642    handles = <a href="#_sub38" class="code" title="subfunction handles = showError(handles,Message,ME)">showError</a>(handles,<span class="string">'DicomImport: Could not import data'</span>); 
0643 <span class="keyword">end</span>
0644 <a href="#_sub29" class="code" title="subfunction UpdateState(handles)">UpdateState</a>(handles);
0645 guidata(hObject,handles);
0646 
0647 
0648 <span class="comment">% --- Executes on button press in btn_export.</span>
0649 <a name="_sub10" href="#_subfunctions" class="code">function btn_export_Callback(hObject, eventdata, handles)</a>
0650 <span class="comment">% hObject    handle to btn_export (see GCBO)</span>
0651 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0652 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0653 
0654 <span class="keyword">try</span>
0655     <a href="../matRad/IO/matRad_exportGUI.html" class="code" title="function varargout = matRad_exportGUI(varargin)">matRad_exportGUI</a>;
0656 <span class="keyword">catch</span>
0657     handles = <a href="#_sub38" class="code" title="subfunction handles = showError(handles,Message,ME)">showError</a>(handles,<span class="string">'Could not export data'</span>); 
0658 <span class="keyword">end</span>
0659 <a href="#_sub29" class="code" title="subfunction UpdateState(handles)">UpdateState</a>(handles);
0660 guidata(hObject,handles);
0661 
0662 <a name="_sub11" href="#_subfunctions" class="code">function editBixelWidth_Callback(hObject, ~, handles)</a>
0663 <span class="comment">% hObject    handle to editBixelWidth (see GCBO)</span>
0664 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0665 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0666 
0667 <span class="comment">% Hints: get(hObject,'String') returns contents of editBixelWidth as text</span>
0668 <span class="comment">%        str2double(get(hObject,'String')) returns contents of editBixelWidth as a double</span>
0669 <a href="#_sub36" class="code" title="subfunction getPlnFromGUI(handles)">getPlnFromGUI</a>(handles);
0670 <span class="keyword">if</span> handles.State &gt; 0
0671     handles.State = 1;
0672     <a href="#_sub29" class="code" title="subfunction UpdateState(handles)">UpdateState</a>(handles);
0673     guidata(hObject,handles);
0674 <span class="keyword">end</span>
0675 
0676 <a name="_sub12" href="#_subfunctions" class="code">function editGantryAngle_Callback(hObject, ~, handles)</a>
0677 <span class="comment">% hObject    handle to editGantryAngle (see GCBO)</span>
0678 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0679 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0680 
0681 <span class="comment">% Hints: get(hObject,'String') returns contents of editGantryAngle as text</span>
0682 <span class="comment">%        str2double(get(hObject,'String')) returns contents of editGantryAngle as a double</span>
0683 <a href="#_sub36" class="code" title="subfunction getPlnFromGUI(handles)">getPlnFromGUI</a>(handles);
0684 <span class="keyword">if</span> handles.State &gt; 0
0685     handles.State = 1;
0686     <a href="#_sub29" class="code" title="subfunction UpdateState(handles)">UpdateState</a>(handles);
0687     <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles);
0688     guidata(hObject,handles);
0689 <span class="keyword">end</span>
0690 
0691 <a name="_sub13" href="#_subfunctions" class="code">function editCouchAngle_Callback(hObject, ~, handles)</a>
0692 <span class="comment">% hObject    handle to editCouchAngle (see GCBO)</span>
0693 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0694 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0695 
0696 <span class="comment">% Hints: get(hObject,'String') returns contents of editCouchAngle as text</span>
0697 <span class="comment">%        str2double(get(hObject,'String')) returns contents of editCouchAngle as a double</span>
0698 <a href="#_sub36" class="code" title="subfunction getPlnFromGUI(handles)">getPlnFromGUI</a>(handles);
0699 <span class="keyword">if</span> handles.State &gt; 0
0700     handles.State = 1;
0701     <a href="#_sub29" class="code" title="subfunction UpdateState(handles)">UpdateState</a>(handles);
0702     guidata(hObject,handles);
0703 <span class="keyword">end</span>
0704 
0705 <span class="comment">% --- Executes on selection change in popupRadMode.</span>
0706 <a name="_sub14" href="#_subfunctions" class="code">function popupRadMode_Callback(hObject, eventdata, handles)</a>
0707 <span class="comment">% hObject    handle to popupRadMode (see GCBO)</span>
0708 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0709 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0710 <a href="#_sub40" class="code" title="subfunction flag = checkRadiationComposition(handles)">checkRadiationComposition</a>(handles);
0711 contents      = cellstr(get(hObject,<span class="string">'String'</span>)); 
0712 RadIdentifier = contents{get(hObject,<span class="string">'Value'</span>)};
0713 contentPopUp  = get(handles.popMenuBioOpt,<span class="string">'String'</span>);
0714 <span class="keyword">switch</span> RadIdentifier
0715     <span class="keyword">case</span> <span class="string">'photons'</span>
0716 
0717         set(handles.popMenuBioOpt,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
0718         ix = find(strcmp(contentPopUp,<span class="string">'none'</span>));
0719         set(handles.popMenuBioOpt,<span class="string">'Value'</span>,ix);
0720         set(handles.btnSetTissue,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
0721         
0722         set(handles.btnRunSequencing,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
0723         set(handles.btnRunDAO,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
0724         set(handles.radiobutton3Dconf,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
0725         set(handles.txtSequencing,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
0726         set(handles.editSequencingLevel,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
0727         
0728     <span class="keyword">case</span> <span class="string">'protons'</span>
0729         
0730         set(handles.popMenuBioOpt,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
0731         ix = find(strcmp(contentPopUp,<span class="string">'const_RBExD'</span>));
0732         set(handles.popMenuBioOpt,<span class="string">'Value'</span>,ix);
0733         set(handles.btnSetTissue,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
0734         
0735         set(handles.btnSetTissue,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
0736         set(handles.btnRunSequencing,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
0737         set(handles.btnRunDAO,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
0738         set(handles.radiobutton3Dconf,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
0739         set(handles.txtSequencing,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
0740         set(handles.editSequencingLevel,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
0741         
0742     <span class="keyword">case</span> <span class="string">'carbon'</span>
0743 
0744         set(handles.popMenuBioOpt,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
0745         ix = find(strcmp(contentPopUp,<span class="string">'LEMIV_RBExD'</span>));
0746         set(handles.popMenuBioOpt,<span class="string">'Value'</span>,ix);
0747         set(handles.btnSetTissue,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
0748         
0749         set(handles.btnRunSequencing,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
0750         set(handles.btnRunDAO,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
0751         set(handles.radiobutton3Dconf,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
0752         set(handles.txtSequencing,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
0753         set(handles.editSequencingLevel,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
0754 <span class="keyword">end</span>
0755 
0756 <span class="keyword">if</span> handles.State &gt; 0
0757     pln = evalin(<span class="string">'base'</span>,<span class="string">'pln'</span>);
0758     <span class="keyword">if</span> handles.State &gt; 0 &amp;&amp; ~strcmp(contents(get(hObject,<span class="string">'Value'</span>)),pln.radiationMode)
0759         
0760         <span class="comment">% new radiation modality is photons -&gt; just keep physicalDose</span>
0761         <span class="keyword">if</span> strcmp(contents(get(hObject,<span class="string">'Value'</span>)),<span class="string">'photons'</span>)
0762             <span class="keyword">try</span>  
0763             AllVarNames = evalin(<span class="string">'base'</span>,<span class="string">'who'</span>);
0764                <span class="keyword">if</span>  ismember(<span class="string">'resultGUI'</span>,AllVarNames)
0765                    resultGUI = evalin(<span class="string">'base'</span>,<span class="string">'resultGUI'</span>);
0766                    <span class="keyword">if</span> isfield(resultGUI,<span class="string">'alpha'</span>);    resultGUI = rmfield(resultGUI,<span class="string">'alpha'</span>);   <span class="keyword">end</span>
0767                    <span class="keyword">if</span> isfield(resultGUI,<span class="string">'beta'</span>);     resultGUI = rmfield(resultGUI,<span class="string">'beta'</span>);    <span class="keyword">end</span>
0768                    <span class="keyword">if</span> isfield(resultGUI,<span class="string">'RBExDose'</span>); resultGUI = rmfield(resultGUI,<span class="string">'RBExDose'</span>);<span class="keyword">end</span>
0769                    <span class="keyword">if</span> isfield(resultGUI,<span class="string">'RBE'</span>);      resultGUI = rmfield(resultGUI,<span class="string">'RBE'</span>);     <span class="keyword">end</span>
0770                    assignin(<span class="string">'base'</span>,<span class="string">'resultGUI'</span>,resultGUI);
0771                    handles = <a href="#_sub64" class="code" title="subfunction handles = updateIsoDoseLineCache(handles)">updateIsoDoseLineCache</a>(handles);
0772                <span class="keyword">end</span>   
0773             <span class="keyword">catch</span>
0774             <span class="keyword">end</span>
0775         <span class="keyword">elseif</span> strcmp(contents(get(hObject,<span class="string">'Value'</span>)),<span class="string">'protons'</span>)
0776             <span class="keyword">try</span>  
0777             AllVarNames = evalin(<span class="string">'base'</span>,<span class="string">'who'</span>);
0778                <span class="keyword">if</span>  ismember(<span class="string">'resultGUI'</span>,AllVarNames)
0779                    resultGUI = evalin(<span class="string">'base'</span>,<span class="string">'resultGUI'</span>);
0780                    <span class="keyword">if</span> isfield(resultGUI,<span class="string">'alpha'</span>); resultGUI = rmfield(resultGUI,<span class="string">'alpha'</span>);<span class="keyword">end</span>
0781                    <span class="keyword">if</span> isfield(resultGUI,<span class="string">'beta'</span>);  resultGUI = rmfield(resultGUI,<span class="string">'beta'</span>); <span class="keyword">end</span>
0782                    <span class="keyword">if</span> isfield(resultGUI,<span class="string">'RBE'</span>);   resultGUI = rmfield(resultGUI,<span class="string">'RBE'</span>);  <span class="keyword">end</span>
0783                    assignin(<span class="string">'base'</span>,<span class="string">'resultGUI'</span>,resultGUI);
0784                    handles = <a href="#_sub64" class="code" title="subfunction handles = updateIsoDoseLineCache(handles)">updateIsoDoseLineCache</a>(handles);
0785                <span class="keyword">end</span>
0786             <span class="keyword">catch</span>
0787             <span class="keyword">end</span>
0788         <span class="keyword">end</span>
0789       
0790         guidata(hObject,handles);
0791         <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles);
0792        
0793         <a href="#_sub36" class="code" title="subfunction getPlnFromGUI(handles)">getPlnFromGUI</a>(handles);
0794         handles.State = 1;
0795         <a href="#_sub29" class="code" title="subfunction UpdateState(handles)">UpdateState</a>(handles);
0796 
0797     <span class="keyword">end</span>
0798          
0799 guidata(hObject,handles);
0800            
0801 <span class="keyword">end</span>
0802 
0803 
0804 <span class="comment">% --- Executes on button press in btnCalcDose.</span>
0805 <a name="_sub15" href="#_subfunctions" class="code">function btnCalcDose_Callback(hObject, ~, handles)</a>
0806 <span class="comment">% hObject    handle to btnCalcDose (see GCBO)</span>
0807 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0808 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0809 
0810 <span class="comment">% http://stackoverflow.com/questions/24703962/trigger-celleditcallback-before-button-callback</span>
0811 <span class="comment">% http://www.mathworks.com/matlabcentral/newsreader/view_thread/332613</span>
0812 <span class="comment">% wait some time until the CallEditCallback is finished</span>
0813 <span class="comment">% Callback triggers the cst saving mechanism from GUI</span>
0814 <span class="keyword">try</span>
0815     <span class="comment">% indicate that matRad is busy</span>
0816     <span class="comment">% change mouse pointer to hour glass</span>
0817     Figures = gcf;<span class="comment">%findobj('type','figure');</span>
0818     set(Figures, <span class="string">'pointer'</span>, <span class="string">'watch'</span>); 
0819     drawnow;
0820     <span class="comment">% disable all active objects</span>
0821     InterfaceObj = findobj(Figures,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
0822     set(InterfaceObj,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
0823 
0824     <span class="comment">% read plan from gui and save it to workspace</span>
0825     <span class="comment">% gets also IsoCenter from GUI if checkbox is not checked</span>
0826     <a href="#_sub36" class="code" title="subfunction getPlnFromGUI(handles)">getPlnFromGUI</a>(handles);
0827 
0828     <span class="comment">% get default iso center as center of gravity of all targets if not</span>
0829     <span class="comment">% already defined</span>
0830     pln = evalin(<span class="string">'base'</span>,<span class="string">'pln'</span>);
0831 
0832     <span class="keyword">if</span> length(pln.propStf.gantryAngles) ~= length(pln.propStf.couchAngles) 
0833         handles = <a href="#_sub39" class="code" title="subfunction handles = showWarning(handles,Message,ME)">showWarning</a>(handles,<span class="string">'number of gantryAngles != number of couchAngles'</span>); 
0834     <span class="keyword">end</span>
0835     <span class="comment">%%</span>
0836     <span class="keyword">if</span> ~<a href="#_sub40" class="code" title="subfunction flag = checkRadiationComposition(handles)">checkRadiationComposition</a>(handles)
0837         fileName = [pln.radiationMode <span class="string">'_'</span> pln.machine];
0838         handles = <a href="#_sub38" class="code" title="subfunction handles = showError(handles,Message,ME)">showError</a>(handles,errordlg([<span class="string">'Could not find the following machine file: '</span> fileName ]));
0839         guidata(hObject,handles);
0840         <span class="keyword">return</span>;
0841     <span class="keyword">end</span>
0842 
0843     <span class="comment">%% check if isocenter is already set</span>
0844     <span class="keyword">if</span> ~isfield(pln.propStf,<span class="string">'isoCenter'</span>)
0845         handles = <a href="#_sub39" class="code" title="subfunction handles = showWarning(handles,Message,ME)">showWarning</a>(handles,<span class="string">'no iso center set - using center of gravity based on structures defined as TARGET'</span>);
0846         pln.propStf.isoCenter = ones(pln.propStf.numOfBeams,1) * <a href="matRad_getIsoCenter.html" class="code" title="function isoCenter = matRad_getIsoCenter(cst,ct,visBool)">matRad_getIsoCenter</a>(evalin(<span class="string">'base'</span>,<span class="string">'cst'</span>),evalin(<span class="string">'base'</span>,<span class="string">'ct'</span>));
0847         assignin(<span class="string">'base'</span>,<span class="string">'pln'</span>,pln);
0848     <span class="keyword">elseif</span> ~get(handles.checkIsoCenter,<span class="string">'Value'</span>)
0849         <span class="keyword">if</span> ~strcmp(get(handles.editIsoCenter,<span class="string">'String'</span>),<span class="string">'multiple isoCenter'</span>)
0850             pln.propStf.isoCenter = ones(pln.propStf.numOfBeams,1)*str2num(get(handles.editIsoCenter,<span class="string">'String'</span>));
0851         <span class="keyword">end</span>
0852     <span class="keyword">end</span>
0853 
0854 <span class="keyword">catch</span> ME
0855     handles = <a href="#_sub38" class="code" title="subfunction handles = showError(handles,Message,ME)">showError</a>(handles,<span class="string">'CalcDoseCallback: Error in preprocessing!'</span>,ME); 
0856     <span class="comment">% change state from busy to normal</span>
0857     set(Figures, <span class="string">'pointer'</span>, <span class="string">'arrow'</span>);
0858     set(InterfaceObj,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
0859     guidata(hObject,handles);
0860     <span class="keyword">return</span>;
0861 <span class="keyword">end</span>
0862 
0863 <span class="comment">% generate steering file</span>
0864 <span class="keyword">try</span> 
0865     currPln = evalin(<span class="string">'base'</span>,<span class="string">'pln'</span>);
0866     <span class="comment">% if we run 3d conf opt -&gt; hijack runDao to trigger computation of</span>
0867     <span class="comment">% connected bixels</span>
0868     <span class="keyword">if</span> strcmp(pln.radiationMode,<span class="string">'photons'</span>) &amp;&amp; get(handles.radiobutton3Dconf,<span class="string">'Value'</span>)
0869        currpln.propOpt.runDAO = true; 
0870     <span class="keyword">end</span>
0871     stf = <a href="matRad_generateStf.html" class="code" title="function stf = matRad_generateStf(ct,cst,pln,visMode)">matRad_generateStf</a>(evalin(<span class="string">'base'</span>,<span class="string">'ct'</span>),<span class="keyword">...</span>
0872                                      evalin(<span class="string">'base'</span>,<span class="string">'cst'</span>),<span class="keyword">...</span>
0873                                      currPln);
0874     assignin(<span class="string">'base'</span>,<span class="string">'stf'</span>,stf);
0875 <span class="keyword">catch</span> ME
0876     handles = <a href="#_sub38" class="code" title="subfunction handles = showError(handles,Message,ME)">showError</a>(handles,<span class="string">'CalcDoseCallback: Error in steering file generation!'</span>,ME); 
0877     <span class="comment">% change state from busy to normal</span>
0878     set(Figures, <span class="string">'pointer'</span>, <span class="string">'arrow'</span>);
0879     set(InterfaceObj,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
0880     guidata(hObject,handles);
0881     <span class="keyword">return</span>;
0882 <span class="keyword">end</span>
0883 
0884 <span class="comment">% carry out dose calculation</span>
0885 <span class="keyword">try</span>
0886     <span class="keyword">if</span> strcmp(pln.radiationMode,<span class="string">'photons'</span>)
0887         dij = <a href="matRad_calcPhotonDose.html" class="code" title="function dij = matRad_calcPhotonDose(ct,stf,pln,cst,calcDoseDirect)">matRad_calcPhotonDose</a>(evalin(<span class="string">'base'</span>,<span class="string">'ct'</span>),stf,pln,evalin(<span class="string">'base'</span>,<span class="string">'cst'</span>));
0888     <span class="keyword">elseif</span> strcmp(pln.radiationMode,<span class="string">'protons'</span>) || strcmp(pln.radiationMode,<span class="string">'carbon'</span>)
0889         dij = <a href="matRad_calcParticleDose.html" class="code" title="function dij = matRad_calcParticleDose(ct,stf,pln,cst,calcDoseDirect)">matRad_calcParticleDose</a>(evalin(<span class="string">'base'</span>,<span class="string">'ct'</span>),stf,pln,evalin(<span class="string">'base'</span>,<span class="string">'cst'</span>));
0890     <span class="keyword">end</span>
0891 
0892     <span class="comment">% assign results to base worksapce</span>
0893     assignin(<span class="string">'base'</span>,<span class="string">'dij'</span>,dij);
0894     handles.State = 2;
0895     handles.TableChanged = false;
0896     <a href="#_sub29" class="code" title="subfunction UpdateState(handles)">UpdateState</a>(handles);
0897     <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles);
0898     guidata(hObject,handles);
0899 <span class="keyword">catch</span> ME
0900     handles = <a href="#_sub38" class="code" title="subfunction handles = showError(handles,Message,ME)">showError</a>(handles,<span class="string">'CalcDoseCallback: Error in dose calculation!'</span>,ME); 
0901     <span class="comment">% change state from busy to normal</span>
0902     set(Figures, <span class="string">'pointer'</span>, <span class="string">'arrow'</span>);
0903     set(InterfaceObj,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
0904     guidata(hObject,handles);
0905     <span class="keyword">return</span>;
0906 <span class="keyword">end</span>
0907 
0908 <span class="comment">% change state from busy to normal</span>
0909 set(Figures, <span class="string">'pointer'</span>, <span class="string">'arrow'</span>);
0910 set(InterfaceObj,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
0911 
0912 guidata(hObject,handles);  
0913 
0914 
0915 
0916 <span class="comment">%% plots ct and distributions</span>
0917 <a name="_sub16" href="#_subfunctions" class="code">function UpdatePlot(handles)</a>
0918 
0919 <span class="comment">%profile on;</span>
0920 
0921 axes(handles.axesFig);
0922 
0923 <span class="comment">% this is necessary to prevent multiple callbacks of update plot drawing on</span>
0924 <span class="comment">% top of each other in matlab &lt;2014</span>
0925 drawnow;
0926 
0927 defaultFontSize = 8;
0928 currAxes            = axis(handles.axesFig);
0929 AxesHandlesCT_Dose  = gobjects(0);
0930 AxesHandlesVOI      = cell(0);
0931 AxesHandlesIsoDose  = gobjects(0);
0932 
0933 <span class="keyword">if</span> handles.State == 0
0934     cla reset
0935     <span class="keyword">return</span>
0936 <span class="keyword">elseif</span> handles.State &gt; 0
0937      ct  = evalin(<span class="string">'base'</span>,<span class="string">'ct'</span>);
0938      cst = evalin(<span class="string">'base'</span>,<span class="string">'cst'</span>);
0939      pln = evalin(<span class="string">'base'</span>,<span class="string">'pln'</span>);
0940 <span class="keyword">end</span>
0941 
0942 <span class="comment">%% state 3 indicates that a optimization has been performed</span>
0943  AllVarNames = evalin(<span class="string">'base'</span>,<span class="string">'who'</span>);
0944 <span class="keyword">if</span>  ismember(<span class="string">'resultGUI'</span>,AllVarNames)
0945     Result = evalin(<span class="string">'base'</span>,<span class="string">'resultGUI'</span>);
0946 <span class="keyword">end</span>
0947 
0948 <span class="keyword">if</span> exist(<span class="string">'Result'</span>,<span class="string">'var'</span>)
0949     <span class="keyword">if</span> ~isempty(Result) &amp;&amp; ~isempty(ct.cubeHU) &amp;&amp; ~isfield(handles,<span class="string">'DispInfo'</span>)
0950         
0951         DispInfo = fieldnames(Result);
0952         
0953         <span class="keyword">for</span> i = 1:size(DispInfo,1)
0954             
0955             <span class="comment">% delete weight vectors in Result struct for plotting</span>
0956             <span class="keyword">if</span> isstruct(Result.(DispInfo{i,1})) || isvector(Result.(DispInfo{i,1}))
0957                  Result = rmfield(Result,DispInfo{i,1});
0958                  DispInfo{i,2}=false;
0959             <span class="keyword">else</span>
0960                 <span class="comment">%second dimension indicates if it should be plotted</span>
0961                 DispInfo{i,2} = true;
0962                 <span class="comment">% determine units</span>
0963                 <span class="keyword">if</span> strfind(DispInfo{i,1},<span class="string">'physicalDose'</span>)
0964                     DispInfo{i,3} = <span class="string">'[Gy]'</span>;
0965                 <span class="keyword">elseif</span> strfind(DispInfo{i,1},<span class="string">'alpha'</span>)
0966                     DispInfo{i,3} = <span class="string">'[Gy^{-1}]'</span>;
0967                 <span class="keyword">elseif</span> strfind(DispInfo{i,1},<span class="string">'beta'</span>)
0968                     DispInfo{i,3} = <span class="string">'[Gy^{-2}]'</span>;
0969                 <span class="keyword">elseif</span> strfind(DispInfo{i,1},<span class="string">'RBExD'</span>)
0970                     DispInfo{i,3} = <span class="string">'[Gy(RBE)]'</span>;
0971                 <span class="keyword">elseif</span> strfind(DispInfo{i,1},<span class="string">'LET'</span>)
0972                     DispInfo{i,3} = <span class="string">'[keV/um]'</span>;
0973                 <span class="keyword">else</span>
0974                     DispInfo{i,3} = <span class="string">'[a.u.]'</span>;
0975                 <span class="keyword">end</span>
0976                 DispInfo{i,4} = [];    <span class="comment">% optional for the future: color range for plotting</span>
0977                 DispInfo{i,5} = [];    <span class="comment">% optional for the future: min max values</span>
0978             <span class="keyword">end</span>
0979         <span class="keyword">end</span>
0980 
0981         set(handles.popupDisplayOption,<span class="string">'String'</span>,fieldnames(Result));
0982         <span class="keyword">if</span> sum(strcmp(handles.SelectedDisplayOption,fieldnames(Result))) == 0
0983             handles.SelectedDisplayOption = DispInfo{find([DispInfo{:,2}],1,<span class="string">'first'</span>),1};
0984         <span class="keyword">end</span>
0985         set(handles.popupDisplayOption,<span class="string">'Value'</span>,find(strcmp(handles.SelectedDisplayOption,fieldnames(Result))));
0986 
0987     <span class="keyword">end</span>
0988 <span class="keyword">end</span>
0989 
0990 <span class="comment">%% set and get required variables</span>
0991 plane = get(handles.popupPlane,<span class="string">'Value'</span>);
0992 slice = round(get(handles.sliderSlice,<span class="string">'Value'</span>));
0993 hold(handles.axesFig,<span class="string">'on'</span>);
0994 <span class="keyword">if</span> get(handles.popupTypeOfPlot,<span class="string">'Value'</span>)==1
0995     set(handles.axesFig,<span class="string">'YDir'</span>,<span class="string">'Reverse'</span>);
0996 <span class="keyword">end</span>
0997 
0998 <span class="comment">%% Remove colorbar?</span>
0999 plotColorbarSelection = get(handles.popupmenu_chooseColorData,<span class="string">'Value'</span>);
1000 
1001 <span class="keyword">if</span> get(handles.popupTypeOfPlot,<span class="string">'Value'</span>)==2 || plotColorbarSelection == 1
1002     <span class="keyword">if</span> isfield(handles,<span class="string">'cBarHandel'</span>)
1003         delete(handles.cBarHandel);
1004     <span class="keyword">end</span>
1005     <span class="comment">%The following seems to be necessary as MATLAB messes up some stuff</span>
1006     <span class="comment">%with the handle storage</span>
1007     ch = findall(gcf,<span class="string">'tag'</span>,<span class="string">'Colorbar'</span>);
1008     <span class="keyword">if</span> ~isempty(ch)
1009         delete(ch);
1010     <span class="keyword">end</span>
1011 <span class="keyword">end</span>
1012 
1013 selectIx = get(handles.popupmenu_chooseColorData,<span class="string">'Value'</span>);  
1014 
1015 cla(handles.axesFig); 
1016 <span class="comment">%% plot ct - if a ct cube is available and type of plot is set to 1 and not 2; 1 indicate cube plotting and 2 profile plotting</span>
1017 <span class="keyword">if</span> ~isempty(ct) &amp;&amp; get(handles.popupTypeOfPlot,<span class="string">'Value'</span>)==1
1018     
1019     <span class="keyword">if</span> selectIx == 3
1020         ctIx = 2;
1021     <span class="keyword">else</span>
1022         ctIx = selectIx;
1023     <span class="keyword">end</span>
1024     
1025     <span class="keyword">if</span> handles.cubeHUavailable
1026         plotCtCube = ct.cubeHU;
1027         ctLabel = <span class="string">'Hounsfield Units'</span>;
1028     <span class="keyword">else</span>
1029         plotCtCube = ct.cube;
1030         ctLabel = <span class="string">'Electron Density / WEQ'</span>;
1031     <span class="keyword">end</span>
1032     
1033     ctMap = <a href="../matRad/plotting/matRad_getColormap.html" class="code" title="function output = matRad_getColormap(name,size)">matRad_getColormap</a>(handles.ctColorMap,handles.cMapSize);
1034     
1035     <span class="keyword">if</span> isempty(handles.dispWindow{ctIx,2})
1036         handles.dispWindow{ctIx,2} = [min(reshape([ct.cubeHU{:}],[],1)) max(reshape([ct.cubeHU{:}],[],1))];
1037     <span class="keyword">end</span>
1038 
1039     <span class="keyword">if</span> get(handles.radiobtnCT,<span class="string">'Value'</span>)
1040         [AxesHandlesCT_Dose(end+1),~,handles.dispWindow{ctIx,1}] = <a href="../matRad/plotting/matRad_plotCtSlice.html" class="code" title="function [ctHandle,cMap,window] = matRad_plotCtSlice(axesHandle,ctCube,cubeIdx,plane,slice,cMap,window)">matRad_plotCtSlice</a>(handles.axesFig,plotCtCube,1,plane,slice,ctMap,handles.dispWindow{ctIx,1});
1041         
1042         <span class="comment">% plot colorbar? If 1 the user asked for the CT</span>
1043         <span class="keyword">if</span> plotColorbarSelection == 2 &amp;&amp; handles.cBarChanged
1044             <span class="comment">%Plot the colorbar</span>
1045             handles.cBarHandel = <a href="../matRad/plotting/matRad_plotColorbar.html" class="code" title="function cBarHandle = matRad_plotColorbar(axesHandle,cMap,window,varargin)">matRad_plotColorbar</a>(handles.axesFig,ctMap,handles.dispWindow{ctIx,1},<span class="string">'fontsize'</span>,defaultFontSize);
1046             <span class="comment">%adjust lables</span>
1047             set(get(handles.cBarHandel,<span class="string">'ylabel'</span>),<span class="string">'String'</span>, ctLabel,<span class="string">'fontsize'</span>,defaultFontSize);
1048             <span class="comment">% do not interprete as tex syntax</span>
1049             set(get(handles.cBarHandel,<span class="string">'ylabel'</span>),<span class="string">'interpreter'</span>,<span class="string">'none'</span>);
1050         <span class="keyword">end</span>
1051     <span class="keyword">end</span>
1052 <span class="keyword">end</span>
1053 
1054 <span class="comment">%% plot dose cube</span>
1055 <span class="keyword">if</span> handles.State &gt;= 1 &amp;&amp;  get(handles.popupTypeOfPlot,<span class="string">'Value'</span>)== 1  &amp;&amp; exist(<span class="string">'Result'</span>,<span class="string">'var'</span>)
1056         doseMap = <a href="../matRad/plotting/matRad_getColormap.html" class="code" title="function output = matRad_getColormap(name,size)">matRad_getColormap</a>(handles.doseColorMap,handles.cMapSize);
1057         doseIx  = 3;
1058         <span class="comment">% if the selected display option doesn't exist then simply display</span>
1059         <span class="comment">% the first cube of the Result struct</span>
1060         <span class="keyword">if</span> ~isfield(Result,handles.SelectedDisplayOption)
1061             CubeNames = fieldnames(Result);
1062             handles.SelectedDisplayOption = CubeNames{1,1};
1063         <span class="keyword">end</span>
1064         
1065         dose = Result.(handles.SelectedDisplayOption);
1066         
1067         <span class="comment">% dose colorwash</span>
1068         <span class="keyword">if</span> ~isempty(dose) &amp;&amp; ~isvector(dose)
1069            
1070             <span class="keyword">if</span> isempty(handles.dispWindow{doseIx,2})
1071                 handles.dispWindow{doseIx,2} = [min(dose(:)) max(dose(:))];   <span class="comment">% set min and max dose values</span>
1072             <span class="keyword">end</span>
1073             
1074             <span class="keyword">if</span> get(handles.radiobtnDose,<span class="string">'Value'</span>)
1075                 [doseHandle,~,handles.dispWindow{doseIx,1}] = <a href="../matRad/plotting/matRad_plotDoseSlice.html" class="code" title="function [doseHandle,cMap,window] = matRad_plotDoseSlice(axesHandle,doseCube,plane,slice,threshold,alpha,cMap,window)">matRad_plotDoseSlice</a>(handles.axesFig,dose,plane,slice,handles.CutOffLevel,handles.doseOpacity,doseMap,handles.dispWindow{doseIx,1});
1076                 AxesHandlesCT_Dose(end+1)         = doseHandle;
1077             <span class="keyword">end</span>            
1078                     
1079             <span class="comment">% plot colorbar?</span>
1080             <span class="keyword">if</span> plotColorbarSelection &gt; 2 &amp;&amp; handles.cBarChanged
1081                 <span class="comment">%Plot the colorbar</span>
1082                 handles.cBarHandel = <a href="../matRad/plotting/matRad_plotColorbar.html" class="code" title="function cBarHandle = matRad_plotColorbar(axesHandle,cMap,window,varargin)">matRad_plotColorbar</a>(handles.axesFig,doseMap,handles.dispWindow{selectIx,1},<span class="string">'fontsize'</span>,defaultFontSize);
1083                 <span class="comment">%adjust lables</span>
1084                 Idx = find(strcmp(handles.SelectedDisplayOption,DispInfo(:,1)));
1085                 set(get(handles.cBarHandel,<span class="string">'ylabel'</span>),<span class="string">'String'</span>, [DispInfo{Idx,1} <span class="string">' '</span> DispInfo{Idx,3} ],<span class="string">'fontsize'</span>,defaultFontSize);
1086                 <span class="comment">% do not interprete as tex syntax</span>
1087                 set(get(handles.cBarHandel,<span class="string">'ylabel'</span>),<span class="string">'interpreter'</span>,<span class="string">'none'</span>);
1088             <span class="keyword">end</span>
1089         <span class="keyword">end</span>
1090         
1091 
1092         <span class="comment">%% plot iso dose lines</span>
1093         <span class="keyword">if</span> get(handles.radiobtnIsoDoseLines,<span class="string">'Value'</span>)           
1094             plotLabels = get(handles.radiobtnIsoDoseLinesLabels,<span class="string">'Value'</span>) == 1;
1095             
1096             <span class="comment">%Sanity Check for Contours, which actually should have been</span>
1097             <span class="comment">%computed before calling UpdatePlot</span>
1098             <span class="keyword">if</span> ~isfield(handles.IsoDose,<span class="string">'Contours'</span>)
1099                 <span class="keyword">try</span>
1100                     handles.IsoDose.Contours = <a href="../matRad/plotting/matRad_computeIsoDoseContours.html" class="code" title="function isoDoseContours = matRad_computeIsoDoseContours(doseCube,isoLevels)">matRad_computeIsoDoseContours</a>(dose,handles.IsoDose.Levels); 
1101                 <span class="keyword">catch</span>
1102                     <span class="comment">%If the computation didn't work, we set the field to</span>
1103                     <span class="comment">%empty, which will force matRad_plotIsoDoseLines to use</span>
1104                     <span class="comment">%matlabs contour function instead of repeating the</span>
1105                     <span class="comment">%failing computation every time</span>
1106                     handles.IsoDose.Contours = [];
1107                     warning(<span class="string">'Could not compute isodose lines! Will try slower contour function!'</span>);
1108                 <span class="keyword">end</span>
1109             <span class="keyword">end</span>
1110             AxesHandlesIsoDose = <a href="../matRad/plotting/matRad_plotIsoDoseLines.html" class="code" title="function isoLineHandles = matRad_plotIsoDoseLines(axesHandle,doseCube,isoContours,isoLevels,plotLabels,plane,slice,cMap,window,varargin)">matRad_plotIsoDoseLines</a>(handles.axesFig,dose,handles.IsoDose.Contours,handles.IsoDose.Levels,plotLabels,plane,slice,doseMap,handles.dispWindow{doseIx,1},<span class="string">'LineWidth'</span>,1.5);
1111         <span class="keyword">end</span>
1112 <span class="keyword">end</span>
1113 
1114 selectIx = get(handles.popupmenu_chooseColorData,<span class="string">'Value'</span>);
1115 set(handles.txtMinVal,<span class="string">'String'</span>,num2str(handles.dispWindow{selectIx,2}(1,1)));
1116 set(handles.txtMaxVal,<span class="string">'String'</span>,num2str(handles.dispWindow{selectIx,2}(1,2)));
1117 
1118 <span class="comment">%% plot VOIs</span>
1119 <span class="keyword">if</span> get(handles.radiobtnContour,<span class="string">'Value'</span>) &amp;&amp; get(handles.popupTypeOfPlot,<span class="string">'Value'</span>)==1 &amp;&amp; handles.State&gt;0
1120     AxesHandlesVOI = [AxesHandlesVOI <a href="../matRad/plotting/matRad_plotVoiContourSlice.html" class="code" title="function [voiContourHandles] = matRad_plotVoiContourSlice(axesHandle,cst,ct,ctIndex,selection,plane,slice,cMap,varargin)">matRad_plotVoiContourSlice</a>(handles.axesFig,cst,ct,1,handles.VOIPlotFlag,plane,slice,[],<span class="string">'LineWidth'</span>,2)];
1121 <span class="keyword">end</span>
1122 
1123 <span class="comment">%% Set axis labels and plot iso center</span>
1124 <a href="../matRad/plotting/matRad_plotAxisLabels.html" class="code" title="function  matRad_plotAxisLabels(axesHandle,ct,plane,slice,defaultFontSize,tickdist)">matRad_plotAxisLabels</a>(handles.axesFig,ct,plane,slice,defaultFontSize);
1125 
1126 <span class="keyword">if</span> get(handles.radioBtnIsoCenter,<span class="string">'Value'</span>) == 1 &amp;&amp; get(handles.popupTypeOfPlot,<span class="string">'Value'</span>) == 1 &amp;&amp; ~isempty(pln)
1127     hIsoCenterCross = <a href="../matRad/plotting/matRad_plotIsoCenterMarker.html" class="code" title="function markerHandle = matRad_plotIsoCenterMarker(axesHandle,pln,ct,plane,slice,style)">matRad_plotIsoCenterMarker</a>(handles.axesFig,pln,ct,plane,slice);
1128 <span class="keyword">end</span>
1129 
1130 <span class="keyword">if</span> get(handles.radiobtnPlan,<span class="string">'value'</span>) == 1 &amp;&amp; ~isempty(pln)
1131     <a href="../matRad/plotting/matRad_plotProjectedGantryAngles.html" class="code" title="function matRad_plotProjectedGantryAngles(axesHandle,pln,ct,plane)">matRad_plotProjectedGantryAngles</a>(handles.axesFig,pln,ct,plane);
1132 <span class="keyword">end</span>
1133 
1134 <span class="comment">% the following line ensures the plotting order (optional)</span>
1135 <span class="comment">% set(gca,'Children',[AxesHandlesCT_Dose hIsoCenterCross AxesHandlesIsoDose  AxesHandlesVOI ]);</span>
1136   
1137 <span class="comment">%set axis ratio</span>
1138 ratios = [1/ct.resolution.x 1/ct.resolution.y 1/ct.resolution.z];
1139 set(handles.axesFig,<span class="string">'DataAspectRatioMode'</span>,<span class="string">'manual'</span>);
1140 <span class="keyword">if</span> plane == 1 
1141       res = [ratios(3) ratios(1)]./max([ratios(3) ratios(1)]);  
1142       set(handles.axesFig,<span class="string">'DataAspectRatio'</span>,[res 1])
1143 <span class="keyword">elseif</span> plane == 2 <span class="comment">% sagittal plane</span>
1144       res = [ratios(3) ratios(2)]./max([ratios(3) ratios(2)]);  
1145       set(handles.axesFig,<span class="string">'DataAspectRatio'</span>,[res 1]) 
1146 <span class="keyword">elseif</span>  plane == 3 <span class="comment">% Axial plane</span>
1147       res = [ratios(1) ratios(2)]./max([ratios(1) ratios(2)]);  
1148       set(handles.axesFig,<span class="string">'DataAspectRatio'</span>,[res 1])
1149 <span class="keyword">end</span>
1150 
1151 
1152 <span class="comment">%% profile plot</span>
1153 <span class="keyword">if</span> get(handles.popupTypeOfPlot,<span class="string">'Value'</span>) == 2 &amp;&amp; exist(<span class="string">'Result'</span>,<span class="string">'var'</span>)
1154     <span class="comment">% set SAD</span>
1155     fileName = [pln.radiationMode <span class="string">'_'</span> pln.machine];
1156     <span class="keyword">try</span>
1157         load([<span class="string">'basedata'</span> filesep fileName]);
1158         SAD = machine.meta.SAD;
1159     <span class="keyword">catch</span>
1160         error([<span class="string">'Could not find the following machine file: '</span> fileName ]); 
1161     <span class="keyword">end</span>
1162      
1163     <span class="comment">% clear view and initialize some values</span>
1164     cla(handles.axesFig,<span class="string">'reset'</span>)
1165     set(gca,<span class="string">'YDir'</span>,<span class="string">'normal'</span>);
1166     ylabel(<span class="string">'{\color{black}dose [Gy]}'</span>)
1167     cColor={<span class="string">'black'</span>,<span class="string">'green'</span>,<span class="string">'magenta'</span>,<span class="string">'cyan'</span>,<span class="string">'yellow'</span>,<span class="string">'red'</span>,<span class="string">'blue'</span>};
1168     
1169     <span class="comment">% Rotate the system into the beam.</span>
1170     <span class="comment">% passive rotation &amp; row vector multiplication &amp; inverted rotation requires triple matrix transpose</span>
1171     rotMat_system_T = transpose(<a href="matRad_getRotationMatrix.html" class="code" title="function rotMat = matRad_getRotationMatrix(gantryAngle,couchAngle,system)">matRad_getRotationMatrix</a>(pln.propStf.gantryAngles(handles.selectedBeam),pln.propStf.couchAngles(handles.selectedBeam)));
1172     
1173     <span class="keyword">if</span> strcmp(handles.ProfileType,<span class="string">'longitudinal'</span>)
1174         sourcePointBEV = [handles.profileOffset -SAD   0];
1175         targetPointBEV = [handles.profileOffset  SAD   0];
1176     <span class="keyword">elseif</span> strcmp(handles.ProfileType,<span class="string">'lateral'</span>)
1177         sourcePointBEV = [-SAD handles.profileOffset   0];
1178         targetPointBEV = [ SAD handles.profileOffset   0];
1179     <span class="keyword">end</span>
1180     
1181     rotSourcePointBEV = sourcePointBEV * rotMat_system_T;
1182     rotTargetPointBEV = targetPointBEV * rotMat_system_T;
1183     
1184     <span class="comment">% perform raytracing on the central axis of the selected beam, use unit</span>
1185     <span class="comment">% electron density for plotting against the geometrical depth</span>
1186     [~,l,rho,~,ix] = <a href="matRad_siddonRayTracer.html" class="code" title="function [alphas,l,rho,d12,ix] = matRad_siddonRayTracer(isocenter,resolution,sourcePoint,targetPoint,cubes)">matRad_siddonRayTracer</a>(pln.propStf.isoCenter(handles.selectedBeam,:),ct.resolution,rotSourcePointBEV,rotTargetPointBEV,{0*ct.cubeHU{1}+1});
1187     d = [0 l .* rho{1}];
1188     <span class="comment">% Calculate accumulated d sum.</span>
1189     vX = cumsum(d(1:end-1));
1190     
1191     <span class="comment">% this step is necessary if visualization is set to profile plot</span>
1192     <span class="comment">% and another optimization is carried out - set focus on GUI</span>
1193     figHandles = get(0,<span class="string">'Children'</span>);
1194     idxHandle = [];
1195     <span class="keyword">if</span> ~isempty(figHandles)
1196         v=version;
1197         <span class="keyword">if</span> str2double(v(1:3))&gt;= 8.5
1198             idxHandle = strcmp({figHandles(:).Name},<span class="string">'matRadGUI'</span>);
1199         <span class="keyword">else</span>
1200             idxHandle = strcmp(get(figHandles,<span class="string">'Name'</span>),<span class="string">'matRadGUI'</span>);
1201         <span class="keyword">end</span>
1202     <span class="keyword">end</span>
1203     figure(figHandles(idxHandle));
1204     
1205     <span class="comment">% plot physical dose</span>
1206     Content = get(handles.popupDisplayOption,<span class="string">'String'</span>);
1207     SelectedCube = Content{get(handles.popupDisplayOption,<span class="string">'Value'</span>)};
1208     <span class="keyword">if</span> sum(strcmp(SelectedCube,{<span class="string">'physicalDose'</span>,<span class="string">'effect'</span>,<span class="string">'RBExDose'</span>,<span class="string">'alpha'</span>,<span class="string">'beta'</span>,<span class="string">'RBE'</span>})) &gt; 0
1209          Suffix = <span class="string">''</span>;
1210     <span class="keyword">else</span>
1211         Idx    = find(SelectedCube == <span class="string">'_'</span>);
1212         Suffix = SelectedCube(Idx:end);
1213     <span class="keyword">end</span>
1214     
1215     mPhysDose = Result.([<span class="string">'physicalDose'</span> Suffix]); 
1216     PlotHandles{1} = plot(handles.axesFig,vX,mPhysDose(ix),<span class="string">'color'</span>,cColor{1,1},<span class="string">'LineWidth'</span>,3); hold on; 
1217     PlotHandles{1,2} =<span class="string">'physicalDose'</span>;
1218     ylabel(handles.axesFig,<span class="string">'dose in [Gy]'</span>);
1219     set(handles.axesFig,<span class="string">'FontSize'</span>,defaultFontSize);
1220     
1221     <span class="comment">% plot counter</span>
1222     Cnt=2;
1223     
1224     <span class="keyword">if</span> isfield(Result,[<span class="string">'RBE'</span> Suffix])
1225         
1226         <span class="comment">%disbale specific plots</span>
1227         <span class="comment">%DispInfo{6,2}=0;</span>
1228         <span class="comment">%DispInfo{5,2}=0;</span>
1229         <span class="comment">%DispInfo{2,2}=0;</span>
1230         
1231         <span class="comment">% generate two lines for ylabel</span>
1232         StringYLabel1 = <span class="string">'\fontsize{8}{\color{red}RBE x dose [Gy(RBE)] \color{black}dose [Gy] '</span>;
1233         StringYLabel2 = <span class="string">''</span>;
1234         <span class="keyword">for</span> i=1:1:size(DispInfo,1)
1235             <span class="keyword">if</span> DispInfo{i,2} &amp;&amp; sum(strcmp(DispInfo{i,1},{[<span class="string">'effect'</span> Suffix],[<span class="string">'alpha'</span> Suffix],[<span class="string">'beta'</span> Suffix]})) &gt; 0
1236                 <span class="comment">%physicalDose is already plotted and RBExD vs RBE is plotted later with plotyy</span>
1237                 <span class="keyword">if</span> ~strcmp(DispInfo{i,1},[<span class="string">'RBExDose'</span> Suffix]) &amp;&amp;<span class="keyword">...</span>
1238                    ~strcmp(DispInfo{i,1},[<span class="string">'RBE'</span> Suffix]) &amp;&amp; <span class="keyword">...</span>
1239                    ~strcmp(DispInfo{i,1},[<span class="string">'physicalDose'</span> Suffix])
1240                
1241                         mCube = Result.([DispInfo{i,1}]);
1242                         PlotHandles{Cnt,1} = plot(handles.axesFig,vX,mCube(ix),<span class="string">'color'</span>,cColor{1,Cnt},<span class="string">'LineWidth'</span>,3);hold on; 
1243                         PlotHandles{Cnt,2} = DispInfo{i,1};
1244                         StringYLabel2 = [StringYLabel2  <span class="string">' \color{'</span>  cColor{1,Cnt} <span class="string">'}'</span> DispInfo{i,1} <span class="string">' ['</span>  DispInfo{i,3} <span class="string">']'</span>];
1245                         Cnt = Cnt+1;
1246                 <span class="keyword">end</span>    
1247             <span class="keyword">end</span>
1248         <span class="keyword">end</span>
1249         StringYLabel2 = [StringYLabel2 <span class="string">'}'</span>];
1250         <span class="comment">% always plot RBExD against RBE</span>
1251         mRBExDose = Result.([<span class="string">'RBExDose'</span> Suffix]);
1252         vBED = mRBExDose(ix);
1253         mRBE = Result.([<span class="string">'RBE'</span> Suffix]);
1254         vRBE = mRBE(ix);
1255         
1256         <span class="comment">% plot biological dose against RBE</span>
1257         [ax, PlotHandles{Cnt,1}, PlotHandles{Cnt+1,1}]=plotyy(handles.axesFig,vX,vBED,vX,vRBE,<span class="string">'plot'</span>);hold on;
1258         PlotHandles{Cnt,2}=<span class="string">'RBExDose'</span>;
1259         PlotHandles{Cnt+1,2}=<span class="string">'RBE'</span>;
1260          
1261         <span class="comment">% set plotyy properties</span>
1262         set(get(ax(2),<span class="string">'Ylabel'</span>),<span class="string">'String'</span>,<span class="string">'RBE [a.u.]'</span>,<span class="string">'FontSize'</span>,8);       
1263         ylabel({StringYLabel1;StringYLabel2})
1264         set(PlotHandles{Cnt,1},<span class="string">'Linewidth'</span>,4,<span class="string">'color'</span>,<span class="string">'r'</span>);
1265         set(PlotHandles{Cnt+1,1},<span class="string">'Linewidth'</span>,3,<span class="string">'color'</span>,<span class="string">'b'</span>);
1266         set(ax(1),<span class="string">'ycolor'</span>,<span class="string">'r'</span>)
1267         set(ax(2),<span class="string">'ycolor'</span>,<span class="string">'b'</span>)
1268         set(ax,<span class="string">'FontSize'</span>,8);
1269         Cnt=Cnt+2;
1270     <span class="keyword">end</span>
1271        
1272     <span class="comment">% asses target coordinates</span>
1273     tmpPrior = intmax;
1274     tmpSize = 0;
1275     <span class="keyword">for</span> i=1:size(cst,1)
1276         <span class="keyword">if</span> strcmp(cst{i,3},<span class="string">'TARGET'</span>) &amp;&amp; tmpPrior &gt;= cst{i,5}.Priority &amp;&amp; tmpSize&lt;numel(cst{i,4}{1})
1277            linIdxTarget = unique(cst{i,4}{1});
1278            tmpPrior=cst{i,5}.Priority;
1279            tmpSize=numel(cst{i,4}{1});
1280            VOI = cst{i,2};
1281         <span class="keyword">end</span>
1282     <span class="keyword">end</span>
1283     
1284     str = sprintf(<span class="string">'profile plot - central axis of %d beam gantry angle %d? couch angle %d?'</span>,<span class="keyword">...</span>
1285         handles.selectedBeam ,pln.propStf.gantryAngles(handles.selectedBeam),pln.propStf.couchAngles(handles.selectedBeam));
1286     h_title = title(handles.axesFig,str,<span class="string">'FontSize'</span>,defaultFontSize);
1287     pos = get(h_title,<span class="string">'Position'</span>);
1288     set(h_title,<span class="string">'Position'</span>,[pos(1)-40 pos(2) pos(3)])
1289     
1290     <span class="comment">% plot target boundaries</span>
1291     mTargetCube = zeros(ct.cubeDim);
1292     mTargetCube(linIdxTarget) = 1;
1293     vProfile = mTargetCube(ix);
1294     WEPL_Target_Entry = vX(find(vProfile,1,<span class="string">'first'</span>));
1295     WEPL_Target_Exit  = vX(find(vProfile,1,<span class="string">'last'</span>));
1296     PlotHandles{Cnt,2} =[VOI <span class="string">' boundary'</span>];
1297     
1298     <span class="keyword">if</span> ~isempty(WEPL_Target_Entry) &amp;&amp; ~isempty(WEPL_Target_Exit)
1299         hold on
1300         PlotHandles{Cnt,1} = <span class="keyword">...</span>
1301         plot([WEPL_Target_Entry WEPL_Target_Entry],get(handles.axesFig,<span class="string">'YLim'</span>),<span class="string">'--'</span>,<span class="string">'Linewidth'</span>,3,<span class="string">'color'</span>,<span class="string">'k'</span>);hold on
1302         plot([WEPL_Target_Exit WEPL_Target_Exit],get(handles.axesFig,<span class="string">'YLim'</span>),<span class="string">'--'</span>,<span class="string">'Linewidth'</span>,3,<span class="string">'color'</span>,<span class="string">'k'</span>);hold on
1303       
1304     <span class="keyword">else</span>
1305         PlotHandles{Cnt,1} =[];
1306     <span class="keyword">end</span>
1307     
1308    Lines  = PlotHandles(~cellfun(@isempty,PlotHandles(:,1)),1);
1309    Labels = PlotHandles(~cellfun(@isempty,PlotHandles(:,1)),2);
1310    h=legend(handles.axesFig,[Lines{:}],Labels{:});
1311    set(h,<span class="string">'FontSize'</span>,defaultFontSize);
1312    xlabel(<span class="string">'radiological depth [mm]'</span>,<span class="string">'FontSize'</span>,8);  
1313    grid on, grid minor
1314    
1315 <span class="keyword">end</span>
1316 
1317 zoom(handles.figure1,<span class="string">'reset'</span>);
1318 axis(handles.axesFig,<span class="string">'tight'</span>);
1319 
1320 
1321 <span class="keyword">if</span> isfield(handles,<span class="string">'rememberCurrAxes'</span>) &amp;&amp; handles.rememberCurrAxes
1322     axis(currAxes);
1323 <span class="keyword">end</span>
1324 
1325 hold(handles.axesFig,<span class="string">'off'</span>);
1326 
1327 handles.cBarChanged = false;
1328 guidata(handles.axesFig,handles);
1329 <span class="comment">%guidata(gcf,handles);</span>
1330 <span class="keyword">if</span> get(handles.popupTypeOfPlot,<span class="string">'Value'</span>)==1 
1331     <a href="#_sub88" class="code" title="subfunction UpdateColormapOptions(handles)">UpdateColormapOptions</a>(handles);
1332 <span class="keyword">end</span>
1333 
1334 <a href="#_sub17" class="code" title="subfunction Update3DView(handles)">Update3DView</a>(handles);
1335 
1336 <span class="comment">%profile off;</span>
1337 <span class="comment">%profile viewer;</span>
1338 
1339 <a name="_sub17" href="#_subfunctions" class="code">function Update3DView(handles)</a>
1340 
1341 <span class="keyword">if</span> isfield(handles,<span class="string">'axesFig3D'</span>) &amp;&amp; isfield(handles,<span class="string">'fig3D'</span>) &amp;&amp; isgraphics(handles.axesFig3D) &amp;&amp; isgraphics(handles.fig3D)
1342     axesFig3D = handles.axesFig3D;
1343     fig3D = handles.fig3D;    
1344 <span class="keyword">else</span>
1345     <span class="keyword">return</span>
1346 <span class="keyword">end</span>
1347 
1348 <span class="keyword">if</span> handles.State == 0
1349     <span class="keyword">return</span>
1350 <span class="keyword">elseif</span> handles.State &gt; 0
1351     AllVarNames = evalin(<span class="string">'base'</span>,<span class="string">'who'</span>);
1352     <span class="keyword">if</span>  ismember(<span class="string">'resultGUI'</span>,AllVarNames)
1353         Result = evalin(<span class="string">'base'</span>,<span class="string">'resultGUI'</span>);
1354     <span class="keyword">end</span>
1355     
1356     <span class="keyword">if</span>  ismember(<span class="string">'stf'</span>,AllVarNames)
1357         stf = evalin(<span class="string">'base'</span>,<span class="string">'stf'</span>);
1358     <span class="keyword">else</span>
1359         stf = [];
1360     <span class="keyword">end</span>
1361 
1362     ct  = evalin(<span class="string">'base'</span>,<span class="string">'ct'</span>);
1363     cst = evalin(<span class="string">'base'</span>,<span class="string">'cst'</span>);
1364     pln = evalin(<span class="string">'base'</span>,<span class="string">'pln'</span>);
1365 <span class="keyword">end</span>
1366 
1367 oldView = get(axesFig3D,<span class="string">'View'</span>);
1368 
1369 cla(axesFig3D);
1370 <span class="comment">%delete(allchild(axesFig3D));</span>
1371 
1372 <span class="comment">%test = allchild(axesFig3D);</span>
1373 
1374 plane = get(handles.popupPlane,<span class="string">'Value'</span>);
1375 slice = round(get(handles.sliderSlice,<span class="string">'Value'</span>));
1376 defaultFontSize = 8;
1377 
1378 <span class="comment">%Check if we need to precompute the surface data</span>
1379 <span class="keyword">if</span> size(cst,2) &lt; 8
1380     cst = <a href="../matRad/plotting/matRad_computeAllVoiSurfaces.html" class="code" title="function cst = matRad_computeAllVoiSurfaces(ct,cst)">matRad_computeAllVoiSurfaces</a>(ct,cst);
1381     assignin(<span class="string">'base'</span>,<span class="string">'cst'</span>,cst);
1382 <span class="keyword">end</span>
1383 
1384 set(fig3D,<span class="string">'Color'</span>,0.5*[1 1 1]);
1385 set(axesFig3D,<span class="string">'Color'</span>,1*[0 0 0]);
1386 
1387 <span class="comment">%% Plot 3D structures</span>
1388 hold(axesFig3D,<span class="string">'on'</span>);
1389 <span class="keyword">if</span> get(handles.radiobtnContour,<span class="string">'Value'</span>) &amp;&amp; handles.State&gt;0
1390     voiPatches = <a href="../matRad/plotting/matRad_plotVois3D.html" class="code" title="function patches = matRad_plotVois3D(axesHandle,ct,cst,selection,cMap)">matRad_plotVois3D</a>(axesFig3D,ct,cst,handles.VOIPlotFlag,colorcube);
1391 <span class="keyword">end</span>
1392 
1393 <span class="comment">%% plot the CT slice</span>
1394 <span class="keyword">if</span> get(handles.radiobtnCT,<span class="string">'Value'</span>)
1395     window = handles.dispWindow{2,1}; <span class="comment">%(2 for ct)</span>
1396     ctMap = <a href="../matRad/plotting/matRad_getColormap.html" class="code" title="function output = matRad_getColormap(name,size)">matRad_getColormap</a>(handles.ctColorMap,handles.cMapSize);
1397     ctHandle = <a href="../matRad/plotting/matRad_plotCtSlice3D.html" class="code" title="function [ctHandle,cMap,window] = matRad_plotCtSlice3D(axesHandle,ct,cubeIdx,plane,ctSlice,cMap,window)">matRad_plotCtSlice3D</a>(axesFig3D,ct,1,plane,slice,ctMap,window);
1398 <span class="keyword">end</span>
1399 
1400 <span class="comment">%% plot the dose slice</span>
1401 <span class="keyword">if</span> handles.State &gt;= 1 &amp;&amp; exist(<span class="string">'Result'</span>,<span class="string">'var'</span>)
1402     doseMap = <a href="../matRad/plotting/matRad_getColormap.html" class="code" title="function output = matRad_getColormap(name,size)">matRad_getColormap</a>(handles.doseColorMap,handles.cMapSize);
1403     doseIx  = 3;
1404     <span class="comment">% if the selected display option doesn't exist then simply display</span>
1405     <span class="comment">% the first cube of the Result struct</span>
1406     <span class="keyword">if</span> ~isfield(Result,handles.SelectedDisplayOption)
1407         CubeNames = fieldnames(Result);
1408         handles.SelectedDisplayOption = CubeNames{1,1};
1409     <span class="keyword">end</span>
1410     
1411     dose = Result.(handles.SelectedDisplayOption);
1412     
1413     <span class="comment">% dose colorwash</span>
1414     <span class="keyword">if</span> ~isempty(dose) &amp;&amp; ~isvector(dose)
1415         
1416         <span class="keyword">if</span> isempty(handles.dispWindow{doseIx,2})
1417             handles.dispWindow{doseIx,2} = [min(dose(:)) max(dose(:))];   <span class="comment">% set min and max dose values</span>
1418         <span class="keyword">end</span>
1419         
1420         <span class="keyword">if</span> get(handles.radiobtnDose,<span class="string">'Value'</span>)
1421             [doseHandle,~,handles.dispWindow{doseIx,1}] = <a href="../matRad/plotting/matRad_plotDoseSlice3D.html" class="code" title="function [doseHandle,cMap,window] = matRad_plotDoseSlice3D(axesHandle,ct,doseCube,plane,slice,threshold,alpha,cMap,window)">matRad_plotDoseSlice3D</a>(axesFig3D,ct,dose,plane,slice,handles.CutOffLevel,handles.doseOpacity,doseMap,handles.dispWindow{doseIx,1});
1422         <span class="keyword">end</span>
1423         <span class="keyword">if</span> get(handles.radiobtnIsoDoseLines,<span class="string">'Value'</span>)
1424             <a href="../matRad/plotting/matRad_plotIsoDoseLines3D.html" class="code" title="function isoLineHandles = matRad_plotIsoDoseLines3D(axesHandle,ct,doseCube,isoContours,isoLevels,plane,slice,cMap,window,varargin)">matRad_plotIsoDoseLines3D</a>(axesFig3D,ct,dose,handles.IsoDose.Contours,handles.IsoDose.Levels,plane,slice,doseMap,handles.dispWindow{doseIx,1},<span class="string">'LineWidth'</span>,1.5);
1425         <span class="keyword">end</span>
1426     <span class="keyword">end</span>
1427 <span class="keyword">end</span>
1428 
1429 <span class="keyword">if</span> get(handles.radiobtnPlan,<span class="string">'Value'</span>)
1430     <a href="../matRad/plotting/matRad_plotPlan3D.html" class="code" title="function matRad_plotPlan3D(axesHandle,pln,stf)">matRad_plotPlan3D</a>(axesFig3D,pln,stf);
1431 <span class="keyword">end</span>
1432 
1433 <span class="comment">%hLight = light('Parent',axesFig3D);</span>
1434 <span class="comment">%camlight(hLight,'left');</span>
1435 <span class="comment">%lighting('gouraud');</span>
1436 
1437 xlabel(axesFig3D,<span class="string">'x [voxels]'</span>,<span class="string">'FontSize'</span>,defaultFontSize)
1438 ylabel(axesFig3D,<span class="string">'y [voxels]'</span>,<span class="string">'FontSize'</span>,defaultFontSize)
1439 zlabel(axesFig3D,<span class="string">'z [voxels]'</span>,<span class="string">'FontSize'</span>,defaultFontSize)
1440 title(axesFig3D,<span class="string">'matRad 3D view'</span>);
1441 
1442 <span class="comment">% set axis ratio</span>
1443 ratios = [1 1 1]; <span class="comment">%[1/ct.resolution.x 1/ct.resolution.y 1/ct.resolution.z];</span>
1444 ratios = ratios([2 1 3]);
1445 set(axesFig3D,<span class="string">'DataAspectRatioMode'</span>,<span class="string">'manual'</span>);
1446 set(axesFig3D,<span class="string">'DataAspectRatio'</span>,ratios./max(ratios));
1447 
1448 set(axesFig3D,<span class="string">'Ydir'</span>,<span class="string">'reverse'</span>);
1449 
1450 set(axesFig3D,<span class="string">'view'</span>,oldView);
1451 
1452 
1453 <span class="comment">% --- Executes on selection change in popupPlane.</span>
1454 <a name="_sub18" href="#_subfunctions" class="code">function popupPlane_Callback(hObject, ~, handles)</a>
1455 <span class="comment">% hObject    handle to popupPlane (see GCBO)</span>
1456 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
1457 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
1458 
1459 <span class="comment">% Hints: contents = cellstr(get(hObject,'String')) returns popupPlane contents as cell array</span>
1460 <span class="comment">%        contents{get(hObject,'Value')} returns selected item from popupPlane</span>
1461 
1462 <span class="comment">% set slice slider</span>
1463 handles.plane = get(hObject,<span class="string">'value'</span>);
1464 <a href="#_sub2" class="code" title="subfunction initViewSliceSlider(handles)">initViewSliceSlider</a>(handles);
1465 
1466 handles.rememberCurrAxes = false;
1467 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles);
1468 handles.rememberCurrAxes = true;
1469 guidata(hObject,handles);
1470 
1471 <span class="comment">% --- Executes on slider movement.</span>
1472 <a name="_sub19" href="#_subfunctions" class="code">function sliderSlice_Callback(~, ~, handles)</a>
1473 <span class="comment">% hObject    handle to sliderSlice (see GCBO)</span>
1474 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
1475 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
1476 
1477 <span class="comment">% Hints: get(hObject,'Value') returns position of slider</span>
1478 <span class="comment">%        get(hObject,'Min') and get(hObject,'Max') to determine range of slider</span>
1479 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles)
1480 
1481 <span class="comment">% --- Executes on button press in radiobtnContour.</span>
1482 <a name="_sub20" href="#_subfunctions" class="code">function radiobtnContour_Callback(~, ~, handles)</a>
1483 <span class="comment">% hObject    handle to radiobtnContour (see GCBO)</span>
1484 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
1485 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
1486 
1487 <span class="comment">% Hint: get(hObject,'Value') returns toggle state of radiobtnContour</span>
1488 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles)
1489 
1490 <span class="comment">% --- Executes on button press in radiobtnDose.</span>
1491 <a name="_sub21" href="#_subfunctions" class="code">function radiobtnDose_Callback(~, ~, handles)</a>
1492 <span class="comment">% hObject    handle to radiobtnDose (see GCBO)</span>
1493 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
1494 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
1495 
1496 <span class="comment">% Hint: get(hObject,'Value') returns toggle state of radiobtnDose</span>
1497 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles)
1498 
1499 <span class="comment">% --- Executes on button press in radiobtnIsoDoseLines.</span>
1500 <a name="_sub22" href="#_subfunctions" class="code">function radiobtnIsoDoseLines_Callback(~, ~, handles)</a>
1501 <span class="comment">% hObject    handle to radiobtnIsoDoseLines (see GCBO)</span>
1502 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
1503 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
1504 
1505 <span class="comment">% Hint: get(hObject,'Value') returns toggle state of radiobtnIsoDoseLines</span>
1506 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles)
1507 
1508 <span class="comment">% --- Executes on button press in btnOptimize.</span>
1509 <a name="_sub23" href="#_subfunctions" class="code">function btnOptimize_Callback(hObject, eventdata, handles)</a>
1510 <span class="comment">% hObject    handle to btnOptimize (see GCBO)</span>
1511 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
1512 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
1513 
1514 <span class="keyword">try</span>
1515     <span class="comment">% indicate that matRad is busy</span>
1516     <span class="comment">% change mouse pointer to hour glass</span>
1517     Figures = gcf;<span class="comment">%findobj('type','figure');</span>
1518     set(Figures, <span class="string">'pointer'</span>, <span class="string">'watch'</span>); 
1519     drawnow;
1520     <span class="comment">% disable all active objects</span>
1521     InterfaceObj = findobj(Figures,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1522     set(InterfaceObj,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1523     <span class="comment">% wait until the table is updated</span>
1524     <a href="#_sub31" class="code" title="subfunction btnTableSave_Callback(~, ~, handles)">btnTableSave_Callback</a>([],[],handles); <span class="comment">%We don't need it?</span>
1525 
1526 
1527     <span class="comment">% if a critical change to the cst has been made which affects the dij matrix</span>
1528     <span class="keyword">if</span> handles.DijCalcWarning == true
1529 
1530         choice = questdlg(<span class="string">'Overlap priorites of OAR constraints have been edited, a new OAR VOI was added or a critical row constraint was deleted. A new Dij calculation might be necessary.'</span>, <span class="keyword">...</span>
1531         <span class="string">'Title'</span>,<span class="string">'Cancel'</span>,<span class="string">'Calculate Dij then Optimize'</span>,<span class="string">'Optimze directly'</span>,<span class="string">'Optimze directly'</span>);
1532 
1533         <span class="keyword">switch</span> choice
1534             <span class="keyword">case</span> <span class="string">'Cancel'</span>
1535                 set(Figures, <span class="string">'pointer'</span>, <span class="string">'arrow'</span>);
1536                 set(InterfaceObj,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1537                 guidata(hObject,handles);
1538                 <span class="keyword">return</span>;
1539             <span class="keyword">case</span> <span class="string">'Calculate dij again and optimize'</span>
1540                 handles.DijCalcWarning = false;
1541                 <a href="#_sub15" class="code" title="subfunction btnCalcDose_Callback(hObject, ~, handles)">btnCalcDose_Callback</a>(hObject, eventdata, handles)      
1542             <span class="keyword">case</span> <span class="string">'Optimze directly'</span>
1543                 handles.DijCalcWarning = false;       
1544         <span class="keyword">end</span>
1545     <span class="keyword">end</span>
1546     
1547     pln = evalin(<span class="string">'base'</span>,<span class="string">'pln'</span>);
1548     ct  = evalin(<span class="string">'base'</span>,<span class="string">'ct'</span>);
1549     
1550     <span class="comment">% optimize</span>
1551     <span class="keyword">if</span> get(handles.radiobutton3Dconf,<span class="string">'Value'</span>) &amp;&amp; strcmp(handles.Modalities{get(handles.popupRadMode,<span class="string">'Value'</span>)},<span class="string">'photons'</span>)
1552         <span class="comment">% conformal plan if photons and 3d conformal</span>
1553         <span class="keyword">if</span> ~<a href="#_sub125" class="code" title="subfunction x = matRad_checkForConnectedBixelRows(stf)">matRad_checkForConnectedBixelRows</a>(evalin(<span class="string">'base'</span>,<span class="string">'stf'</span>))
1554             error(<span class="string">'disconnetced dose influence data in BEV - run dose calculation again with consistent settings'</span>);
1555         <span class="keyword">end</span>
1556         [resultGUIcurrentRun,usedOptimizer] = <a href="matRad_fluenceOptimization.html" class="code" title="function [resultGUI,optimizer] = matRad_fluenceOptimization(dij,cst,pln)">matRad_fluenceOptimization</a>(<a href="../matRad/optimization/matRad_collapseDij.html" class="code" title="function dijNew = matRad_collapseDij(dij)">matRad_collapseDij</a>(evalin(<span class="string">'base'</span>,<span class="string">'dij'</span>)),evalin(<span class="string">'base'</span>,<span class="string">'cst'</span>),pln);
1557         resultGUIcurrentRun.w = resultGUIcurrentRun.w * ones(evalin(<span class="string">'base'</span>,<span class="string">'dij.totalNumOfBixels'</span>),1);
1558         resultGUIcurrentRun.wUnsequenced = resultGUIcurrentRun.w;
1559     <span class="keyword">else</span>
1560         <span class="keyword">if</span> pln.propOpt.runDAO
1561         <span class="keyword">if</span> ~<a href="#_sub125" class="code" title="subfunction x = matRad_checkForConnectedBixelRows(stf)">matRad_checkForConnectedBixelRows</a>(evalin(<span class="string">'base'</span>,<span class="string">'stf'</span>))
1562             error(<span class="string">'disconnetced dose influence data in BEV - run dose calculation again with consistent settings'</span>);
1563         <span class="keyword">end</span>
1564         <span class="keyword">end</span>
1565         
1566         [resultGUIcurrentRun,usedOptimizer] = <a href="matRad_fluenceOptimization.html" class="code" title="function [resultGUI,optimizer] = matRad_fluenceOptimization(dij,cst,pln)">matRad_fluenceOptimization</a>(evalin(<span class="string">'base'</span>,<span class="string">'dij'</span>),evalin(<span class="string">'base'</span>,<span class="string">'cst'</span>),pln);
1567     <span class="keyword">end</span>
1568     
1569     <span class="comment">%if resultGUI already exists then overwrite the &quot;standard&quot; fields</span>
1570     AllVarNames = evalin(<span class="string">'base'</span>,<span class="string">'who'</span>);
1571     <span class="keyword">if</span>  ismember(<span class="string">'resultGUI'</span>,AllVarNames)
1572         resultGUI = evalin(<span class="string">'base'</span>,<span class="string">'resultGUI'</span>);
1573         sNames = fieldnames(resultGUIcurrentRun);
1574         oldNames = fieldnames(resultGUI);
1575         <span class="keyword">if</span>(length(oldNames) &gt; length(sNames))
1576             <span class="keyword">for</span> j = 1:length(oldNames)
1577             <span class="keyword">if</span> strfind(oldNames{j}, <span class="string">'beam'</span>)
1578                 resultGUI = rmfield(resultGUI, oldNames{j});
1579             <span class="keyword">end</span>
1580             <span class="keyword">end</span>
1581         <span class="keyword">end</span>
1582         <span class="keyword">for</span> j = 1:length(sNames)
1583             resultGUI.(sNames{j}) = resultGUIcurrentRun.(sNames{j});
1584         <span class="keyword">end</span>
1585     <span class="keyword">else</span>
1586         resultGUI = resultGUIcurrentRun;
1587     <span class="keyword">end</span>
1588     assignin(<span class="string">'base'</span>,<span class="string">'resultGUI'</span>,resultGUI);
1589 
1590     <span class="comment">% set some values</span>
1591     <span class="keyword">if</span> handles.plane == 1
1592         set(handles.sliderSlice,<span class="string">'Value'</span>,ceil(pln.propStf.isoCenter(1,2)/ct.resolution.x));
1593     <span class="keyword">elseif</span> handles.plane == 2
1594         set(handles.sliderSlice,<span class="string">'Value'</span>,ceil(pln.propStf.isoCenter(1,1)/ct.resolution.y));
1595     <span class="keyword">elseif</span> handles.plane == 3
1596         set(handles.sliderSlice,<span class="string">'Value'</span>,ceil(pln.propStf.isoCenter(1,3)/ct.resolution.z));
1597     <span class="keyword">end</span>
1598 
1599     handles.State = 3;
1600     handles.SelectedDisplayOptionIdx = 1;
1601     <span class="keyword">if</span> strcmp(pln.radiationMode,<span class="string">'carbon'</span>) || (strcmp(pln.radiationMode,<span class="string">'protons'</span>) &amp;&amp; strcmp(pln.propOpt.bioOptimization,<span class="string">'const_RBExD'</span>))
1602         handles.SelectedDisplayOption = <span class="string">'RBExDose'</span>;
1603     <span class="keyword">else</span>
1604         handles.SelectedDisplayOption = <span class="string">'physicalDose'</span>;
1605     <span class="keyword">end</span>
1606     handles.selectedBeam = 1;
1607     <span class="comment">% check IPOPT status and return message for GUI user if no DAO or</span>
1608     <span class="comment">% particles</span>
1609     <span class="keyword">if</span> ~pln.propOpt.runDAO || ~strcmp(pln.radiationMode,<span class="string">'photons'</span>)
1610         <a href="#_sub35" class="code" title="subfunction CheckOptimizerStatus(usedOptimizer,OptCase)">CheckOptimizerStatus</a>(usedOptimizer,<span class="string">'Fluence'</span>)
1611     <span class="keyword">end</span>
1612     
1613 <span class="keyword">catch</span> ME
1614     handles = <a href="#_sub38" class="code" title="subfunction handles = showError(handles,Message,ME)">showError</a>(handles,<span class="string">'OptimizeCallback: Could not optimize!'</span>,ME); 
1615     <span class="comment">% change state from busy to normal</span>
1616     set(Figures, <span class="string">'pointer'</span>, <span class="string">'arrow'</span>);
1617     set(InterfaceObj,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1618     guidata(hObject,handles);
1619     <span class="keyword">return</span>;
1620 <span class="keyword">end</span>
1621 
1622 <span class="comment">% perform sequencing and DAO</span>
1623 <span class="keyword">try</span>
1624     
1625     <span class="comment">%% sequencing</span>
1626     <span class="keyword">if</span> strcmp(pln.radiationMode,<span class="string">'photons'</span>) &amp;&amp; (pln.propOpt.runSequencing || pln.propOpt.runDAO)
1627     <span class="comment">%   resultGUI = matRad_xiaLeafSequencing(resultGUI,evalin('base','stf'),evalin('base','dij')...</span>
1628     <span class="comment">%       ,get(handles.editSequencingLevel,'Value'));</span>
1629     <span class="comment">%   resultGUI = matRad_engelLeafSequencing(resultGUI,evalin('base','stf'),evalin('base','dij')...</span>
1630     <span class="comment">%       ,str2double(get(handles.editSequencingLevel,'String')));</span>
1631         resultGUI = <a href="matRad_siochiLeafSequencing.html" class="code" title="function resultGUI = matRad_siochiLeafSequencing(resultGUI,stf,dij,numOfLevels,visBool)">matRad_siochiLeafSequencing</a>(resultGUI,evalin(<span class="string">'base'</span>,<span class="string">'stf'</span>),evalin(<span class="string">'base'</span>,<span class="string">'dij'</span>)<span class="keyword">...</span>
1632             ,str2double(get(handles.editSequencingLevel,<span class="string">'String'</span>)));
1633         
1634         assignin(<span class="string">'base'</span>,<span class="string">'resultGUI'</span>,resultGUI);
1635     <span class="keyword">end</span>
1636         
1637 <span class="keyword">catch</span> ME
1638     handles = <a href="#_sub38" class="code" title="subfunction handles = showError(handles,Message,ME)">showError</a>(handles,<span class="string">'OptimizeCallback: Could not perform sequencing'</span>,ME); 
1639     <span class="comment">% change state from busy to normal</span>
1640     set(Figures, <span class="string">'pointer'</span>, <span class="string">'arrow'</span>);
1641     set(InterfaceObj,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1642     guidata(hObject,handles);
1643     <span class="keyword">return</span>;
1644 <span class="keyword">end</span>
1645 
1646 <span class="keyword">try</span>
1647     <span class="comment">%% DAO</span>
1648     <span class="keyword">if</span> strcmp(pln.radiationMode,<span class="string">'photons'</span>) &amp;&amp; pln.propOpt.runDAO
1649         handles = <a href="#_sub39" class="code" title="subfunction handles = showWarning(handles,Message,ME)">showWarning</a>(handles,[<span class="string">'Observe: You are running direct aperture optimization'</span> filesep <span class="string">'This is experimental code that has not been thoroughly debugged - especially in combination with constrained optimization.'</span>]);
1650        [resultGUI,usedOptimizer] = <a href="matRad_directApertureOptimization.html" class="code" title="function [optResult,optimizer] = matRad_directApertureOptimization(dij,cst,apertureInfo,optResult,pln)">matRad_directApertureOptimization</a>(evalin(<span class="string">'base'</span>,<span class="string">'dij'</span>),evalin(<span class="string">'base'</span>,<span class="string">'cst'</span>),<span class="keyword">...</span>
1651            resultGUI.apertureInfo,resultGUI,pln);
1652        assignin(<span class="string">'base'</span>,<span class="string">'resultGUI'</span>,resultGUI);
1653        <span class="comment">% check IPOPT status and return message for GUI user</span>
1654        <a href="#_sub35" class="code" title="subfunction CheckOptimizerStatus(usedOptimizer,OptCase)">CheckOptimizerStatus</a>(usedOptimizer,<span class="string">'DAO'</span>);      
1655     <span class="keyword">end</span>
1656     
1657     <span class="keyword">if</span> strcmp(pln.radiationMode,<span class="string">'photons'</span>) &amp;&amp; (pln.propOpt.runSequencing || pln.propOpt.runDAO)
1658         <a href="matRad_visApertureInfo.html" class="code" title="function matRad_visApertureInfo(apertureInfo,mode)">matRad_visApertureInfo</a>(resultGUI.apertureInfo);
1659     <span class="keyword">end</span>
1660    
1661 <span class="keyword">catch</span> ME
1662     handles = <a href="#_sub38" class="code" title="subfunction handles = showError(handles,Message,ME)">showError</a>(handles,<span class="string">'OptimizeCallback: Could not perform direct aperture optimization'</span>,ME); 
1663     <span class="comment">% change state from busy to normal</span>
1664     set(Figures, <span class="string">'pointer'</span>, <span class="string">'arrow'</span>);
1665     set(InterfaceObj,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1666     guidata(hObject,handles);
1667     <span class="keyword">return</span>;
1668 <span class="keyword">end</span>
1669 
1670 <span class="comment">% change state from busy to normal</span>
1671 set(Figures, <span class="string">'pointer'</span>, <span class="string">'arrow'</span>);
1672 set(InterfaceObj,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1673 handles.dispWindow{3,1}  = [];   <span class="comment">% reset dose ranges</span>
1674 handles.dispWindow{3,2}  = [];   <span class="comment">% reset min max dose values</span>
1675 handles.rememberCurrAxes = false;
1676 handles.IsoDose.Levels   = 0;  <span class="comment">% ensure to use default iso dose line spacing</span>
1677 handles.cBarChanged      = true;
1678     
1679 guidata(hObject,handles);
1680 handles = <a href="#_sub64" class="code" title="subfunction handles = updateIsoDoseLineCache(handles)">updateIsoDoseLineCache</a>(handles);
1681 <a href="#_sub29" class="code" title="subfunction UpdateState(handles)">UpdateState</a>(handles);
1682 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles);
1683 handles.rememberCurrAxes = true;   
1684 guidata(hObject,handles);
1685 
1686 
1687 <span class="comment">% the function CheckValidityPln checks if the provided plan is valid so</span>
1688 <span class="comment">% that it can be used further on for optimization</span>
1689 <a name="_sub24" href="#_subfunctions" class="code">function FlagValid = CheckValidityPln(cst)</a>
1690 
1691 FlagValid = true;
1692 <span class="comment">%check if mean constraint is always used in combination</span>
1693 <span class="keyword">for</span> i = 1:size(cst,1)
1694    <span class="keyword">if</span> ~isempty(cst{i,6})
1695         <span class="keyword">if</span> ~isempty(strfind([cst{i,6}.type],<span class="string">'mean'</span>)) &amp;&amp; isempty(strfind([cst{i,6}.type],<span class="string">'square'</span>))
1696              FlagValid = false;
1697              warndlg(<span class="string">'mean constraint needs to be defined in addition to a second constraint (e.g. squared deviation)'</span>);
1698              <span class="keyword">break</span>      
1699         <span class="keyword">end</span>
1700    <span class="keyword">end</span>
1701 <span class="keyword">end</span>
1702 
1703 
1704 <span class="comment">% --- Executes on selection change in popupTypeOfPlot</span>
1705 <a name="_sub25" href="#_subfunctions" class="code">function popupTypeOfPlot_Callback(hObject, ~, handles)</a>
1706 
1707  <span class="comment">% intensity plot</span>
1708 <span class="keyword">if</span> get(hObject,<span class="string">'Value'</span>) == 1  
1709     
1710     set(handles.sliderBeamSelection,<span class="string">'Enable'</span>,<span class="string">'off'</span>)
1711     set(handles.sliderOffset,<span class="string">'Enable'</span>,<span class="string">'off'</span>)
1712     set(handles.popupDisplayOption,<span class="string">'Enable'</span>,<span class="string">'on'</span>)
1713     set(handles.btnProfileType,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1714     set(handles.popupPlane,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1715     set(handles.radiobtnCT,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1716     set(handles.radiobtnContour,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1717     set(handles.radiobtnDose,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1718     set(handles.radiobtnIsoDoseLines,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1719     set(handles.radiobtnIsoDoseLinesLabels,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1720     set(handles.sliderSlice,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1721     
1722 <span class="comment">% profile plot</span>
1723 <span class="keyword">elseif</span> get(hObject,<span class="string">'Value'</span>) == 2
1724     
1725     <span class="keyword">if</span> handles.State &gt; 0
1726         <span class="keyword">if</span> length(<a href="#_sub37" class="code" title="subfunction number = parseStringAsNum(stringIn,isVector)">parseStringAsNum</a>(get(handles.editGantryAngle,<span class="string">'String'</span>),true)) &gt; 1
1727             
1728             set(handles.sliderBeamSelection,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1729             handles.selectedBeam = 1;
1730             pln = evalin(<span class="string">'base'</span>,<span class="string">'pln'</span>);
1731             set(handles.sliderBeamSelection,<span class="string">'Min'</span>,handles.selectedBeam,<span class="string">'Max'</span>,pln.propStf.numOfBeams,<span class="keyword">...</span>
1732                 <span class="string">'Value'</span>,handles.selectedBeam,<span class="keyword">...</span>
1733                 <span class="string">'SliderStep'</span>,[1/(pln.propStf.numOfBeams-1) 1/(pln.propStf.numOfBeams-1)],<span class="keyword">...</span>
1734                 <span class="string">'Enable'</span>,<span class="string">'on'</span>);
1735 
1736         <span class="keyword">else</span>
1737             handles.selectedBeam = 1;
1738         <span class="keyword">end</span>
1739     
1740         handles.profileOffset = get(handles.sliderOffset,<span class="string">'Value'</span>);
1741 
1742         vMinMax = [-100 100];
1743         vRange = sum(abs(vMinMax));
1744 
1745         ct = evalin(<span class="string">'base'</span>,<span class="string">'ct'</span>);
1746         <span class="keyword">if</span> strcmp(get(handles.btnProfileType,<span class="string">'String'</span>),<span class="string">'lateral'</span>)
1747             SliderStep = vRange/ct.resolution.x;       
1748         <span class="keyword">else</span>
1749             SliderStep = vRange/ct.resolution.y;  
1750         <span class="keyword">end</span>
1751         
1752         set(handles.sliderOffset,<span class="string">'Min'</span>,vMinMax(1),<span class="string">'Max'</span>,vMinMax(2),<span class="keyword">...</span>
1753                     <span class="string">'Value'</span>,handles.profileOffset,<span class="keyword">...</span>
1754                     <span class="string">'SliderStep'</span>,[1/SliderStep 1/SliderStep],<span class="keyword">...</span>
1755                     <span class="string">'Enable'</span>,<span class="string">'on'</span>);
1756     <span class="keyword">end</span>
1757     
1758     
1759     set(handles.popupDisplayOption,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1760     set(handles.btnProfileType,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1761     set(handles.popupPlane,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1762     set(handles.radiobtnCT,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1763     set(handles.radiobtnContour,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1764     set(handles.radiobtnDose,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1765     set(handles.radiobtnIsoDoseLines,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1766     set(handles.sliderSlice,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1767     set(handles.radiobtnIsoDoseLinesLabels,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1768     
1769     
1770     set(handles.btnProfileType,<span class="string">'Enable'</span>,<span class="string">'on'</span>)
1771     
1772     <span class="keyword">if</span> strcmp(get(handles.btnProfileType,<span class="string">'String'</span>),<span class="string">'lateral'</span>)
1773         handles.ProfileType = <span class="string">'longitudinal'</span>;
1774     <span class="keyword">else</span>
1775         handles.ProfileType = <span class="string">'lateral'</span>;
1776     <span class="keyword">end</span>
1777     
1778 <span class="keyword">end</span>
1779 
1780 handles.cBarChanged = true;
1781 
1782 handles.rememberCurrAxes = false;
1783 cla(handles.axesFig,<span class="string">'reset'</span>);
1784 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles);
1785 handles.rememberCurrAxes = true;
1786 guidata(hObject, handles);
1787 
1788 <span class="comment">% --- Executes on selection change in popupDisplayOption.</span>
1789 <a name="_sub26" href="#_subfunctions" class="code">function popupDisplayOption_Callback(hObject, ~, handles)</a>
1790 content = get(hObject,<span class="string">'String'</span>);
1791 handles.SelectedDisplayOption = content{get(hObject,<span class="string">'Value'</span>),1};
1792 handles.SelectedDisplayOptionIdx = get(hObject,<span class="string">'Value'</span>);
1793 <span class="comment">%handles.dispWindow{3,1} = []; handles.dispWindow{3,2} = [];</span>
1794 
1795 <span class="keyword">if</span> ~isfield(handles,<span class="string">'colormapLocked'</span>) || ~handles.colormapLocked
1796     handles.dispWindow{3,1} = []; handles.dispWindow{3,2} = [];
1797 <span class="keyword">end</span>
1798 
1799 handles = <a href="#_sub64" class="code" title="subfunction handles = updateIsoDoseLineCache(handles)">updateIsoDoseLineCache</a>(handles);
1800 handles.cBarChanged = true;
1801 guidata(hObject, handles);
1802 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles);
1803 guidata(hObject, handles);
1804 
1805 <span class="comment">% --- Executes on slider movement.</span>
1806 <a name="_sub27" href="#_subfunctions" class="code">function sliderBeamSelection_Callback(hObject, ~, handles)</a>
1807 <span class="comment">% hObject    handle to sliderBeamSelection (see GCBO)</span>
1808 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
1809 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
1810 
1811 <span class="comment">% Hints: get(hObject,'Value') returns position of slider</span>
1812 <span class="comment">%        get(hObject,'Min') and get(hObject,'Max') to determine range of slider</span>
1813 
1814 
1815 handles.selectedBeam = round(get(hObject,<span class="string">'Value'</span>));
1816 set(hObject, <span class="string">'Value'</span>, handles.selectedBeam);
1817 handles.rememberCurrAxes = false;
1818 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles);
1819 handles.rememberCurrAxes = true;
1820 guidata(hObject,handles);
1821 
1822 <span class="comment">% --- Executes on button press in btnProfileType.</span>
1823 <a name="_sub28" href="#_subfunctions" class="code">function btnProfileType_Callback(hObject, ~, handles)</a>
1824 <span class="comment">% hObject    handle to btnProfileType (see GCBO)</span>
1825 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
1826 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
1827 <span class="keyword">if</span> strcmp(get(hObject,<span class="string">'Enable'</span>) ,<span class="string">'on'</span>)
1828     <span class="keyword">if</span> strcmp(handles.ProfileType,<span class="string">'lateral'</span>)
1829             handles.ProfileType = <span class="string">'longitudinal'</span>;
1830              set(hObject,<span class="string">'String'</span>,<span class="string">'lateral'</span>);
1831         <span class="keyword">else</span>
1832             handles.ProfileType = <span class="string">'lateral'</span>;
1833             set(hObject,<span class="string">'String'</span>,<span class="string">'longitudinal'</span>);
1834     <span class="keyword">end</span>
1835     
1836     handles.rememberCurrAxes = false;
1837     <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles);
1838     handles.rememberCurrAxes = true;
1839 
1840     guidata(hObject, handles);
1841  
1842 <span class="keyword">end</span>
1843 
1844 <span class="comment">% enables/ disables buttons according to the current state</span>
1845 <a name="_sub29" href="#_subfunctions" class="code">function UpdateState(handles)</a>
1846 
1847 <span class="keyword">if</span> handles.State &gt; 0
1848     pln = evalin(<span class="string">'base'</span>,<span class="string">'pln'</span>);
1849 
1850     <span class="keyword">if</span> strcmp(pln.radiationMode,<span class="string">'carbon'</span>)
1851         set(handles.popMenuBioOpt,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1852         set(handles.btnSetTissue,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1853     <span class="keyword">elseif</span> strcmp(pln.radiationMode,<span class="string">'protons'</span>)
1854         set(handles.popMenuBioOpt,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1855         set(handles.btnSetTissue,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1856     <span class="keyword">else</span>
1857         set(handles.popMenuBioOpt,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1858         set(handles.btnSetTissue,<span class="string">'Enable'</span>,<span class="string">'off'</span>); 
1859     <span class="keyword">end</span>
1860     
1861     cMapControls = allchild(handles.uipanel_colormapOptions);
1862     <span class="keyword">for</span> runHandles = cMapControls
1863         set(runHandles,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1864     <span class="keyword">end</span>
1865 <span class="keyword">end</span> 
1866 
1867 <span class="keyword">if</span> handles.cubeHUavailable
1868     cMapOptionsSelectList = {<span class="string">'None'</span>,<span class="string">'CT (HU)'</span>,<span class="string">'Result (i.e. dose)'</span>};
1869     set(handles.popupmenu_windowPreset,<span class="string">'Visible'</span>,<span class="string">'on'</span>);
1870     set(handles.text_windowPreset,<span class="string">'String'</span>,<span class="string">'Window Preset'</span>);
1871 <span class="keyword">else</span>
1872     cMapOptionsSelectList = {<span class="string">'None'</span>,<span class="string">'CT (ED)'</span>,<span class="string">'Result (i.e. dose)'</span>};
1873     set(handles.popupmenu_windowPreset,<span class="string">'Visible'</span>,<span class="string">'off'</span>);
1874     set(handles.text_windowPreset,<span class="string">'String'</span>,<span class="string">'No available Window Presets'</span>);
1875 <span class="keyword">end</span>
1876 handles.cBarChanged = true;
1877 
1878  <span class="keyword">switch</span> handles.State
1879      
1880      <span class="keyword">case</span> 0
1881       
1882       set(handles.txtInfo,<span class="string">'String'</span>,<span class="string">'no data loaded'</span>);
1883       set(handles.btnCalcDose,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1884       set(handles.btnOptimize ,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1885       set(handles.pushbutton_recalc,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1886       set(handles.btnSaveToGUI,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1887       set(handles.btnDVH,<span class="string">'Enable'</span>,<span class="string">'off'</span>); 
1888       set(handles.importDoseButton,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1889       set(handles.btn_export,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1890       set(handles.btn3Dview,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1891       
1892       cMapControls = allchild(handles.uipanel_colormapOptions);
1893       <span class="keyword">for</span> runHandles = cMapControls
1894           set(runHandles,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1895       <span class="keyword">end</span>
1896       
1897       set(handles.popupmenu_chooseColorData,<span class="string">'String'</span>,cMapOptionsSelectList{1})
1898       set(handles.popupmenu_chooseColorData,<span class="string">'Value'</span>,1);
1899       
1900      <span class="keyword">case</span> 1
1901      
1902       set(handles.txtInfo,<span class="string">'String'</span>,<span class="string">'ready for dose calculation'</span>);
1903       set(handles.btnCalcDose,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1904       set(handles.btnOptimize ,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1905       set(handles.pushbutton_recalc,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1906       set(handles.btnSaveToGUI,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1907       set(handles.btnDVH,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1908       set(handles.importDoseButton,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1909       set(handles.btn_export,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1910       set(handles.btn3Dview,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1911       
1912       set(handles.popupmenu_chooseColorData,<span class="string">'String'</span>,cMapOptionsSelectList(1:2))
1913       set(handles.popupmenu_chooseColorData,<span class="string">'Value'</span>,2);
1914       AllVarNames = evalin(<span class="string">'base'</span>,<span class="string">'who'</span>);
1915       <span class="keyword">if</span> ~isempty(AllVarNames)
1916             <span class="keyword">if</span>  ismember(<span class="string">'resultGUI'</span>,AllVarNames)
1917               set(handles.pushbutton_recalc,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1918               set(handles.btnSaveToGUI,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1919               set(handles.btnDVH,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1920               set(handles.popupmenu_chooseColorData,<span class="string">'String'</span>,cMapOptionsSelectList(1:3))
1921               set(handles.popupmenu_chooseColorData,<span class="string">'Value'</span>,3);
1922             <span class="keyword">end</span>
1923       <span class="keyword">end</span>
1924 
1925      <span class="keyword">case</span> 2
1926     
1927       set(handles.txtInfo,<span class="string">'String'</span>,<span class="string">'ready for optimization'</span>);   
1928       set(handles.btnCalcDose,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1929       set(handles.btnOptimize ,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1930       set(handles.pushbutton_recalc,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1931       set(handles.btnSaveToGUI,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1932       set(handles.btnDVH,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1933       set(handles.importDoseButton,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1934       set(handles.btn_export,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1935       set(handles.btn3Dview,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1936       set(handles.popupmenu_chooseColorData,<span class="string">'String'</span>,cMapOptionsSelectList(1:2))
1937       set(handles.popupmenu_chooseColorData,<span class="string">'Value'</span>,2);
1938       AllVarNames = evalin(<span class="string">'base'</span>,<span class="string">'who'</span>);
1939       
1940       <span class="keyword">if</span> ~isempty(AllVarNames)
1941             <span class="keyword">if</span>  ismember(<span class="string">'resultGUI'</span>,AllVarNames)
1942               set(handles.pushbutton_recalc,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1943               set(handles.btnSaveToGUI,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1944               set(handles.btnDVH,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1945               set(handles.popupmenu_chooseColorData,<span class="string">'String'</span>,cMapOptionsSelectList(1:3))
1946               set(handles.popupmenu_chooseColorData,<span class="string">'Value'</span>,3);
1947             <span class="keyword">end</span>
1948       <span class="keyword">end</span>
1949       
1950      <span class="keyword">case</span> 3
1951       set(handles.txtInfo,<span class="string">'String'</span>,<span class="string">'plan is optimized'</span>);   
1952       set(handles.btnCalcDose,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1953       set(handles.btnOptimize ,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1954       set(handles.pushbutton_recalc,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1955       set(handles.btnSaveToGUI,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1956       set(handles.btnDVH,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1957       set(handles.btn_export,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1958       set(handles.btn3Dview,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1959       <span class="comment">% resultGUI struct needs to be available to import dose</span>
1960       <span class="comment">% otherwise inconsistent states can be achieved</span>
1961       set(handles.importDoseButton,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1962       set(handles.popupmenu_chooseColorData,<span class="string">'String'</span>,cMapOptionsSelectList(1:3))
1963       set(handles.popupmenu_chooseColorData,<span class="string">'Value'</span>,3);
1964  <span class="keyword">end</span>
1965 
1966 guidata(handles.figure1,handles); 
1967  
1968 <span class="comment">% fill GUI elements with plan information</span>
1969 <a name="_sub30" href="#_subfunctions" class="code">function setPln(handles)</a>
1970 pln = evalin(<span class="string">'base'</span>,<span class="string">'pln'</span>);
1971 <span class="comment">% sanity check of isoCenter</span>
1972 <span class="keyword">if</span> size(pln.propStf.isoCenter,1) ~= pln.propStf.numOfBeams &amp;&amp; size(pln.propStf.isoCenter,1) == 1
1973   pln.propStf.isoCenter = ones(pln.propStf.numOfBeams,1) * pln.propStf.isoCenter(1,:);
1974 <span class="keyword">elseif</span> size(pln.propStf.isoCenter,1) ~= pln.propStf.numOfBeams &amp;&amp; size(pln.propStf.isoCenter,1) ~= 1
1975   error(<span class="string">'Isocenter in plan file are incosistent.'</span>);
1976 <span class="keyword">end</span>
1977 set(handles.editBixelWidth,<span class="string">'String'</span>,num2str(pln.propStf.bixelWidth));
1978 set(handles.editFraction,<span class="string">'String'</span>,num2str(pln.numOfFractions));
1979 
1980 <span class="keyword">if</span> isfield(pln.propStf,<span class="string">'isoCenter'</span>)
1981     <span class="keyword">if</span> size(unique(pln.propStf.isoCenter,<span class="string">'rows'</span>),1) == 1
1982         set(handles.editIsoCenter,<span class="string">'String'</span>,regexprep(num2str((round(pln.propStf.isoCenter(1,:)*10))./10), <span class="string">'\s+'</span>, <span class="string">' '</span>));
1983         set(handles.editIsoCenter,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1984         set(handles.checkIsoCenter,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1985     <span class="keyword">else</span>
1986         set(handles.editIsoCenter,<span class="string">'String'</span>,<span class="string">'multiple isoCenter'</span>);
1987         set(handles.editIsoCenter,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1988         set(handles.checkIsoCenter,<span class="string">'Value'</span>,0);
1989         set(handles.checkIsoCenter,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1990     <span class="keyword">end</span>
1991 <span class="keyword">end</span>
1992 set(handles.editGantryAngle,<span class="string">'String'</span>,num2str((pln.propStf.gantryAngles)));
1993 set(handles.editCouchAngle,<span class="string">'String'</span>,num2str((pln.propStf.couchAngles)));
1994 set(handles.popupRadMode,<span class="string">'Value'</span>,find(strcmp(get(handles.popupRadMode,<span class="string">'String'</span>),pln.radiationMode)));
1995 set(handles.popUpMachine,<span class="string">'Value'</span>,find(strcmp(get(handles.popUpMachine,<span class="string">'String'</span>),pln.machine)));
1996 
1997 <span class="keyword">if</span> ~strcmp(pln.propOpt.bioOptimization,<span class="string">'none'</span>)  
1998     set(handles.popMenuBioOpt,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1999     contentPopUp = get(handles.popMenuBioOpt,<span class="string">'String'</span>);
2000     ix = find(strcmp(pln.propOpt.bioOptimization,contentPopUp));
2001     set(handles.popMenuBioOpt,<span class="string">'Value'</span>,ix);
2002     set(handles.btnSetTissue,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2003 <span class="keyword">else</span>
2004     set(handles.popMenuBioOpt,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2005     set(handles.btnSetTissue,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2006 <span class="keyword">end</span>
2007 <span class="comment">%% enable sequencing and DAO button if radiation mode is set to photons</span>
2008 <span class="keyword">if</span> strcmp(pln.radiationMode,<span class="string">'photons'</span>) &amp;&amp; pln.propOpt.runSequencing
2009     set(handles.btnRunSequencing,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2010     set(handles.btnRunSequencing,<span class="string">'Value'</span>,1);
2011 <span class="keyword">elseif</span> strcmp(pln.radiationMode,<span class="string">'photons'</span>) &amp;&amp; ~pln.propOpt.runSequencing
2012     set(handles.btnRunSequencing,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2013     set(handles.btnRunSequencing,<span class="string">'Value'</span>,0);
2014 <span class="keyword">else</span>
2015     set(handles.btnRunSequencing,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2016 <span class="keyword">end</span>
2017 <span class="comment">%% enable DAO button if radiation mode is set to photons</span>
2018 <span class="keyword">if</span> strcmp(pln.radiationMode,<span class="string">'photons'</span>) &amp;&amp; pln.propOpt.runDAO
2019     set(handles.btnRunDAO,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2020     set(handles.btnRunDAO,<span class="string">'Value'</span>,1);
2021 <span class="keyword">elseif</span> strcmp(pln.radiationMode,<span class="string">'photons'</span>) &amp;&amp; ~pln.propOpt.runDAO
2022     set(handles.btnRunDAO,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2023     set(handles.btnRunDAO,<span class="string">'Value'</span>,0);
2024 <span class="keyword">else</span>
2025     set(handles.btnRunDAO,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2026 <span class="keyword">end</span>
2027 <span class="comment">%% enable stratification level input if radiation mode is set to photons</span>
2028 <span class="keyword">if</span> strcmp(pln.radiationMode,<span class="string">'photons'</span>)
2029     set(handles.txtSequencing,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2030     set(handles.radiobutton3Dconf,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2031     set(handles.editSequencingLevel,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2032 <span class="keyword">else</span>
2033     set(handles.txtSequencing,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2034     set(handles.radiobutton3Dconf,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2035     set(handles.editSequencingLevel,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2036 <span class="keyword">end</span>
2037 
2038 <span class="comment">% --- Executes on button press in btnTableSave.</span>
2039 <a name="_sub31" href="#_subfunctions" class="code">function btnTableSave_Callback(~, ~, handles)</a>
2040 <span class="comment">% hObject    handle to btnTableSave (see GCBO)</span>
2041 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
2042 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
2043 
2044 <span class="keyword">if</span> get(handles.checkIsoCenter,<span class="string">'Value'</span>)
2045     pln = evalin(<span class="string">'base'</span>,<span class="string">'pln'</span>); 
2046     pln.propStf.isoCenter = ones(pln.propStf.numOfBeams,1) * <a href="matRad_getIsoCenter.html" class="code" title="function isoCenter = matRad_getIsoCenter(cst,ct,visBool)">matRad_getIsoCenter</a>(evalin(<span class="string">'base'</span>,<span class="string">'cst'</span>),evalin(<span class="string">'base'</span>,<span class="string">'ct'</span>)); 
2047     set(handles.editIsoCenter,<span class="string">'String'</span>,regexprep(num2str((round(pln.propStf.isoCenter(1,:) * 10))./10), <span class="string">'\s+'</span>, <span class="string">' '</span>));
2048     assignin(<span class="string">'base'</span>,<span class="string">'pln'</span>,pln);
2049 <span class="keyword">end</span>
2050 <a href="#_sub36" class="code" title="subfunction getPlnFromGUI(handles)">getPlnFromGUI</a>(handles);
2051 
2052 <span class="comment">% --- Executes on selection change in listBoxCmd.</span>
2053 <a name="_sub32" href="#_subfunctions" class="code">function listBoxCmd_Callback(hObject, ~, ~)</a>
2054 numLines = size(get(hObject,<span class="string">'String'</span>),1);
2055 set(hObject, <span class="string">'ListboxTop'</span>, numLines);
2056 
2057 <span class="comment">% --- Executes on slider movement.</span>
2058 <a name="_sub33" href="#_subfunctions" class="code">function sliderOffset_Callback(hObject, ~, handles)</a>
2059 handles.profileOffset = get(hObject,<span class="string">'Value'</span>);
2060 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles);
2061 
2062  
2063 <span class="comment">%% HELPER FUNCTIONS</span>
2064 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2065 
2066 <span class="comment">% check validity of input for cst</span>
2067 <a name="_sub34" href="#_subfunctions" class="code">function flagValidity = CheckValidity(Val) </a>
2068       
2069 flagValidity = true;
2070 
2071 <span class="keyword">if</span> ischar(Val)
2072     Val = str2num(Val);
2073 <span class="keyword">end</span> 
2074 
2075 <span class="keyword">if</span> length(Val) &gt; 2
2076     warndlg(<span class="string">'invalid input!'</span>);
2077 <span class="keyword">end</span>
2078 
2079 <span class="keyword">if</span> isempty(Val)
2080    warndlg(<span class="string">'Input not a number!'</span>);
2081    flagValidity = false;        
2082 <span class="keyword">end</span>
2083 
2084 <span class="keyword">if</span> any(Val &lt; 0) 
2085    warndlg(<span class="string">'Input not a positive number!'</span>);
2086    flagValidity = false;  
2087 <span class="keyword">end</span>
2088 
2089 <span class="comment">% return IPOPT status as message box</span>
2090 <a name="_sub35" href="#_subfunctions" class="code">function CheckOptimizerStatus(usedOptimizer,OptCase) </a>
2091       
2092 [statusmsg,statusflag] = usedOptimizer.GetStatus();
2093     
2094 <span class="keyword">if</span> statusflag == 0 || statusflag == 1
2095     status = <span class="string">'none'</span>;
2096 <span class="keyword">else</span>
2097     status = <span class="string">'warn'</span>;
2098 <span class="keyword">end</span>
2099 
2100 msgbox([<span class="string">'Optimizer finished with status '</span> num2str(statusflag) <span class="string">' ('</span> statusmsg <span class="string">')'</span>],<span class="string">'Optimizer'</span>,status,<span class="string">'modal'</span>);
2101 
2102 <span class="comment">% get pln file form GUI</span>
2103 <a name="_sub36" href="#_subfunctions" class="code">function getPlnFromGUI(handles)</a>
2104 
2105 <span class="comment">% evalin pln (if existant) in order to decide whether isoCenter should be calculated</span>
2106 <span class="comment">% automatically</span>
2107 <span class="keyword">if</span> evalin(<span class="string">'base'</span>,<span class="string">'exist(''pln'',''var'')'</span>)
2108     pln = evalin(<span class="string">'base'</span>,<span class="string">'pln'</span>);
2109 <span class="keyword">end</span>
2110 
2111 pln.propStf.bixelWidth      = <a href="#_sub37" class="code" title="subfunction number = parseStringAsNum(stringIn,isVector)">parseStringAsNum</a>(get(handles.editBixelWidth,<span class="string">'String'</span>),false); <span class="comment">% [mm] / also corresponds to lateral spot spacing for particles</span>
2112 pln.propStf.gantryAngles    = <a href="#_sub37" class="code" title="subfunction number = parseStringAsNum(stringIn,isVector)">parseStringAsNum</a>(get(handles.editGantryAngle,<span class="string">'String'</span>),true); <span class="comment">% [???]</span>
2113 
2114 <span class="keyword">if</span> handles.eduMode
2115     set(handles.editCouchAngle,<span class="string">'String'</span>,num2str(zeros(size(pln.propStf.gantryAngles))));
2116 <span class="keyword">end</span>
2117 
2118 pln.propStf.couchAngles     = <a href="#_sub37" class="code" title="subfunction number = parseStringAsNum(stringIn,isVector)">parseStringAsNum</a>(get(handles.editCouchAngle,<span class="string">'String'</span>),true); <span class="comment">% [???]</span>
2119 pln.propStf.numOfBeams      = numel(pln.propStf.gantryAngles);
2120 <span class="keyword">try</span>
2121     ct = evalin(<span class="string">'base'</span>,<span class="string">'ct'</span>);
2122     pln.numOfVoxels     = prod(ct.cubeDim);
2123     pln.voxelDimensions = ct.cubeDim;
2124 <span class="keyword">catch</span>
2125 <span class="keyword">end</span>
2126 pln.numOfFractions  = <a href="#_sub37" class="code" title="subfunction number = parseStringAsNum(stringIn,isVector)">parseStringAsNum</a>(get(handles.editFraction,<span class="string">'String'</span>),false);
2127 contents            = get(handles.popupRadMode,<span class="string">'String'</span>); 
2128 pln.radiationMode   = contents{get(handles.popupRadMode,<span class="string">'Value'</span>)}; <span class="comment">% either photons / protons / carbon</span>
2129 contents            = get(handles.popUpMachine,<span class="string">'String'</span>); 
2130 pln.machine         = contents{get(handles.popUpMachine,<span class="string">'Value'</span>)}; 
2131 
2132 <span class="keyword">if</span> (~strcmp(pln.radiationMode,<span class="string">'photons'</span>))
2133     contentBioOpt = get(handles.popMenuBioOpt,<span class="string">'String'</span>);
2134     pln.propOpt.bioOptimization = contentBioOpt{get(handles.popMenuBioOpt,<span class="string">'Value'</span>),:};
2135 <span class="keyword">else</span>
2136     pln.propOpt.bioOptimization = <span class="string">'none'</span>;
2137 <span class="keyword">end</span>
2138 
2139 pln.propOpt.runSequencing = logical(get(handles.btnRunSequencing,<span class="string">'Value'</span>));
2140 pln.propOpt.runDAO = logical(get(handles.btnRunDAO,<span class="string">'Value'</span>));
2141 
2142 <span class="keyword">try</span>
2143     cst = evalin(<span class="string">'base'</span>,<span class="string">'cst'</span>);
2144     <span class="keyword">if</span> (sum(strcmp(<span class="string">'TARGET'</span>,cst(:,3))) &gt; 0 &amp;&amp; get(handles.checkIsoCenter,<span class="string">'Value'</span>)) || <span class="keyword">...</span>
2145             (sum(strcmp(<span class="string">'TARGET'</span>,cst(:,3))) &gt; 0 &amp;&amp; ~isfield(pln.propStf,<span class="string">'isoCenter'</span>))
2146        pln.propStf.isoCenter = ones(pln.propStf.numOfBeams,1) * <a href="matRad_getIsoCenter.html" class="code" title="function isoCenter = matRad_getIsoCenter(cst,ct,visBool)">matRad_getIsoCenter</a>(cst,ct);
2147        set(handles.checkIsoCenter,<span class="string">'Value'</span>,1);
2148     <span class="keyword">else</span>
2149         <span class="keyword">if</span> ~strcmp(get(handles.editIsoCenter,<span class="string">'String'</span>),<span class="string">'multiple isoCenter'</span>)
2150             pln.propStf.isoCenter = ones(pln.propStf.numOfBeams,1) * str2num(get(handles.editIsoCenter,<span class="string">'String'</span>));
2151         <span class="keyword">end</span>
2152     <span class="keyword">end</span>
2153 <span class="keyword">catch</span>
2154     warning(<span class="string">'couldnt set isocenter in getPln function'</span>)
2155 <span class="keyword">end</span>
2156 
2157 handles.pln = pln;
2158 assignin(<span class="string">'base'</span>,<span class="string">'pln'</span>,pln);
2159 
2160 <span class="comment">% parsing a string as number array</span>
2161 <a name="_sub37" href="#_subfunctions" class="code">function number = parseStringAsNum(stringIn,isVector)</a>
2162 <span class="keyword">if</span> isnumeric(stringIn)
2163     number = stringIn;
2164 <span class="keyword">else</span>
2165     number = str2num(stringIn);
2166     <span class="keyword">if</span> isempty(number) || length(number) &gt; 1 &amp;&amp; ~isVector
2167         warndlg([<span class="string">'could not parse all parameters (pln, optimization parameter)'</span>]); 
2168         number = NaN;
2169     <span class="keyword">elseif</span> isVector &amp;&amp; iscolumn(number)
2170         number = number';
2171     <span class="keyword">end</span>
2172 <span class="keyword">end</span>
2173 
2174 
2175 <span class="comment">% show error</span>
2176 <a name="_sub38" href="#_subfunctions" class="code">function handles = showError(handles,Message,ME)</a>
2177 
2178 <span class="keyword">if</span> nargin == 3
2179     <span class="comment">%Add exception message</span>
2180     <span class="keyword">if</span> isfield(handles,<span class="string">'devMode'</span>) &amp;&amp; handles.devMode
2181         meType = <span class="string">'extended'</span>;
2182     <span class="keyword">else</span> 
2183         meType = <span class="string">'basic'</span>;
2184     <span class="keyword">end</span>
2185     Message = {Message,ME.getReport(meType,<span class="string">'hyperlinks'</span>,<span class="string">'off'</span>)};    
2186 <span class="keyword">end</span>
2187 
2188 <span class="keyword">if</span> isfield(handles,<span class="string">'ErrorDlg'</span>)
2189     <span class="keyword">if</span> ishandle(handles.ErrorDlg)
2190         close(handles.ErrorDlg);
2191     <span class="keyword">end</span>
2192 <span class="keyword">end</span>
2193 handles.ErrorDlg = errordlg(Message);
2194 
2195 <span class="comment">% show warning</span>
2196 <a name="_sub39" href="#_subfunctions" class="code">function handles = showWarning(handles,Message,ME)</a>
2197 
2198 <span class="keyword">if</span> nargin == 3
2199     <span class="comment">%Add exception message</span>
2200     <span class="keyword">if</span> isfield(handles,<span class="string">'devMode'</span>) &amp;&amp; handles.devMode
2201         meType = <span class="string">'extended'</span>;
2202     <span class="keyword">else</span> 
2203         meType = <span class="string">'basic'</span>;
2204     <span class="keyword">end</span>
2205     Message = {Message,ME.getReport(meType,<span class="string">'hyperlinks'</span>,<span class="string">'off'</span>)};    
2206 <span class="keyword">end</span>
2207 
2208 <span class="keyword">if</span> isfield(handles,<span class="string">'WarnDlg'</span>)
2209     <span class="keyword">if</span> ishandle(handles.WarnDlg)
2210         close(handles.WarnDlg);
2211     <span class="keyword">end</span>
2212 <span class="keyword">end</span>
2213 handles.WarnDlg = warndlg(Message);
2214 
2215 <span class="comment">% check for valid machine data input file</span>
2216 <a name="_sub40" href="#_subfunctions" class="code">function flag = checkRadiationComposition(handles)</a>
2217 flag = true;
2218 contents = cellstr(get(handles.popUpMachine,<span class="string">'String'</span>));
2219 Machine = contents{get(handles.popUpMachine,<span class="string">'Value'</span>)};
2220 contents = cellstr(get(handles.popupRadMode,<span class="string">'String'</span>));
2221 radMod = contents{get(handles.popupRadMode,<span class="string">'Value'</span>)};
2222 
2223 <span class="keyword">if</span> isdeployed
2224     baseroot = [ctfroot filesep <span class="string">'matRad'</span>];
2225 <span class="keyword">else</span>
2226     baseroot = fileparts(mfilename(<span class="string">'fullpath'</span>));
2227 <span class="keyword">end</span>
2228 FoundFile = dir([baseroot filesep <span class="string">'basedata'</span> filesep radMod <span class="string">'_'</span> Machine <span class="string">'.mat'</span>]);
2229 
2230 
2231 <span class="keyword">if</span> isempty(FoundFile)
2232     warndlg([<span class="string">'No base data available for machine: '</span> Machine]);
2233     flag = false;
2234 <span class="keyword">end</span>
2235 
2236 <a name="_sub41" href="#_subfunctions" class="code">function matRadScrollWheelFcn(src,event)</a>
2237 
2238 <span class="comment">% get handles</span>
2239 handles = guidata(src);
2240 
2241 <span class="comment">% compute new slice</span>
2242 currSlice = round(get(handles.sliderSlice,<span class="string">'Value'</span>));
2243 newSlice  = currSlice - event.VerticalScrollCount;
2244 
2245 <span class="comment">% project to allowed set</span>
2246 newSlice = min(newSlice,get(handles.sliderSlice,<span class="string">'Max'</span>));
2247 newSlice = max(newSlice,get(handles.sliderSlice,<span class="string">'Min'</span>));
2248 
2249 <span class="comment">% update slider</span>
2250 set(handles.sliderSlice,<span class="string">'Value'</span>,newSlice);
2251 
2252 <span class="comment">% update handles object</span>
2253 guidata(src,handles);
2254 
2255 <span class="comment">% update plot</span>
2256 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles);
2257 
2258 
2259 
2260 
2261 <span class="comment">%% CALLBACKS</span>
2262 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2263 
2264 <span class="comment">% button: show DVH</span>
2265 <a name="_sub42" href="#_subfunctions" class="code">function btnDVH_Callback(~, ~, handles)</a>
2266 
2267 resultGUI = evalin(<span class="string">'base'</span>,<span class="string">'resultGUI'</span>);
2268 Content = get(handles.popupDisplayOption,<span class="string">'String'</span>);
2269 SelectedCube = Content{get(handles.popupDisplayOption,<span class="string">'Value'</span>)};
2270 
2271 pln = evalin(<span class="string">'base'</span>,<span class="string">'pln'</span>);
2272 resultGUI_SelectedCube.physicalDose = resultGUI.(SelectedCube);
2273 
2274 <span class="keyword">if</span> ~strcmp(pln.propOpt.bioOptimization,<span class="string">'none'</span>)
2275 
2276     <span class="comment">%check if one of the default fields is selected</span>
2277     <span class="keyword">if</span> sum(strcmp(SelectedCube,{<span class="string">'physicalDose'</span>,<span class="string">'effect'</span>,<span class="string">'RBE,'</span>,<span class="string">'RBExDose'</span>,<span class="string">'alpha'</span>,<span class="string">'beta'</span>})) &gt; 0
2278         resultGUI_SelectedCube.physicalDose = resultGUI.physicalDose;
2279         resultGUI_SelectedCube.RBExDose     = resultGUI.RBExDose;
2280     <span class="keyword">else</span>
2281         Idx    = find(SelectedCube == <span class="string">'_'</span>);
2282         SelectedSuffix = SelectedCube(Idx(1):end);
2283         resultGUI_SelectedCube.physicalDose = resultGUI.([<span class="string">'physicalDose'</span> SelectedSuffix]);
2284         resultGUI_SelectedCube.RBExDose     = resultGUI.([<span class="string">'RBExDose'</span> SelectedSuffix]);
2285     <span class="keyword">end</span>
2286 <span class="keyword">end</span>
2287 
2288 <span class="comment">%adapt visibilty</span>
2289 cst = evalin(<span class="string">'base'</span>,<span class="string">'cst'</span>);
2290 <span class="keyword">for</span> i = 1:size(cst,1)
2291     cst{i,5}.Visible = handles.VOIPlotFlag(i);
2292 <span class="keyword">end</span>
2293 
2294 <a href="matRad_indicatorWrapper.html" class="code" title="function [dvh,qi] = matRad_indicatorWrapper(cst,pln,resultGUI,refGy,refVol,param)">matRad_indicatorWrapper</a>(cst,pln,resultGUI_SelectedCube);
2295 
2296 assignin(<span class="string">'base'</span>,<span class="string">'cst'</span>,cst);
2297 
2298 <span class="comment">% radio button: plot isolines labels</span>
2299 <a name="_sub43" href="#_subfunctions" class="code">function radiobtnIsoDoseLinesLabels_Callback(~, ~, handles)</a>
2300 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles);
2301 
2302 <span class="comment">% button: refresh</span>
2303 <a name="_sub44" href="#_subfunctions" class="code">function btnRefresh_Callback(hObject, ~, handles)</a>
2304 
2305 handles = <a href="#_sub1" class="code" title="subfunction handles = resetGUI(hObject, handles, varargin)">resetGUI</a>(hObject, handles);
2306 
2307 <span class="comment">%% parse variables from base workspace</span>
2308 AllVarNames = evalin(<span class="string">'base'</span>,<span class="string">'who'</span>);
2309 handles.AllVarNames = AllVarNames;
2310 <span class="keyword">try</span>
2311     <span class="keyword">if</span>  ismember(<span class="string">'ct'</span>,AllVarNames) &amp;&amp;  ismember(<span class="string">'cst'</span>,AllVarNames)
2312         ct  = evalin(<span class="string">'base'</span>,<span class="string">'ct'</span>);
2313         cst = evalin(<span class="string">'base'</span>,<span class="string">'cst'</span>);
2314         <span class="comment">%cst = setCstTable(handles,cst);</span>
2315         cst = <a href="#_sub116" class="code" title="subfunction cst = generateCstTable(handles,cst)">generateCstTable</a>(handles,cst);
2316         handles.State = 1;
2317         cst = <a href="../matRad/plotting/matRad_computeVoiContoursWrapper.html" class="code" title="function cst = matRad_computeVoiContoursWrapper(cst,ct)">matRad_computeVoiContoursWrapper</a>(cst,ct);
2318         assignin(<span class="string">'base'</span>,<span class="string">'cst'</span>,cst);
2319         handles = <a href="#_sub3" class="code" title="subfunction handles = reloadGUI(hObject, handles, ct, cst)">reloadGUI</a>(hObject, handles, ct, cst);
2320     <span class="keyword">elseif</span> ismember(<span class="string">'ct'</span>,AllVarNames) &amp;&amp;  ~ismember(<span class="string">'cst'</span>,AllVarNames)
2321         handles = <a href="#_sub38" class="code" title="subfunction handles = showError(handles,Message,ME)">showError</a>(handles,<span class="string">'GUI OpeningFunc: could not find cst file'</span>);
2322         ct  = evalin(<span class="string">'base'</span>,<span class="string">'ct'</span>);
2323         handles = <a href="#_sub3" class="code" title="subfunction handles = reloadGUI(hObject, handles, ct, cst)">reloadGUI</a>(hObject,handles,ct);
2324     <span class="keyword">elseif</span> ~ismember(<span class="string">'ct'</span>,AllVarNames) &amp;&amp;  ismember(<span class="string">'cst'</span>,AllVarNames)
2325         handles = <a href="#_sub38" class="code" title="subfunction handles = showError(handles,Message,ME)">showError</a>(handles,<span class="string">'GUI OpeningFunc: could not find ct file'</span>);
2326         handles = <a href="#_sub3" class="code" title="subfunction handles = reloadGUI(hObject, handles, ct, cst)">reloadGUI</a>(hObject, handles);
2327     <span class="keyword">else</span>
2328         handles = <a href="#_sub3" class="code" title="subfunction handles = reloadGUI(hObject, handles, ct, cst)">reloadGUI</a>(hObject, handles);
2329     <span class="keyword">end</span>
2330 <span class="keyword">catch</span>
2331     handles = <a href="#_sub38" class="code" title="subfunction handles = showError(handles,Message,ME)">showError</a>(handles,<span class="string">'GUI OpeningFunc: Could not load ct and cst file'</span>);
2332     handles = <a href="#_sub3" class="code" title="subfunction handles = reloadGUI(hObject, handles, ct, cst)">reloadGUI</a>(hObject, handles);
2333 <span class="keyword">end</span>
2334 
2335 guidata(hObject, handles);
2336 
2337 
2338 <span class="comment">% text box: # fractions</span>
2339 <a name="_sub45" href="#_subfunctions" class="code">function editFraction_Callback(hObject, ~, handles)</a>
2340 <a href="#_sub36" class="code" title="subfunction getPlnFromGUI(handles)">getPlnFromGUI</a>(handles);
2341 guidata(hObject,handles);
2342 
2343 <span class="comment">% text box: stratification levels</span>
2344 <a name="_sub46" href="#_subfunctions" class="code">function editSequencingLevel_Callback(~, ~, ~)</a>
2345 
2346 <span class="comment">% text box: isoCenter in [mm]</span>
2347 <a name="_sub47" href="#_subfunctions" class="code">function editIsoCenter_Callback(hObject, ~, handles)</a>
2348 
2349 pln = evalin(<span class="string">'base'</span>,<span class="string">'pln'</span>);
2350 tmpIsoCenter = str2num(get(hObject,<span class="string">'String'</span>));
2351 
2352 <span class="keyword">if</span> length(tmpIsoCenter) == 3
2353     <span class="keyword">if</span> sum(any(unique(pln.propStf.isoCenter,<span class="string">'rows'</span>)~=tmpIsoCenter))
2354         pln.propStf.isoCenter = ones(pln.propStf.numOfBeams,1)*tmpIsoCenter;
2355         handles.State = 1;
2356         <a href="#_sub29" class="code" title="subfunction UpdateState(handles)">UpdateState</a>(handles);
2357     <span class="keyword">end</span>
2358 <span class="keyword">else</span>
2359     handles = <a href="#_sub38" class="code" title="subfunction handles = showError(handles,Message,ME)">showError</a>(handles,<span class="string">'EditIsoCenterCallback: Could not set iso center'</span>);
2360 <span class="keyword">end</span>
2361 
2362 assignin(<span class="string">'base'</span>,<span class="string">'pln'</span>,pln);
2363 guidata(hObject,handles);
2364 
2365 <span class="comment">% check box: iso center auto</span>
2366 <a name="_sub48" href="#_subfunctions" class="code">function checkIsoCenter_Callback(hObject, ~, handles)</a>
2367 
2368 W = evalin(<span class="string">'base'</span>,<span class="string">'whos'</span>);
2369 doesPlnExist = ismember(<span class="string">'pln'</span>,{W(:).name});
2370 
2371 <span class="keyword">if</span> get(hObject,<span class="string">'Value'</span>) &amp;&amp; doesPlnExist
2372     pln = evalin(<span class="string">'base'</span>,<span class="string">'pln'</span>);
2373     <span class="keyword">if</span> ~isfield(pln.propStf,<span class="string">'isoCenter'</span>)
2374         pln.propStf.isoCenter = NaN;
2375     <span class="keyword">end</span>
2376     tmpIsoCenter = <a href="matRad_getIsoCenter.html" class="code" title="function isoCenter = matRad_getIsoCenter(cst,ct,visBool)">matRad_getIsoCenter</a>(evalin(<span class="string">'base'</span>,<span class="string">'cst'</span>),evalin(<span class="string">'base'</span>,<span class="string">'ct'</span>));
2377     <span class="keyword">if</span> ~isequal(tmpIsoCenter,pln.propStf.isoCenter)
2378         pln.propStf.isoCenter = ones(pln.propStf.numOfBeams,1)*tmpIsoCenter;
2379         handles.State = 1;
2380         <a href="#_sub29" class="code" title="subfunction UpdateState(handles)">UpdateState</a>(handles);
2381     <span class="keyword">end</span>
2382     set(handles.editIsoCenter,<span class="string">'String'</span>,regexprep(num2str((round(tmpIsoCenter*10))./10), <span class="string">'\s+'</span>, <span class="string">' '</span>));
2383     set(handles.editIsoCenter,<span class="string">'Enable'</span>,<span class="string">'off'</span>)
2384     assignin(<span class="string">'base'</span>,<span class="string">'pln'</span>,pln);
2385 <span class="keyword">else</span>
2386     set(handles.editIsoCenter,<span class="string">'Enable'</span>,<span class="string">'on'</span>)
2387 <span class="keyword">end</span>
2388 
2389 <span class="comment">% radio button: run sequencing</span>
2390 <a name="_sub49" href="#_subfunctions" class="code">function btnRunSequencing_Callback(~, ~, handles)</a>
2391 <a href="#_sub36" class="code" title="subfunction getPlnFromGUI(handles)">getPlnFromGUI</a>(handles);
2392 
2393 <span class="comment">% radio button: run direct aperture optimization</span>
2394 <a name="_sub50" href="#_subfunctions" class="code">function btnRunDAO_Callback(~, ~, handles)</a>
2395 <a href="#_sub36" class="code" title="subfunction getPlnFromGUI(handles)">getPlnFromGUI</a>(handles);
2396 
2397 <span class="comment">% button: set iso dose levels</span>
2398 <a name="_sub51" href="#_subfunctions" class="code">function btnSetIsoDoseLevels_Callback(hObject, ~, handles)</a>
2399 prompt = {[<span class="string">'Enter iso dose levels in [Gy]. Enter space-separated numbers, e.g. 1.5 2 3 4.98. Enter 0 to use default values'</span>]};
2400 <span class="keyword">if</span> isequal(handles.IsoDose.Levels,0) || ~isvector(handles.IsoDose.Levels) || any(~isnumeric(handles.IsoDose.Levels)) || any(isnan(handles.IsoDose.Levels))
2401     defaultLine = {<span class="string">'1 2 3 '</span>};
2402 <span class="keyword">else</span>
2403     <span class="keyword">if</span> isrow(handles.IsoDose.Levels)
2404         defaultLine = cellstr(num2str(handles.IsoDose.Levels,<span class="string">'%.2g '</span>));
2405     <span class="keyword">else</span> 
2406         defaultLine = cellstr(num2str(handles.IsoDose.Levels',<span class="string">'%.2g '</span>));
2407     <span class="keyword">end</span>
2408 <span class="keyword">end</span>
2409 
2410 <span class="keyword">try</span>
2411     Input = inputdlg(prompt,<span class="string">'Set iso dose levels '</span>, [1 70],defaultLine);
2412     <span class="keyword">if</span> ~isempty(Input)
2413         handles.IsoDose.Levels = (sort(str2num(Input{1})));
2414         <span class="keyword">if</span> length(handles.IsoDose.Levels) == 1 &amp;&amp; (handles.IsoDose.Levels(1) ~= 0)
2415             handles.IsoDose.Levels = [handles.IsoDose.Levels handles.IsoDose.Levels];
2416         <span class="keyword">end</span>
2417         handles.IsoDose.NewIsoDoseFlag = true;
2418     <span class="keyword">end</span>
2419 <span class="keyword">catch</span>
2420     warning(<span class="string">'Couldnt parse iso dose levels - using default values'</span>);
2421     handles.IsoDose.Levels = 0;
2422 <span class="keyword">end</span>
2423 handles = <a href="#_sub64" class="code" title="subfunction handles = updateIsoDoseLineCache(handles)">updateIsoDoseLineCache</a>(handles);
2424 handles.IsoDose.NewIsoDoseFlag = false;
2425 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles);
2426 guidata(hObject,handles);
2427 
2428 
2429 <span class="comment">% popup menu: machine</span>
2430 <a name="_sub52" href="#_subfunctions" class="code">function popUpMachine_Callback(hObject, ~, handles)</a>
2431 contents = cellstr(get(hObject,<span class="string">'String'</span>));
2432 <a href="#_sub40" class="code" title="subfunction flag = checkRadiationComposition(handles)">checkRadiationComposition</a>(handles);
2433 <span class="keyword">if</span> handles.State &gt; 0
2434     pln = evalin(<span class="string">'base'</span>,<span class="string">'pln'</span>);
2435     <span class="keyword">if</span> handles.State &gt; 0 &amp;&amp; ~strcmp(contents(get(hObject,<span class="string">'Value'</span>)),pln.machine)
2436         handles.State = 1;
2437         <a href="#_sub29" class="code" title="subfunction UpdateState(handles)">UpdateState</a>(handles);
2438         guidata(hObject,handles);
2439     <span class="keyword">end</span>
2440    <a href="#_sub36" class="code" title="subfunction getPlnFromGUI(handles)">getPlnFromGUI</a>(handles);
2441 <span class="keyword">end</span>
2442 
2443 <span class="comment">% toolbar load button</span>
2444 <a name="_sub53" href="#_subfunctions" class="code">function toolbarLoad_ClickedCallback(hObject, eventdata, handles)</a>
2445 <a href="#_sub8" class="code" title="subfunction btnLoadMat_Callback(hObject, ~, handles)">btnLoadMat_Callback</a>(hObject, eventdata, handles);
2446 
2447 <span class="comment">% toolbar save button</span>
2448 <a name="_sub54" href="#_subfunctions" class="code">function toolbarSave_ClickedCallback(hObject, eventdata, handles)</a>
2449 
2450 <a href="#_sub31" class="code" title="subfunction btnTableSave_Callback(~, ~, handles)">btnTableSave_Callback</a>(hObject, eventdata, handles);
2451 
2452 <span class="keyword">try</span>
2453 
2454     <span class="keyword">if</span> handles.State &gt; 0
2455         ct  = evalin(<span class="string">'base'</span>,<span class="string">'ct'</span>);
2456         cst = evalin(<span class="string">'base'</span>,<span class="string">'cst'</span>);
2457         pln = evalin(<span class="string">'base'</span>,<span class="string">'pln'</span>);
2458     <span class="keyword">end</span>
2459 
2460     <span class="keyword">if</span> handles.State &gt; 1
2461        stf = evalin(<span class="string">'base'</span>,<span class="string">'stf'</span>);
2462        dij = evalin(<span class="string">'base'</span>,<span class="string">'dij'</span>);
2463     <span class="keyword">end</span>
2464 
2465     <span class="keyword">if</span> handles.State &gt; 2
2466        resultGUI = evalin(<span class="string">'base'</span>,<span class="string">'resultGUI'</span>);
2467     <span class="keyword">end</span>
2468 
2469     <span class="keyword">switch</span> handles.State
2470         <span class="keyword">case</span> 1
2471             uisave({<span class="string">'cst'</span>,<span class="string">'ct'</span>,<span class="string">'pln'</span>});
2472         <span class="keyword">case</span> 2
2473             uisave({<span class="string">'cst'</span>,<span class="string">'ct'</span>,<span class="string">'pln'</span>,<span class="string">'stf'</span>,<span class="string">'dij'</span>});
2474         <span class="keyword">case</span> 3
2475             uisave({<span class="string">'cst'</span>,<span class="string">'ct'</span>,<span class="string">'pln'</span>,<span class="string">'stf'</span>,<span class="string">'dij'</span>,<span class="string">'resultGUI'</span>});
2476     <span class="keyword">end</span>
2477 
2478 <span class="keyword">catch</span>
2479      handles = <a href="#_sub39" class="code" title="subfunction handles = showWarning(handles,Message,ME)">showWarning</a>(handles,<span class="string">'Could not save files'</span>); 
2480 <span class="keyword">end</span>
2481 guidata(hObject,handles); 
2482 
2483 <span class="comment">% button: about</span>
2484 <a name="_sub55" href="#_subfunctions" class="code">function btnAbout_Callback(hObject, eventdata, handles)</a>
2485 
2486 [~,matRadVer] = <a href="matRad_version.html" class="code" title="function [versionString,matRadVer] = matRad_version()">matRad_version</a>;
2487 
2488 msg{1} = [<span class="string">'matRad '''</span> matRadVer.name <span class="string">''''</span>]; <span class="comment">%Name</span>
2489 <span class="keyword">if</span> handles.eduMode
2490     msg{1} = [msg{1} <span class="string">' Educational'</span>];
2491 <span class="keyword">end</span>
2492 msg{end+1} = sprintf(<span class="string">'v%d.%d.%d'</span>,matRadVer.major,matRadVer.minor,matRadVer.patch); <span class="comment">%Version Number</span>
2493 <span class="keyword">if</span> isdeployed
2494    msg{end+1} = <span class="string">'Standalone Version'</span>;
2495 <span class="keyword">elseif</span> ~isempty(matRadVer.branch) &amp;&amp; ~isempty(matRadVer.commitID)
2496     msg{end+1} = sprintf(<span class="string">'Git: Branch %s, commit %s'</span>,matRadVer.branch,matRadVer.commitID(1:8));
2497 <span class="keyword">end</span>
2498 
2499 [env,envver]  = <a href="../matRad/tools/matRad_getEnvironment.html" class="code" title="function [env, versionString] = matRad_getEnvironment()">matRad_getEnvironment</a>();
2500 msg{end+1} = sprintf(<span class="string">'Environment: %s v%s %s'</span>,env,envver,version(<span class="string">'-release'</span>));
2501 
2502 msg{end+1} = <span class="string">'Web: www.matrad.org'</span>;
2503 msg{end+1} = <span class="string">'E-Mail: contact@matrad.org'</span>;
2504 
2505 msgbox(msg,<span class="string">'About matRad'</span>);
2506 
2507 <span class="comment">% button: close</span>
2508 <a name="_sub56" href="#_subfunctions" class="code">function figure1_CloseRequestFcn(hObject, ~, ~)</a>
2509 set(0,<span class="string">'DefaultUicontrolBackgroundColor'</span>,[0.5 0.5 0.5]);     
2510 selection = questdlg(<span class="string">'Do you really want to close matRad?'</span>,<span class="keyword">...</span>
2511                      <span class="string">'Close matRad'</span>,<span class="keyword">...</span>
2512                      <span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'Yes'</span>);
2513 
2514 <span class="comment">%BackgroundColor',[0.5 0.5 0.5]</span>
2515  <span class="keyword">switch</span> selection
2516    <span class="keyword">case</span> <span class="string">'Yes'</span>
2517      delete(hObject);
2518    <span class="keyword">case</span> <span class="string">'No'</span>
2519      <span class="keyword">return</span>
2520  <span class="keyword">end</span>
2521 
2522 <span class="comment">% --- Executes on button press in pushbutton_recalc.</span>
2523 <a name="_sub57" href="#_subfunctions" class="code">function pushbutton_recalc_Callback(hObject, ~, handles)</a>
2524 
2525 <span class="comment">% recalculation only makes sense if ...</span>
2526 <span class="keyword">if</span> evalin(<span class="string">'base'</span>,<span class="string">'exist(''pln'',''var'')'</span>) &amp;&amp; <span class="keyword">...</span>
2527    evalin(<span class="string">'base'</span>,<span class="string">'exist(''stf'',''var'')'</span>) &amp;&amp; <span class="keyword">...</span>
2528    evalin(<span class="string">'base'</span>,<span class="string">'exist(''ct'',''var'')'</span>) &amp;&amp; <span class="keyword">...</span>
2529    evalin(<span class="string">'base'</span>,<span class="string">'exist(''cst'',''var'')'</span>) &amp;&amp; <span class="keyword">...</span>
2530    evalin(<span class="string">'base'</span>,<span class="string">'exist(''resultGUI'',''var'')'</span>)
2531 
2532 <span class="keyword">try</span>
2533 
2534     <span class="comment">% indicate that matRad is busy</span>
2535     <span class="comment">% change mouse pointer to hour glass</span>
2536     Figures = gcf;<span class="comment">%findobj('type','figure');</span>
2537     set(Figures, <span class="string">'pointer'</span>, <span class="string">'watch'</span>); 
2538     drawnow;
2539     <span class="comment">% disable all active objects</span>
2540     InterfaceObj = findobj(Figures,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2541     set(InterfaceObj,<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2542     
2543     <span class="comment">% get all data from workspace</span>
2544     pln       = evalin(<span class="string">'base'</span>,<span class="string">'pln'</span>);
2545     stf       = evalin(<span class="string">'base'</span>,<span class="string">'stf'</span>);
2546     ct        = evalin(<span class="string">'base'</span>,<span class="string">'ct'</span>);
2547     cst       = evalin(<span class="string">'base'</span>,<span class="string">'cst'</span>);
2548     resultGUI = evalin(<span class="string">'base'</span>,<span class="string">'resultGUI'</span>);
2549     
2550     <span class="comment">% get weights of the selected cube</span>
2551     Content = get(handles.popupDisplayOption,<span class="string">'String'</span>);
2552     SelectedCube = Content{get(handles.popupDisplayOption,<span class="string">'Value'</span>)};
2553     Suffix = strsplit(SelectedCube,<span class="string">'_'</span>);
2554     <span class="keyword">if</span> length(Suffix)&gt;1
2555         Suffix = [<span class="string">'_'</span> Suffix{2}];
2556     <span class="keyword">else</span>
2557         Suffix = <span class="string">''</span>;
2558     <span class="keyword">end</span>
2559     
2560     <span class="keyword">if</span> sum([stf.totalNumOfBixels]) ~= length(resultGUI.([<span class="string">'w'</span> Suffix]))
2561         warndlg(<span class="string">'weight vector does not corresponding to current steering file'</span>);
2562         <span class="keyword">return</span>
2563     <span class="keyword">end</span>
2564     
2565     <span class="comment">% change isocenter if that was changed and do _not_ recreate steering</span>
2566     <span class="comment">% information</span>
2567     <span class="keyword">for</span> i = 1:numel(pln.propStf.gantryAngles)
2568         stf(i).isoCenter = pln.propStf.isoCenter(i,:);
2569     <span class="keyword">end</span>
2570 
2571     <span class="comment">% recalculate influence matrix</span>
2572     <span class="keyword">if</span> strcmp(pln.radiationMode,<span class="string">'photons'</span>)
2573         dij = <a href="matRad_calcPhotonDose.html" class="code" title="function dij = matRad_calcPhotonDose(ct,stf,pln,cst,calcDoseDirect)">matRad_calcPhotonDose</a>(ct,stf,pln,cst);
2574     <span class="keyword">elseif</span> strcmp(pln.radiationMode,<span class="string">'protons'</span>) || strcmp(pln.radiationMode,<span class="string">'carbon'</span>)
2575         dij = <a href="matRad_calcParticleDose.html" class="code" title="function dij = matRad_calcParticleDose(ct,stf,pln,cst,calcDoseDirect)">matRad_calcParticleDose</a>(ct,stf,pln,cst);
2576     <span class="keyword">end</span>
2577 
2578     <span class="comment">% recalculate cubes in resultGUI</span>
2579     resultGUIreCalc = <a href="matRad_calcCubes.html" class="code" title="function resultGUI = matRad_calcCubes(w,dij,scenNum)">matRad_calcCubes</a>(resultGUI.([<span class="string">'w'</span> Suffix]),dij,cst);
2580     
2581     <span class="comment">% delete old variables to avoid confusion</span>
2582     <span class="keyword">if</span> isfield(resultGUI,<span class="string">'effect'</span>)
2583         resultGUI = rmfield(resultGUI,<span class="string">'effect'</span>);
2584         resultGUI = rmfield(resultGUI,<span class="string">'RBExDose'</span>); 
2585         resultGUI = rmfield(resultGUI,<span class="string">'RBE'</span>); 
2586         resultGUI = rmfield(resultGUI,<span class="string">'alpha'</span>); 
2587         resultGUI = rmfield(resultGUI,<span class="string">'beta'</span>);
2588     <span class="keyword">end</span>
2589     
2590     <span class="comment">% overwrite the &quot;standard&quot; fields</span>
2591     sNames = fieldnames(resultGUIreCalc);
2592     <span class="keyword">for</span> j = 1:length(sNames)
2593         resultGUI.(sNames{j}) = resultGUIreCalc.(sNames{j});
2594     <span class="keyword">end</span>
2595     
2596     <span class="comment">% assign results to base worksapce</span>
2597     assignin(<span class="string">'base'</span>,<span class="string">'dij'</span>,dij);
2598     assignin(<span class="string">'base'</span>,<span class="string">'resultGUI'</span>,resultGUI);
2599     
2600     handles.State = 3;
2601     
2602     <span class="comment">% show physicalDose of newly computed state</span>
2603     handles.SelectedDisplayOption = <span class="string">'physicalDose'</span>;
2604     set(handles.popupDisplayOption,<span class="string">'Value'</span>,find(strcmp(<span class="string">'physicalDose'</span>,Content)));
2605     
2606     <span class="comment">% change state from busy to normal</span>
2607     set(Figures, <span class="string">'pointer'</span>, <span class="string">'arrow'</span>);
2608     set(InterfaceObj,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2609     
2610     handles.cBarChanged = true;
2611     
2612     handles = <a href="#_sub64" class="code" title="subfunction handles = updateIsoDoseLineCache(handles)">updateIsoDoseLineCache</a>(handles);
2613 
2614     <a href="#_sub29" class="code" title="subfunction UpdateState(handles)">UpdateState</a>(handles);
2615     
2616     handles.rememberCurrAxes = false;
2617     <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles);
2618     handles.rememberCurrAxes = true;   
2619 
2620     guidata(hObject,handles);
2621 
2622 <span class="keyword">catch</span> ME
2623     handles = <a href="#_sub38" class="code" title="subfunction handles = showError(handles,Message,ME)">showError</a>(handles,<span class="string">'CalcDoseCallback: Error in dose recalculation!'</span>,ME); 
2624 
2625     <span class="comment">% change state from busy to normal</span>
2626     set(Figures, <span class="string">'pointer'</span>, <span class="string">'arrow'</span>);
2627     set(InterfaceObj,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2628 
2629     guidata(hObject,handles);
2630     <span class="keyword">return</span>;
2631 
2632 <span class="keyword">end</span>
2633     
2634 <span class="keyword">end</span>
2635 
2636 
2637 <span class="comment">% --- Executes on button press in btnSetTissue.</span>
2638 <a name="_sub58" href="#_subfunctions" class="code">function btnSetTissue_Callback(hObject, ~, handles)</a>
2639 
2640 <span class="comment">%check if patient is loaded</span>
2641 <span class="keyword">if</span> handles.State == 0
2642     <span class="keyword">return</span>
2643 <span class="keyword">end</span>
2644 
2645 <span class="comment">%parse variables from base-workspace</span>
2646 cst = evalin(<span class="string">'base'</span>,<span class="string">'cst'</span>);
2647 pln = evalin(<span class="string">'base'</span>,<span class="string">'pln'</span>);
2648 
2649 fileName = [pln.radiationMode <span class="string">'_'</span> pln.machine];
2650 load([<span class="string">'basedata'</span> filesep fileName]);
2651 
2652 <span class="comment">% check for available cell types characterized by alphaX and betaX</span>
2653 <span class="keyword">for</span> i = 1:size(machine.data(1).alphaX,2)
2654     CellType{i} = [num2str(machine.data(1).alphaX(i)) <span class="string">' '</span> num2str(machine.data(1).betaX(i))];
2655 <span class="keyword">end</span>
2656 
2657 <span class="comment">%fill table data array</span>
2658 <span class="keyword">for</span> i = 1:size(cst,1)
2659     data{i,1} = cst{i,2};
2660     data{i,2} = [num2str(cst{i,5}.alphaX) <span class="string">' '</span> num2str(cst{i,5}.betaX)];
2661     data{i,3} = (cst{i,5}.alphaX / cst{i,5}.betaX );
2662 <span class="keyword">end</span>
2663 
2664 Width  = 400;
2665 Height = 200 + 20*size(data,1);
2666 ScreenSize = get(0,<span class="string">'ScreenSize'</span>);
2667 <span class="comment">% show &quot;set tissue parameter&quot; window</span>
2668 figHandles = get(0,<span class="string">'Children'</span>);
2669 <span class="keyword">if</span> ~isempty(figHandles)
2670     IdxHandle = strcmp(get(figHandles,<span class="string">'Name'</span>),<span class="string">'Set Tissue Parameters'</span>);
2671 <span class="keyword">else</span>
2672     IdxHandle = [];
2673 <span class="keyword">end</span>
2674 
2675 <span class="comment">%check if window is already exists</span>
2676 <span class="keyword">if</span> any(IdxHandle)
2677     IdxTable = find(strcmp({figHandles(IdxHandle).Children.Type},<span class="string">'uitable'</span>));
2678     set(figHandles(IdxHandle).Children(IdxTable), <span class="string">'Data'</span>, []);
2679     figTissue = figHandles(IdxHandle);
2680     <span class="comment">%set focus</span>
2681     figure(figTissue);
2682 <span class="keyword">else</span>
2683     figTissue = figure(<span class="string">'Name'</span>,<span class="string">'Set Tissue Parameters'</span>,<span class="string">'Color'</span>,[.5 .5 .5],<span class="string">'NumberTitle'</span>,<span class="string">'off'</span>,<span class="string">'Position'</span>,<span class="keyword">...</span>
2684         [ceil(ScreenSize(3)/2) ceil(ScreenSize(4)/2) Width Height]);
2685 <span class="keyword">end</span>
2686 
2687 <span class="comment">% define the tissue parameter table</span>
2688 cNames = {<span class="string">'VOI'</span>,<span class="string">'alphaX betaX'</span>,<span class="string">'alpha beta ratio'</span>};
2689 columnformat = {<span class="string">'char'</span>,CellType,<span class="string">'numeric'</span>};
2690 
2691 tissueTable = uitable(<span class="string">'Parent'</span>, figTissue,<span class="string">'Data'</span>, data,<span class="string">'ColumnEditable'</span>,[false true false],<span class="keyword">...</span>
2692                       <span class="string">'ColumnName'</span>,cNames, <span class="string">'ColumnFormat'</span>,columnformat,<span class="string">'Position'</span>,[50 150 10 10]);
2693 set(tissueTable,<span class="string">'CellEditCallback'</span>,@<a href="#_sub60" class="code" title="subfunction tissueTable_CellEditCallback(hObject, eventdata, ~)">tissueTable_CellEditCallback</a>);
2694 <span class="comment">% set width and height</span>
2695 currTablePos = get(tissueTable,<span class="string">'Position'</span>);
2696 currTableExt = get(tissueTable,<span class="string">'Extent'</span>);
2697 currTablePos(3) = currTableExt(3);
2698 currTablePos(4) = currTableExt(4);
2699 set(tissueTable,<span class="string">'Position'</span>,currTablePos);
2700 
2701 <span class="comment">% define two buttons with callbacks</span>
2702 uicontrol(<span class="string">'Parent'</span>, figTissue,<span class="string">'Style'</span>, <span class="string">'pushbutton'</span>, <span class="string">'String'</span>, <span class="string">'Save&amp;Close'</span>,<span class="keyword">...</span>
2703         <span class="string">'Position'</span>, [Width-(0.25*Width) 0.1 * Height 70 30],<span class="keyword">...</span>
2704         <span class="string">'Callback'</span>, @(hpb,eventdata)<a href="#_sub59" class="code" title="subfunction SaveTissueParameters(~, ~, handles,tissueTable)">SaveTissueParameters</a>(hpb,eventdata,handles,tissueTable));
2705     
2706 uicontrol(<span class="string">'Parent'</span>, figTissue,<span class="string">'Style'</span>, <span class="string">'pushbutton'</span>, <span class="string">'String'</span>, <span class="string">'Cancel&amp;Close'</span>,<span class="keyword">...</span>
2707         <span class="string">'Position'</span>, [Width-(0.5*Width) 0.1 * Height 80 30],<span class="keyword">...</span>
2708         <span class="string">'Callback'</span>, <span class="string">'close'</span>);    
2709     
2710 guidata(hObject,handles); 
2711 <a href="#_sub29" class="code" title="subfunction UpdateState(handles)">UpdateState</a>(handles);
2712     
2713     
2714 <a name="_sub59" href="#_subfunctions" class="code">function SaveTissueParameters(~, ~, handles,tissueTable) </a>
2715 cst = evalin(<span class="string">'base'</span>,<span class="string">'cst'</span>);    
2716 <span class="comment">% get handle to uiTable</span>
2717 
2718 <span class="comment">% retrieve data from uitable</span>
2719 data       = get(tissueTable,<span class="string">'data'</span>);
2720 
2721 <span class="keyword">for</span> i = 1:size(cst,1)
2722    <span class="keyword">for</span> j = 1:size(data,1)
2723        <span class="keyword">if</span> strcmp(cst{i,2},data{j,1})
2724          alphaXBetaX = str2num(data{j,2});
2725          cst{i,5}.alphaX = alphaXBetaX(1);
2726          cst{i,5}.betaX  = alphaXBetaX(2);
2727        <span class="keyword">end</span>
2728    <span class="keyword">end</span>
2729 <span class="keyword">end</span>
2730 assignin(<span class="string">'base'</span>,<span class="string">'cst'</span>,cst);
2731 close(get(tissueTable,<span class="string">'Parent'</span>));
2732 handles.State = 2;
2733 <a href="#_sub29" class="code" title="subfunction UpdateState(handles)">UpdateState</a>(handles);
2734 
2735         
2736 <a name="_sub60" href="#_subfunctions" class="code">function tissueTable_CellEditCallback(hObject, eventdata, ~) </a>
2737 <span class="keyword">if</span> eventdata.Indices(2) == 2
2738    alphaXBetaX = str2num(eventdata.NewData);
2739    data = get(hObject,<span class="string">'Data'</span>);
2740    data{eventdata.Indices(1),3} = alphaXBetaX(1)/alphaXBetaX(2);
2741    set(hObject,<span class="string">'Data'</span>,data);
2742 <span class="keyword">end</span>
2743 
2744 <span class="comment">% --- Executes on button press in btnSaveToGUI.</span>
2745 <a name="_sub61" href="#_subfunctions" class="code">function btnSaveToGUI_Callback(hObject, ~, handles)</a>
2746 
2747 Width  = 400;
2748 Height = 200;
2749 ScreenSize = get(0,<span class="string">'ScreenSize'</span>);
2750 
2751 <span class="comment">% show &quot;Provide result name&quot; window</span>
2752 figHandles = get(0,<span class="string">'Children'</span>);
2753 <span class="keyword">if</span> ~isempty(figHandles)
2754     IdxHandle = strcmp(get(figHandles,<span class="string">'Name'</span>),<span class="string">'Provide result name'</span>);
2755 <span class="keyword">else</span>
2756     IdxHandle = [];
2757 <span class="keyword">end</span>
2758 
2759 <span class="comment">%check if window is already exists</span>
2760 <span class="keyword">if</span> any(IdxHandle)
2761     figDialog = figHandles(IdxHandle);
2762     <span class="comment">%set focus</span>
2763     figure(figDialog);
2764 <span class="keyword">else</span>
2765     figDialog = dialog(<span class="string">'Position'</span>,[ceil(ScreenSize(3)/2) ceil(ScreenSize(4)/2) Width Height],<span class="string">'Name'</span>,<span class="string">'Provide result name'</span>,<span class="string">'Color'</span>,[0.5 0.5 0.5]);
2766     
2767     uicontrol(<span class="string">'Parent'</span>,figDialog,<span class="keyword">...</span>
2768               <span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="keyword">...</span>
2769               <span class="string">'Position'</span>,[20 Height - (0.35*Height) 350 60],<span class="keyword">...</span>
2770               <span class="string">'String'</span>,<span class="string">'Please provide a decriptive name for your optimization result:'</span>,<span class="string">'FontSize'</span>,10,<span class="string">'BackgroundColor'</span>,[0.5 0.5 0.5]);
2771     
2772     uicontrol(<span class="string">'Parent'</span>,figDialog,<span class="keyword">...</span>
2773               <span class="string">'Style'</span>,<span class="string">'edit'</span>,<span class="keyword">...</span>
2774               <span class="string">'Position'</span>,[30 60 350 60],<span class="keyword">...</span><span class="comment"> </span>
2775               <span class="string">'String'</span>,<span class="string">'Please enter name here...'</span>,<span class="string">'FontSize'</span>,10,<span class="string">'BackgroundColor'</span>,[0.55 0.55 0.55]);
2776          
2777     uicontrol(<span class="string">'Parent'</span>, figDialog,<span class="string">'Style'</span>, <span class="string">'pushbutton'</span>, <span class="string">'String'</span>, <span class="string">'Save'</span>,<span class="string">'FontSize'</span>,10,<span class="keyword">...</span>
2778               <span class="string">'Position'</span>, [0.42*Width 0.1 * Height 70 30],<span class="keyword">...</span>
2779               <span class="string">'Callback'</span>, @(hpb,eventdata)<a href="#_sub62" class="code" title="subfunction SaveResultToGUI(~, ~, ~)">SaveResultToGUI</a>(hpb,eventdata,guidata(hpb)));        
2780 <span class="keyword">end</span>
2781 
2782 uiwait(figDialog);
2783 guidata(hObject, handles);
2784 <a href="#_sub29" class="code" title="subfunction UpdateState(handles)">UpdateState</a>(handles)
2785 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles)
2786 
2787 
2788 <a name="_sub62" href="#_subfunctions" class="code">function SaveResultToGUI(~, ~, ~)</a>
2789 AllFigHandles = get(0,<span class="string">'Children'</span>);    
2790 ixHandle      = strcmp(get(AllFigHandles,<span class="string">'Name'</span>),<span class="string">'Provide result name'</span>);
2791 uiEdit        = get(AllFigHandles(ixHandle),<span class="string">'Children'</span>);
2792 
2793 <span class="keyword">if</span> strcmp(get(uiEdit(2),<span class="string">'String'</span>),<span class="string">'Please enter name here...'</span>)
2794   
2795     formatOut = <span class="string">'mmddyyHHMM'</span>;
2796     Suffix = [<span class="string">'_'</span> datestr(now,formatOut)];
2797 <span class="keyword">else</span>
2798     <span class="comment">% delete special characters</span>
2799     Suffix = get(uiEdit(2),<span class="string">'String'</span>);
2800     logIx = isstrprop(Suffix,<span class="string">'alphanum'</span>);
2801     Suffix = [<span class="string">'_'</span> Suffix(logIx)];
2802 <span class="keyword">end</span>
2803 
2804 pln       = evalin(<span class="string">'base'</span>,<span class="string">'pln'</span>);
2805 resultGUI = evalin(<span class="string">'base'</span>,<span class="string">'resultGUI'</span>);
2806 
2807 <span class="keyword">if</span> isfield(resultGUI,<span class="string">'physicalDose'</span>)
2808     resultGUI.([<span class="string">'physicalDose'</span> Suffix])  = resultGUI.physicalDose; 
2809 <span class="keyword">end</span>
2810 <span class="keyword">if</span> isfield(resultGUI,<span class="string">'w'</span>)
2811     resultGUI.([<span class="string">'w'</span> Suffix])             = resultGUI.w;
2812 <span class="keyword">end</span>
2813 
2814 
2815 <span class="keyword">if</span> ~strcmp(pln.propOpt.bioOptimization,<span class="string">'none'</span>)
2816     
2817     <span class="keyword">if</span> isfield(resultGUI,<span class="string">'RBExDose'</span>)
2818          resultGUI.([<span class="string">'RBExDose'</span> Suffix]) = resultGUI.RBExDose; 
2819     <span class="keyword">end</span>
2820     
2821     <span class="keyword">if</span> strcmp(pln.radiationMode,<span class="string">'carbon'</span>) == 1 
2822         <span class="keyword">if</span> isfield(resultGUI,<span class="string">'effect'</span>)
2823             resultGUI.([<span class="string">'effect'</span> Suffix])= resultGUI.effect; 
2824         <span class="keyword">end</span>
2825 
2826         <span class="keyword">if</span> isfield(resultGUI,<span class="string">'RBE'</span>)
2827             resultGUI.([<span class="string">'RBE'</span> Suffix]) = resultGUI.RBE;
2828         <span class="keyword">end</span>
2829         <span class="keyword">if</span> isfield(resultGUI,<span class="string">'alpha'</span>)
2830             resultGUI.([<span class="string">'alpha'</span> Suffix]) = resultGUI.alpha;
2831         <span class="keyword">end</span>
2832         <span class="keyword">if</span> isfield(resultGUI,<span class="string">'beta'</span>)
2833             resultGUI.([<span class="string">'beta'</span> Suffix]) = resultGUI.beta;
2834         <span class="keyword">end</span>
2835     <span class="keyword">end</span>
2836 <span class="keyword">end</span>
2837 
2838 close(AllFigHandles(ixHandle));
2839 assignin(<span class="string">'base'</span>,<span class="string">'resultGUI'</span>,resultGUI);
2840 
2841 <span class="comment">% precompute contours of VOIs</span>
2842 <a name="_sub63" href="#_subfunctions" class="code">function cst = precomputeContours(ct,cst)</a>
2843 mask = zeros(ct.cubeDim); <span class="comment">% create zero cube with same dimeonsions like dose cube</span>
2844 <span class="keyword">for</span> s = 1:size(cst,1)
2845     cst{s,7} = cell(max(ct.cubeDim(:)),3);
2846     mask(:) = 0;
2847     mask(cst{s,4}{1}) = 1;    
2848     <span class="keyword">for</span> slice = 1:ct.cubeDim(1)
2849         <span class="keyword">if</span> sum(sum(mask(slice,:,:))) &gt; 0
2850              cst{s,7}{slice,1} = contourc(squeeze(mask(slice,:,:)),.5*[1 1]);
2851         <span class="keyword">end</span>
2852     <span class="keyword">end</span>
2853     <span class="keyword">for</span> slice = 1:ct.cubeDim(2)
2854         <span class="keyword">if</span> sum(sum(mask(:,slice,:))) &gt; 0
2855              cst{s,7}{slice,2} = contourc(squeeze(mask(:,slice,:)),.5*[1 1]);
2856         <span class="keyword">end</span>
2857     <span class="keyword">end</span>
2858     <span class="keyword">for</span> slice = 1:ct.cubeDim(3)
2859         <span class="keyword">if</span> sum(sum(mask(:,:,slice))) &gt; 0
2860              cst{s,7}{slice,3} = contourc(squeeze(mask(:,:,slice)),.5*[1 1]);
2861         <span class="keyword">end</span>
2862     <span class="keyword">end</span>
2863 <span class="keyword">end</span>
2864 
2865 <span class="comment">%Update IsodoseLines</span>
2866 <a name="_sub64" href="#_subfunctions" class="code">function handles = updateIsoDoseLineCache(handles)</a>
2867 resultGUI = evalin(<span class="string">'base'</span>,<span class="string">'resultGUI'</span>);
2868 <span class="comment">% select first cube if selected option does not exist</span>
2869 <span class="keyword">if</span> ~isfield(resultGUI,handles.SelectedDisplayOption)
2870     CubeNames = fieldnames(resultGUI);
2871     dose = resultGUI.(CubeNames{1,1});
2872 <span class="keyword">else</span>
2873     dose = resultGUI.(handles.SelectedDisplayOption);
2874 <span class="keyword">end</span>
2875 
2876 <span class="comment">%if function is called for the first time then set display parameters</span>
2877 <span class="keyword">if</span> isempty(handles.dispWindow{3,2})
2878     handles.dispWindow{3,1} = [min(dose(:)) max(dose(:))]; <span class="comment">% set default dose range</span>
2879     handles.dispWindow{3,2} = [min(dose(:)) max(dose(:))]; <span class="comment">% set min max values</span>
2880 <span class="keyword">end</span>
2881 
2882 minMaxRange = handles.dispWindow{3,1};
2883 <span class="comment">% if upper colorrange is defined then use it otherwise 120% iso dose</span>
2884  upperMargin = 1;
2885 <span class="keyword">if</span> abs((max(dose(:)) - handles.dispWindow{3,1}(1,2))) &lt; 0.01  * max(dose(:))
2886     upperMargin = 1.2;
2887 <span class="keyword">end</span>
2888 
2889 <span class="keyword">if</span> (length(handles.IsoDose.Levels) == 1 &amp;&amp; handles.IsoDose.Levels(1,1) == 0) || ~handles.IsoDose.NewIsoDoseFlag
2890     vLevels                  = [0.1:0.1:0.9 0.95:0.05:upperMargin];  
2891     referenceDose            = (minMaxRange(1,2))/(upperMargin);
2892     handles.IsoDose.Levels   = minMaxRange(1,1) + (referenceDose-minMaxRange(1,1)) * vLevels;
2893 <span class="keyword">end</span>
2894 handles.IsoDose.Contours = <a href="../matRad/plotting/matRad_computeIsoDoseContours.html" class="code" title="function isoDoseContours = matRad_computeIsoDoseContours(doseCube,isoLevels)">matRad_computeIsoDoseContours</a>(dose,handles.IsoDose.Levels);
2895 
2896     
2897    
2898 <span class="comment">%% CREATE FUNCTIONS</span>
2899 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2900 
2901 <span class="comment">% popup menu: machine</span>
2902 <a name="_sub65" href="#_subfunctions" class="code">function popUpMachine_CreateFcn(hObject, ~, ~)</a>
2903 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
2904     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
2905 <span class="keyword">end</span>
2906 
2907 <span class="comment">% text box: max value</span>
2908 <a name="_sub66" href="#_subfunctions" class="code">function txtMaxVal_CreateFcn(hObject, ~, ~)</a>
2909 
2910 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
2911     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
2912 <span class="keyword">end</span>
2913 
2914 <span class="comment">% text box: edit iso center</span>
2915 <a name="_sub67" href="#_subfunctions" class="code">function editIsoCenter_CreateFcn(hObject, ~, ~)</a>
2916 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
2917     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
2918 <span class="keyword">end</span>
2919 
2920 <span class="comment">% text box: stratification levels</span>
2921 <a name="_sub68" href="#_subfunctions" class="code">function editSequencingLevel_CreateFcn(hObject, ~, ~)</a>
2922 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
2923     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
2924 <span class="keyword">end</span>
2925 
2926 <a name="_sub69" href="#_subfunctions" class="code">function slicerPrecision_CreateFcn(hObject, ~, ~)</a>
2927 <span class="keyword">if</span> isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
2928     set(hObject,<span class="string">'BackgroundColor'</span>,[.9 .9 .9]);
2929 <span class="keyword">end</span>
2930 
2931 <a name="_sub70" href="#_subfunctions" class="code">function editBixelWidth_CreateFcn(hObject, ~, ~)</a>
2932 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
2933     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
2934 <span class="keyword">end</span>
2935 
2936 <a name="_sub71" href="#_subfunctions" class="code">function editGantryAngle_CreateFcn(hObject, ~, ~)</a>
2937 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
2938     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
2939 <span class="keyword">end</span>
2940 
2941 <a name="_sub72" href="#_subfunctions" class="code">function editCouchAngle_CreateFcn(hObject, ~, ~)</a>
2942 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
2943     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
2944 <span class="keyword">end</span>
2945 
2946 <a name="_sub73" href="#_subfunctions" class="code">function popupRadMode_CreateFcn(hObject, ~, ~)</a>
2947 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
2948     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
2949 <span class="keyword">end</span>
2950 
2951 <a name="_sub74" href="#_subfunctions" class="code">function editFraction_CreateFcn(hObject, ~, ~) </a>
2952 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
2953     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
2954 <span class="keyword">end</span>
2955 
2956 <a name="_sub75" href="#_subfunctions" class="code">function popupPlane_CreateFcn(hObject, ~, ~)</a>
2957 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
2958     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
2959 <span class="keyword">end</span>
2960 
2961 <a name="_sub76" href="#_subfunctions" class="code">function sliderSlice_CreateFcn(hObject, ~, ~)</a>
2962 <span class="keyword">if</span> isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
2963     set(hObject,<span class="string">'BackgroundColor'</span>,[.9 .9 .9]);
2964 <span class="keyword">end</span>
2965 
2966 <a name="_sub77" href="#_subfunctions" class="code">function popupTypeOfPlot_CreateFcn(hObject, ~, ~)</a>
2967 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
2968     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
2969 <span class="keyword">end</span>
2970 
2971 <a name="_sub78" href="#_subfunctions" class="code">function popupDisplayOption_CreateFcn(hObject, ~, ~)</a>
2972 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
2973     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
2974 <span class="keyword">end</span>
2975 
2976 <a name="_sub79" href="#_subfunctions" class="code">function sliderBeamSelection_CreateFcn(hObject, ~, ~)</a>
2977 <span class="keyword">if</span> isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
2978     set(hObject,<span class="string">'BackgroundColor'</span>,[.9 .9 .9]);
2979 <span class="keyword">end</span>
2980 
2981 <a name="_sub80" href="#_subfunctions" class="code">function listBoxCmd_CreateFcn(hObject, ~, ~)</a>
2982 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
2983     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
2984 <span class="keyword">end</span>
2985 
2986 <a name="_sub81" href="#_subfunctions" class="code">function sliderOffset_CreateFcn(hObject, ~, ~)</a>
2987 <span class="keyword">if</span> isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
2988     set(hObject,<span class="string">'BackgroundColor'</span>,[.9 .9 .9]);
2989 <span class="keyword">end</span>
2990 
2991 <span class="comment">% --- Executes on selection change in legendTable.</span>
2992 <a name="_sub82" href="#_subfunctions" class="code">function legendTable_Callback(hObject, eventdata, handles)</a>
2993 <span class="comment">% hObject    handle to legendTable (see GCBO)</span>
2994 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
2995 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
2996 
2997 <span class="comment">% Hints: contents = cellstr(get(hObject,'String')) returns legendTable contents as cell array</span>
2998 <span class="comment">%        contents{get(hObject,'Value')} returns selected item from legendTable</span>
2999 cst = evalin(<span class="string">'base'</span>,<span class="string">'cst'</span>);
3000 
3001 idx    = get(hObject,<span class="string">'Value'</span>);
3002 clr    = dec2hex(round(cst{idx,5}.visibleColor(:)*255),2)';
3003 clr    = [<span class="string">'#'</span>;clr(:)]';
3004 
3005 <span class="comment">%Get the string entries</span>
3006 tmpString = get(handles.legendTable,<span class="string">'String'</span>);
3007 
3008 <span class="keyword">if</span> handles.VOIPlotFlag(idx)
3009     handles.VOIPlotFlag(idx) = false;
3010     cst{idx,5}.Visible = false;
3011     tmpString{idx} = [<span class="string">'&lt;html&gt;&lt;table border=0 &gt;&lt;TR&gt;&lt;TD bgcolor='</span>,clr,<span class="string">' width=&quot;18&quot;&gt;&lt;/TD&gt;&lt;TD&gt;'</span>,cst{idx,2},<span class="string">'&lt;/TD&gt;&lt;/TR&gt; &lt;/table&gt;&lt;/html&gt;'</span>];
3012 <span class="keyword">elseif</span> ~handles.VOIPlotFlag(idx)
3013     handles.VOIPlotFlag(idx) = true;
3014     cst{idx,5}.Visible = true;
3015     tmpString{idx} = [<span class="string">'&lt;html&gt;&lt;table border=0 &gt;&lt;TR&gt;&lt;TD bgcolor='</span>,clr,<span class="string">' width=&quot;18&quot;&gt;&lt;center&gt;&amp;#10004;&lt;/center&gt;&lt;/TD&gt;&lt;TD&gt;'</span>,cst{idx,2},<span class="string">'&lt;/TD&gt;&lt;/TR&gt; &lt;/table&gt;&lt;/html&gt;'</span>];
3016 <span class="keyword">end</span>
3017 set(handles.legendTable,<span class="string">'String'</span>,tmpString);
3018 
3019 <span class="comment">% update cst in workspace accordingly</span>
3020 assignin(<span class="string">'base'</span>,<span class="string">'cst'</span>,cst)
3021 
3022 guidata(hObject, handles);
3023 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles)
3024 
3025 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
3026 <a name="_sub83" href="#_subfunctions" class="code">function legendTable_CreateFcn(hObject, eventdata, handles)</a>
3027 <span class="comment">% hObject    handle to legendTable (see GCBO)</span>
3028 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3029 <span class="comment">% handles    empty - handles not created until after all CreateFcns called</span>
3030 
3031 <span class="comment">% Hint: listbox controls usually have a white background on Windows.</span>
3032 <span class="comment">%       See ISPC and COMPUTER.</span>
3033 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
3034     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
3035 <span class="keyword">end</span>
3036 
3037 
3038 <span class="comment">% --- Executes on button press in importDoseButton.</span>
3039 <a name="_sub84" href="#_subfunctions" class="code">function importDoseButton_Callback(hObject,eventdata, handles)</a>
3040 <span class="comment">% hObject    handle to importDoseButton (see GCBO)</span>
3041 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3042 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
3043 extensions{1} = <span class="string">'*.nrrd'</span>;
3044 [filenames,filepath,~] = uigetfile(extensions,<span class="string">'MultiSelect'</span>,<span class="string">'on'</span>);
3045 
3046 <span class="keyword">if</span> ~iscell(filenames)
3047     tmp = filenames;
3048     filenames = cell(1);
3049     filenames{1} = tmp;
3050 <span class="keyword">end</span>
3051 
3052 ct = evalin(<span class="string">'base'</span>,<span class="string">'ct'</span>);
3053 resultGUI = evalin(<span class="string">'base'</span>,<span class="string">'resultGUI'</span>);
3054 
3055 <span class="keyword">for</span> filename = filenames
3056     [~,name,~] = fileparts(filename{1});
3057     [cube,~] = <a href="../matRad/IO/matRad_readCube.html" class="code" title="function [cube, metadata] = matRad_readCube(filename)">matRad_readCube</a>(fullfile(filepath,filename{1}));
3058     <span class="keyword">if</span> ~isequal(ct.cubeDim, size(cube))
3059         errordlg(<span class="string">'Dimensions of the imported cube do not match with ct'</span>,<span class="string">'Import failed!'</span>,<span class="string">'modal'</span>);
3060         <span class="keyword">continue</span>;
3061     <span class="keyword">end</span>
3062     
3063     fieldname = [<span class="string">'import_'</span> matlab.lang.makeValidName(name, <span class="string">'ReplacementStyle'</span>,<span class="string">'delete'</span>)];
3064     resultGUI.(fieldname) = cube;
3065 <span class="keyword">end</span>
3066 
3067 assignin(<span class="string">'base'</span>,<span class="string">'resultGUI'</span>,resultGUI);
3068 <a href="#_sub44" class="code" title="subfunction btnRefresh_Callback(hObject, ~, handles)">btnRefresh_Callback</a>(hObject, eventdata, handles)
3069 
3070 <span class="comment">% --- Executes on button press in pushbutton_importFromBinary.</span>
3071 <a name="_sub85" href="#_subfunctions" class="code">function pushbutton_importFromBinary_Callback(hObject, eventdata, handles)</a>
3072 <span class="comment">% hObject    handle to pushbutton_importFromBinary (see GCBO)</span>
3073 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3074 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
3075 
3076 <span class="keyword">try</span>
3077     <span class="comment">% delete existing workspace - parse variables from base workspace</span>
3078     set(handles.popupDisplayOption,<span class="string">'String'</span>,<span class="string">'no option available'</span>);
3079     AllVarNames = evalin(<span class="string">'base'</span>,<span class="string">'who'</span>);
3080     RefVarNames = {<span class="string">'ct'</span>,<span class="string">'cst'</span>,<span class="string">'pln'</span>,<span class="string">'stf'</span>,<span class="string">'dij'</span>,<span class="string">'resultGUI'</span>};
3081     <span class="keyword">for</span> i = 1:length(RefVarNames)  
3082         <span class="keyword">if</span> sum(ismember(AllVarNames,RefVarNames{i}))&gt;0
3083             evalin(<span class="string">'base'</span>,[<span class="string">'clear '</span>, RefVarNames{i}]);
3084         <span class="keyword">end</span>
3085     <span class="keyword">end</span>
3086     handles.State = 0;
3087 
3088     <span class="comment">%call the gui</span>
3089     uiwait(<a href="../matRad/IO/matRad_importGUI.html" class="code" title="function varargout = matRad_importGUI(varargin)">matRad_importGUI</a>);
3090     
3091     <span class="comment">%Check if we have the variables in the workspace</span>
3092     <span class="keyword">if</span> evalin(<span class="string">'base'</span>,<span class="string">'exist(''cst'',''var'')'</span>) == 1 &amp;&amp; evalin(<span class="string">'base'</span>,<span class="string">'exist(''ct'',''var'')'</span>) == 1
3093         cst = evalin(<span class="string">'base'</span>,<span class="string">'cst'</span>);
3094         ct = evalin(<span class="string">'base'</span>,<span class="string">'ct'</span>);
3095         <span class="comment">%setCstTable(handles,cst);</span>
3096         <a href="#_sub116" class="code" title="subfunction cst = generateCstTable(handles,cst)">generateCstTable</a>(handles,cst);
3097         handles.TableChanged = false;
3098         set(handles.popupTypeOfPlot,<span class="string">'Value'</span>,1);
3099         
3100         <span class="comment">% compute HU values</span>
3101         <span class="keyword">if</span> ~isfield(ct, <span class="string">'cubeHU'</span>)
3102             ct = <a href="matRad_electronDensitiesToHU.html" class="code" title="function ct = matRad_electronDensitiesToHU(ct)">matRad_electronDensitiesToHU</a>(ct);
3103             assignin(<span class="string">'base'</span>,<span class="string">'ct'</span>,ct);
3104         <span class="keyword">end</span>
3105         <span class="keyword">if</span> ~isfield(ct, <span class="string">'cubeHU'</span>)
3106             handles.cubeHUavailable = false;
3107         <span class="keyword">else</span>
3108             handles.cubeHUavailable = true;
3109         <span class="keyword">end</span>
3110         
3111         <span class="comment">% precompute contours</span>
3112         cst = <a href="#_sub63" class="code" title="subfunction cst = precomputeContours(ct,cst)">precomputeContours</a>(ct,cst);
3113     
3114         assignin(<span class="string">'base'</span>,<span class="string">'ct'</span>,ct);
3115         assignin(<span class="string">'base'</span>,<span class="string">'cst'</span>,cst);
3116         
3117         <span class="keyword">if</span> evalin(<span class="string">'base'</span>,<span class="string">'exist(''pln'',''var'')'</span>)
3118             assignin(<span class="string">'base'</span>,<span class="string">'pln'</span>,pln);
3119             <a href="#_sub30" class="code" title="subfunction setPln(handles)">setPln</a>(handles);
3120         <span class="keyword">else</span>
3121             <a href="#_sub36" class="code" title="subfunction getPlnFromGUI(handles)">getPlnFromGUI</a>(handles);
3122             <a href="#_sub30" class="code" title="subfunction setPln(handles)">setPln</a>(handles);
3123         <span class="keyword">end</span>
3124         handles.State = 1;
3125     <span class="keyword">end</span>
3126     
3127     <span class="comment">% set slice slider</span>
3128     handles.plane = get(handles.popupPlane,<span class="string">'value'</span>);
3129     <span class="keyword">if</span> handles.State &gt;0
3130         set(handles.sliderSlice,<span class="string">'Min'</span>,1,<span class="string">'Max'</span>,ct.cubeDim(handles.plane),<span class="keyword">...</span>
3131             <span class="string">'Value'</span>,round(ct.cubeDim(handles.plane)/2),<span class="keyword">...</span>
3132             <span class="string">'SliderStep'</span>,[1/(ct.cubeDim(handles.plane)-1) 1/(ct.cubeDim(handles.plane)-1)]);
3133     <span class="keyword">end</span>
3134 
3135     <span class="keyword">if</span> handles.State &gt; 0
3136         <span class="comment">% define context menu for structures</span>
3137         <span class="keyword">for</span> i = 1:size(cst,1)
3138             <span class="keyword">if</span> cst{i,5}.Visible
3139                 handles.VOIPlotFlag(i) = true;
3140             <span class="keyword">else</span>
3141                 handles.VOIPlotFlag(i) = false;
3142             <span class="keyword">end</span>
3143         <span class="keyword">end</span>
3144     <span class="keyword">end</span>
3145     
3146     handles.dispWindow = cell(3,2);
3147     handles.cBarChanged = true;
3148     
3149     <a href="#_sub29" class="code" title="subfunction UpdateState(handles)">UpdateState</a>(handles);
3150     handles.rememberCurrAxes = false;
3151     <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles);
3152     handles.rememberCurrAxes = true;
3153 <span class="keyword">catch</span>
3154    handles = <a href="#_sub38" class="code" title="subfunction handles = showError(handles,Message,ME)">showError</a>(handles,<span class="string">'Binary Patient Import: Could not import data'</span>);
3155    <a href="#_sub29" class="code" title="subfunction UpdateState(handles)">UpdateState</a>(handles);
3156 <span class="keyword">end</span>
3157 
3158 guidata(hObject,handles);
3159 
3160 <span class="comment">% --- Executes on button press in radioBtnIsoCenter.</span>
3161 <a name="_sub86" href="#_subfunctions" class="code">function radioBtnIsoCenter_Callback(hObject, eventdata, handles)</a>
3162 <span class="comment">% hObject    handle to radioBtnIsoCenter (see GCBO)</span>
3163 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3164 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
3165 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles)
3166 <span class="comment">% Hint: get(hObject,'Value') returns toggle state of radioBtnIsoCenter</span>
3167 
3168 <span class="comment">% --------------------------------------------------------------------</span>
3169 <a name="_sub87" href="#_subfunctions" class="code">function uipushtool_screenshot_ClickedCallback(hObject, eventdata, handles)</a>
3170 <span class="comment">% hObject    handle to uipushtool_screenshot (see GCBO)</span>
3171 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3172 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
3173 
3174  
3175 tmpFig = figure(<span class="string">'position'</span>,[100 100 700 600],<span class="string">'Visible'</span>,<span class="string">'off'</span>,<span class="string">'name'</span>,<span class="string">'Current View'</span>); 
3176 cBarHandle = findobj(handles.figure1,<span class="string">'Type'</span>,<span class="string">'colorbar'</span>);
3177 <span class="keyword">if</span> ~isempty(cBarHandle)
3178     new_handle = copyobj([handles.axesFig cBarHandle],tmpFig);
3179 <span class="keyword">else</span>
3180     new_handle = copyobj(handles.axesFig,tmpFig);
3181 <span class="keyword">end</span>
3182 
3183 oldPos = get(handles.axesFig,<span class="string">'Position'</span>);
3184 set(new_handle(1),<span class="string">'units'</span>,<span class="string">'normalized'</span>, <span class="string">'Position'</span>,oldPos);
3185 
3186 <span class="keyword">if</span> ~isfield(handles,<span class="string">'lastStoragePath'</span>) || exist(handles.lastStoragePath,<span class="string">'dir'</span>) ~= 7
3187     lastStoragePath = [];   
3188 <span class="keyword">else</span>
3189     lastStoragePath = handles.lastStoragePath;
3190 <span class="keyword">end</span>
3191 
3192 [filename, pathname] = uiputfile({<span class="string">'*.jpg;*.tif;*.png;*.gif'</span>,<span class="string">'All Image Files'</span>; <span class="string">'*.fig'</span>,<span class="string">'MATLAB figure file'</span>},<span class="string">'Save current view'</span>,[lastStoragePath <span class="string">'screenshot.png'</span>]);
3193 
3194 
3195 
3196 <span class="keyword">if</span> ~isequal(filename,0) &amp;&amp; ~isequal(pathname,0)
3197     handles.lastStoragePath = pathname;
3198     set(gcf, <span class="string">'pointer'</span>, <span class="string">'watch'</span>);
3199     saveas(tmpFig,fullfile(pathname,filename));
3200     set(gcf, <span class="string">'pointer'</span>, <span class="string">'arrow'</span>);
3201     close(tmpFig);
3202     uiwait(msgbox(<span class="string">'Current view has been succesfully saved!'</span>));
3203 <span class="keyword">else</span>
3204     uiwait(msgbox(<span class="string">'Aborted saving, showing figure instead!'</span>));
3205     set(tmpFig,<span class="string">'Visible'</span>,<span class="string">'on'</span>);
3206 <span class="keyword">end</span>
3207 
3208 guidata(hObject,handles);
3209 
3210 
3211 <span class="comment">%% Callbacks &amp; Functions for color setting</span>
3212 <a name="_sub88" href="#_subfunctions" class="code">function UpdateColormapOptions(handles)</a>
3213 
3214 <span class="keyword">if</span> isfield(handles,<span class="string">'colormapLocked'</span>) &amp;&amp; handles.colormapLocked
3215     <span class="keyword">return</span>;
3216 <span class="keyword">end</span>
3217 
3218 selectionIndex = get(handles.popupmenu_chooseColorData,<span class="string">'Value'</span>);
3219 
3220 cMapSelectionIndex = get(handles.popupmenu_chooseColormap,<span class="string">'Value'</span>);
3221 cMapStrings = get(handles.popupmenu_chooseColormap,<span class="string">'String'</span>);
3222 
3223 <span class="keyword">if</span> selectionIndex &gt; 1 
3224     set(handles.uitoggletool8,<span class="string">'State'</span>,<span class="string">'on'</span>);
3225 <span class="keyword">else</span>
3226     set(handles.uitoggletool8,<span class="string">'State'</span>,<span class="string">'off'</span>);
3227 <span class="keyword">end</span>
3228 
3229 <span class="keyword">try</span> 
3230     <span class="keyword">if</span> selectionIndex == 2
3231         ct = evalin(<span class="string">'base'</span>,<span class="string">'ct'</span>);
3232         currentMap = handles.ctColorMap;
3233         window = handles.dispWindow{selectionIndex,1};
3234         <span class="keyword">if</span> handles.cubeHUavailable
3235             minMax = [min(ct.cubeHU{1}(:)) max(ct.cubeHU{1}(:))];            
3236         <span class="keyword">else</span>
3237             minMax = [min(ct.cube{1}(:)) max(ct.cube{1}(:))];
3238         <span class="keyword">end</span>
3239         <span class="comment">% adjust value for custom window to current</span>
3240         handles.windowPresets(1).width = max(window) - min(window);
3241         handles.windowPresets(1).center = mean(window);
3242         <span class="comment">% update full window information</span>
3243         handles.windowPresets(2).width = minMax(2) - minMax(1);
3244         handles.windowPresets(2).center = mean(minMax);
3245     <span class="keyword">elseif</span> selectionIndex == 3
3246         result = evalin(<span class="string">'base'</span>,<span class="string">'resultGUI'</span>);        
3247         dose = result.(handles.SelectedDisplayOption);
3248         currentMap = handles.doseColorMap;
3249         minMax = [min(dose(:)) max(dose(:))];
3250         window = handles.dispWindow{selectionIndex,1};
3251     <span class="keyword">else</span>
3252         window = [0 1];
3253         minMax = window;
3254         currentMap = <span class="string">'bone'</span>;
3255     <span class="keyword">end</span>
3256 <span class="keyword">catch</span>
3257     window = [0 1];
3258     minMax = window;
3259     currentMap = <span class="string">'bone'</span>;
3260 <span class="keyword">end</span>
3261 
3262 valueRange = minMax(2) - minMax(1);
3263 
3264 windowWidth = window(2) - window(1);
3265 windowCenter = mean(window);
3266 
3267 <span class="comment">%This are some arbritrary settings to configure the sliders</span>
3268 sliderCenterMinMax = [minMax(1)-valueRange/2 minMax(2)+valueRange/2];
3269 sliderWidthMinMax = [0 valueRange*2];
3270 
3271 <span class="comment">%if we have selected a value outside this range, we adapt the slider</span>
3272 <span class="comment">%windows</span>
3273 <span class="keyword">if</span> windowCenter &lt; sliderCenterMinMax(1)
3274     sliderCenterMinMax(1) = windowCenter;
3275 <span class="keyword">end</span>
3276 <span class="keyword">if</span> windowCenter &gt; sliderCenterMinMax(2)
3277     sliderCenterMinMax(2) = windowCenter;
3278 <span class="keyword">end</span>
3279 <span class="keyword">if</span> windowWidth &lt; sliderWidthMinMax(1)
3280     sliderWidthMinMax(1) = windowWidth;
3281 <span class="keyword">end</span>
3282 <span class="keyword">if</span> windowCenter &gt; sliderCenterMinMax(2)
3283     sliderWidthMinMax(2) = windowWidth;
3284 <span class="keyword">end</span>
3285 
3286 
3287 set(handles.edit_windowCenter,<span class="string">'String'</span>,num2str(windowCenter,3));    
3288 set(handles.edit_windowWidth,<span class="string">'String'</span>,num2str(windowWidth,3));
3289 set(handles.edit_windowRange,<span class="string">'String'</span>,num2str(window,4));
3290 set(handles.slider_windowCenter,<span class="string">'Min'</span>,sliderCenterMinMax(1),<span class="string">'Max'</span>,sliderCenterMinMax(2),<span class="string">'Value'</span>,windowCenter);
3291 set(handles.slider_windowWidth,<span class="string">'Min'</span>,sliderWidthMinMax(1),<span class="string">'Max'</span>,sliderWidthMinMax(2),<span class="string">'Value'</span>,windowWidth);
3292 
3293 cMapPopupIndex = find(strcmp(currentMap,cMapStrings));
3294 set(handles.popupmenu_chooseColormap,<span class="string">'Value'</span>,cMapPopupIndex);
3295 
3296 guidata(gcf,handles);
3297 
3298 <span class="comment">% --- Executes on selection change in popupmenu_chooseColorData.</span>
3299 <a name="_sub89" href="#_subfunctions" class="code">function popupmenu_chooseColorData_Callback(hObject, eventdata, handles)</a>
3300 <span class="comment">% hObject    handle to popupmenu_chooseColorData (see GCBO)</span>
3301 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3302 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
3303 
3304 <span class="comment">% Hints: contents = cellstr(get(hObject,'String')) returns popupmenu_chooseColorData contents as cell array</span>
3305 <span class="comment">%        contents{get(hObject,'Value')} returns selected item from popupmenu_chooseColorData</span>
3306 
3307 <span class="comment">%index = get(hObject,'Value') - 1;</span>
3308 
3309 handles.cBarChanged = true;
3310 
3311 guidata(hObject,handles);
3312 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles);
3313 
3314 
3315 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
3316 <a name="_sub90" href="#_subfunctions" class="code">function popupmenu_chooseColorData_CreateFcn(hObject, eventdata, handles)</a>
3317 <span class="comment">% hObject    handle to popupmenu_chooseColorData (see GCBO)</span>
3318 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3319 <span class="comment">% handles    empty - handles not created until after all CreateFcns called</span>
3320 
3321 <span class="comment">% Hint: popupmenu controls usually have a white background on Windows.</span>
3322 <span class="comment">%       See ISPC and COMPUTER.</span>
3323 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
3324     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
3325 <span class="keyword">end</span>
3326 
3327 
3328 <span class="comment">% --- Executes on slider movement.</span>
3329 <a name="_sub91" href="#_subfunctions" class="code">function slider_windowCenter_Callback(hObject, eventdata, handles)</a>
3330 <span class="comment">% hObject    handle to slider_windowCenter (see GCBO)</span>
3331 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3332 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
3333 
3334 <span class="comment">% Hints: get(hObject,'Value') returns position of slider</span>
3335 <span class="comment">%        get(hObject,'Min') and get(hObject,'Max') to determine range of slider</span>
3336 
3337 newCenter      = get(hObject,<span class="string">'Value'</span>);
3338 range          = get(handles.slider_windowWidth,<span class="string">'Value'</span>);
3339 selectionIndex = get(handles.popupmenu_chooseColorData,<span class="string">'Value'</span>);
3340 
3341 handles.dispWindow{selectionIndex,1}  = [newCenter-range/2 newCenter+range/2];
3342 handles.cBarChanged = true;
3343 
3344 guidata(hObject,handles);
3345 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles);
3346 
3347 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
3348 <a name="_sub92" href="#_subfunctions" class="code">function slider_windowCenter_CreateFcn(hObject, eventdata, handles)</a>
3349 <span class="comment">% hObject    handle to slider_windowCenter (see GCBO)</span>
3350 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3351 <span class="comment">% handles    empty - handles not created until after all CreateFcns called</span>
3352 
3353 <span class="comment">% Hint: slider controls usually have a light gray background.</span>
3354 <span class="keyword">if</span> isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
3355     set(hObject,<span class="string">'BackgroundColor'</span>,[.9 .9 .9]);
3356 <span class="keyword">end</span>
3357 
3358 set(hObject,<span class="string">'Value'</span>,0.5);
3359 
3360 <span class="comment">% --- Executes on slider movement.</span>
3361 <a name="_sub93" href="#_subfunctions" class="code">function slider_windowWidth_Callback(hObject, eventdata, handles)</a>
3362 <span class="comment">% hObject    handle to slider_windowWidth (see GCBO)</span>
3363 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3364 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
3365 
3366 <span class="comment">% Hints: get(hObject,'Value') returns position of slider</span>
3367 <span class="comment">%        get(hObject,'Min') and get(hObject,'Max') to determine range of slider</span>
3368 
3369 newWidth = get(hObject,<span class="string">'Value'</span>);
3370 center   = get(handles.slider_windowCenter,<span class="string">'Value'</span>);
3371 selectionIndex                        = get(handles.popupmenu_chooseColorData,<span class="string">'Value'</span>);
3372 handles.dispWindow{selectionIndex,1}  = [center-newWidth/2 center+newWidth/2];
3373 handles.cBarChanged = true;
3374 
3375 guidata(hObject,handles);
3376 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles);
3377 
3378 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
3379 <a name="_sub94" href="#_subfunctions" class="code">function slider_windowWidth_CreateFcn(hObject, eventdata, handles)</a>
3380 <span class="comment">% hObject    handle to slider_windowWidth (see GCBO)</span>
3381 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3382 <span class="comment">% handles    empty - handles not created until after all CreateFcns called</span>
3383 
3384 <span class="comment">% Hint: slider controls usually have a light gray background.</span>
3385 <span class="keyword">if</span> isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
3386     set(hObject,<span class="string">'BackgroundColor'</span>,[.9 .9 .9]);
3387 <span class="keyword">end</span>
3388 
3389 set(hObject,<span class="string">'Value'</span>,1.0);
3390 
3391 
3392 <span class="comment">% --- Executes on selection change in popupmenu_chooseColormap.</span>
3393 <a name="_sub95" href="#_subfunctions" class="code">function popupmenu_chooseColormap_Callback(hObject, eventdata, handles)</a>
3394 <span class="comment">% hObject    handle to popupmenu_chooseColormap (see GCBO)</span>
3395 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3396 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
3397 
3398 <span class="comment">% Hints: contents = cellstr(get(hObject,'String')) returns popupmenu_chooseColormap contents as cell array</span>
3399 <span class="comment">%        contents{get(hObject,'Value')} returns selected item from popupmenu_chooseColormap</span>
3400 
3401 index = get(hObject,<span class="string">'Value'</span>);
3402 strings = get(hObject,<span class="string">'String'</span>);
3403 
3404 selectionIndex = get(handles.popupmenu_chooseColorData,<span class="string">'Value'</span>);
3405 
3406 <span class="keyword">switch</span> selectionIndex 
3407     <span class="keyword">case</span> 2
3408         handles.ctColorMap = strings{index};
3409     <span class="keyword">case</span> 3
3410         handles.doseColorMap = strings{index};
3411     <span class="keyword">otherwise</span>
3412 <span class="keyword">end</span>
3413 
3414 handles.cBarChanged = true;
3415 
3416 guidata(hObject,handles);
3417 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles);
3418 
3419 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
3420 <a name="_sub96" href="#_subfunctions" class="code">function popupmenu_chooseColormap_CreateFcn(hObject, eventdata, handles)</a>
3421 <span class="comment">% hObject    handle to popupmenu_chooseColormap (see GCBO)</span>
3422 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3423 <span class="comment">% handles    empty - handles not created until after all CreateFcns called</span>
3424 
3425 <span class="comment">% Hint: popupmenu controls usually have a white background on Windows.</span>
3426 <span class="comment">%       See ISPC and COMPUTER.</span>
3427 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
3428     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
3429 <span class="keyword">end</span>
3430 
3431 
3432 <a name="_sub97" href="#_subfunctions" class="code">function edit_windowRange_Callback(hObject, eventdata, handles)</a>
3433 <span class="comment">% hObject    handle to edit_windowRange (see GCBO)</span>
3434 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3435 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
3436 
3437 <span class="comment">% Hints: get(hObject,'String') returns contents of edit_windowRange as text</span>
3438 <span class="comment">%        str2double(get(hObject,'String')) returns contents of edit_windowRange as a double</span>
3439 
3440 selectionIndex = get(handles.popupmenu_chooseColorData,<span class="string">'Value'</span>);
3441 vRange         = str2num(get(hObject,<span class="string">'String'</span>));
3442 <span class="comment">% matlab adds a zero in the beginning when text field is changed</span>
3443 <span class="keyword">if</span> numel(vRange) == 3
3444     vRange = vRange(vRange~=0);
3445 <span class="keyword">end</span>
3446 
3447 handles.dispWindow{selectionIndex,1} = sort(vRange);
3448 
3449 handles.cBarChanged = true;
3450 
3451     <span class="comment">% compute new iso dose lines</span>
3452 <span class="keyword">if</span> selectionIndex &gt; 2 
3453     guidata(hObject,handles);
3454     handles = <a href="#_sub64" class="code" title="subfunction handles = updateIsoDoseLineCache(handles)">updateIsoDoseLineCache</a>(handles);
3455 <span class="keyword">end</span>
3456 
3457 guidata(hObject,handles);
3458 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles);
3459 
3460 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
3461 <a name="_sub98" href="#_subfunctions" class="code">function edit_windowRange_CreateFcn(hObject, eventdata, handles)</a>
3462 <span class="comment">% hObject    handle to edit_windowRange (see GCBO)</span>
3463 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3464 <span class="comment">% handles    empty - handles not created until after all CreateFcns called</span>
3465 
3466 <span class="comment">% Hint: edit controls usually have a white background on Windows.</span>
3467 <span class="comment">%       See ISPC and COMPUTER.</span>
3468 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
3469     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
3470 <span class="keyword">end</span>
3471 
3472 set(hObject,<span class="string">'String'</span>,<span class="string">'0 1'</span>);
3473 
3474 
3475 <a name="_sub99" href="#_subfunctions" class="code">function edit_windowCenter_Callback(hObject, eventdata, handles)</a>
3476 <span class="comment">% hObject    handle to edit_windowCenter (see GCBO)</span>
3477 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3478 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
3479 
3480 <span class="comment">% Hints: get(hObject,'String') returns contents of edit_windowCenter as text</span>
3481 <span class="comment">%        str2double(get(hObject,'String')) returns contents of edit_windowCenter as a double</span>
3482 
3483 newCenter           = str2double(get(hObject,<span class="string">'String'</span>));
3484 width               = get(handles.slider_windowWidth,<span class="string">'Value'</span>);
3485 selectionIndex      = get(handles.popupmenu_chooseColorData,<span class="string">'Value'</span>);
3486 handles.dispWindow{selectionIndex,1}  = [newCenter-width/2 newCenter+width/2];
3487 handles.cBarChanged = true;
3488 guidata(hObject,handles);
3489 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles);
3490 
3491 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
3492 <a name="_sub100" href="#_subfunctions" class="code">function edit_windowCenter_CreateFcn(hObject, eventdata, handles)</a>
3493 <span class="comment">% hObject    handle to edit_windowCenter (see GCBO)</span>
3494 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3495 <span class="comment">% handles    empty - handles not created until after all CreateFcns called</span>
3496 
3497 <span class="comment">% Hint: edit controls usually have a white background on Windows.</span>
3498 <span class="comment">%       See ISPC and COMPUTER.</span>
3499 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
3500     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
3501 <span class="keyword">end</span>
3502 
3503 
3504 
3505 <a name="_sub101" href="#_subfunctions" class="code">function edit_windowWidth_Callback(hObject, eventdata, handles)</a>
3506 <span class="comment">% hObject    handle to edit_windowWidth (see GCBO)</span>
3507 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3508 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
3509 
3510 <span class="comment">% Hints: get(hObject,'String') returns contents of edit_windowWidth as text</span>
3511 <span class="comment">%        str2double(get(hObject,'String')) returns contents of edit_windowWidth as a double</span>
3512 
3513 newWidth            = str2double(get(hObject,<span class="string">'String'</span>));
3514 center              = get(handles.slider_windowCenter,<span class="string">'Value'</span>);
3515 selectionIndex      = get(handles.popupmenu_chooseColorData,<span class="string">'Value'</span>);
3516 handles.dispWindow{selectionIndex,1}  = [center-newWidth/2 center+newWidth/2];
3517 handles.cBarChanged = true;
3518 guidata(hObject,handles);
3519 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles);
3520 
3521 
3522 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
3523 <a name="_sub102" href="#_subfunctions" class="code">function edit_windowWidth_CreateFcn(hObject, eventdata, handles)</a>
3524 <span class="comment">% hObject    handle to edit_windowWidth (see GCBO)</span>
3525 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3526 <span class="comment">% handles    empty - handles not created until after all CreateFcns called</span>
3527 
3528 <span class="comment">% Hint: edit controls usually have a white background on Windows.</span>
3529 <span class="comment">%       See ISPC and COMPUTER.</span>
3530 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
3531     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
3532 <span class="keyword">end</span>
3533 
3534 
3535 <span class="comment">% --------------------------------------------------------------------</span>
3536 <a name="_sub103" href="#_subfunctions" class="code">function uitoggletool8_ClickedCallback(hObject, eventdata, handles)</a>
3537 <span class="comment">% hObject    handle to uitoggletool8 (see GCBO)</span>
3538 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3539 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
3540 
3541 <span class="comment">%Check if on or off</span>
3542 val = strcmp(get(hObject,<span class="string">'State'</span>),<span class="string">'on'</span>);
3543 
3544 <span class="comment">%Now we have to apply the new selection to our colormap options panel</span>
3545 <span class="keyword">if</span> ~val
3546     newSelection = 1;
3547 <span class="keyword">else</span>
3548     <span class="comment">%Chooses the selection from the highest state</span>
3549     selections = get(handles.popupmenu_chooseColorData,<span class="string">'String'</span>);
3550     newSelection = numel(selections);
3551 <span class="keyword">end</span>    
3552 set(handles.popupmenu_chooseColorData,<span class="string">'Value'</span>,newSelection);
3553 
3554 handles.cBarChanged = true;
3555 guidata(hObject,handles);
3556 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles);
3557 
3558 <span class="comment">% --- Executes on slider movement.</span>
3559 <a name="_sub104" href="#_subfunctions" class="code">function sliderOpacity_Callback(hObject, eventdata, handles)</a>
3560 <span class="comment">% hObject    handle to sliderOpacity (see GCBO)</span>
3561 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3562 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
3563 handles.doseOpacity = get(hObject,<span class="string">'Value'</span>);
3564 guidata(hObject,handles);
3565 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles);
3566 
3567 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
3568 <a name="_sub105" href="#_subfunctions" class="code">function sliderOpacity_CreateFcn(hObject, eventdata, handles)</a>
3569 <span class="comment">% hObject    handle to sliderOpacity (see GCBO)</span>
3570 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3571 <span class="comment">% handles    empty - handles not created until after all CreateFcns called</span>
3572 
3573 <span class="comment">% Hint: slider controls usually have a light gray background.</span>
3574 <span class="keyword">if</span> isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
3575     set(hObject,<span class="string">'BackgroundColor'</span>,[.9 .9 .9]);
3576 <span class="keyword">end</span>
3577 
3578 <span class="comment">%% Data Cursors</span>
3579 <a name="_sub106" href="#_subfunctions" class="code">function cursorText = dataCursorUpdateFunction(obj,event_obj)</a>
3580 <span class="comment">% Display the position of the data cursor</span>
3581 <span class="comment">% obj          Currently not used (empty)</span>
3582 <span class="comment">% event_obj    Handle to event object</span>
3583 <span class="comment">% output_txt   Data cursor text string (string or cell array of strings).</span>
3584 
3585 target = findall(0,<span class="string">'Name'</span>,<span class="string">'matRadGUI'</span>);
3586 
3587 <span class="comment">% Get GUI data (maybe there is another way?)</span>
3588 handles = guidata(target);
3589 
3590 <span class="comment">% position of the data point to label</span>
3591 pos = get(event_obj,<span class="string">'Position'</span>);
3592 
3593 <span class="comment">%Different behavior for image and profile plot</span>
3594 <span class="keyword">if</span> get(handles.popupTypeOfPlot,<span class="string">'Value'</span>)==1 <span class="comment">%Image view</span>
3595     cursorText = cell(0,1);
3596     <span class="keyword">try</span>   
3597         <span class="keyword">if</span> handles.State &gt;= 1
3598             plane = get(handles.popupPlane,<span class="string">'Value'</span>);
3599             slice = round(get(handles.sliderSlice,<span class="string">'Value'</span>));
3600             
3601             <span class="comment">%Get the CT values</span>
3602             ct  = evalin(<span class="string">'base'</span>,<span class="string">'ct'</span>);
3603             
3604             <span class="comment">%We differentiate between pos and ix, since the user may put</span>
3605             <span class="comment">%the datatip on an isoline which returns a continous position</span>
3606             cubePos = zeros(1,3);
3607             cubePos(plane) = slice;
3608             cubePos(1:end ~= plane) = fliplr(pos);            
3609             cubeIx = round(cubePos);
3610             
3611             <span class="comment">%Here comes the index permutation stuff</span>
3612             <span class="comment">%Cube Index</span>
3613             cursorText{end+1,1} = [<span class="string">'Cube Index: '</span> mat2str(cubeIx)];
3614             <span class="comment">%Space Coordinates</span>
3615             coords = zeros(1,3);
3616             coords(1) = cubePos(2)*ct.resolution.y;
3617             coords(2) = cubePos(1)*ct.resolution.x;
3618             coords(3) = cubePos(3)*ct.resolution.z;            
3619             cursorText{end+1,1} = [<span class="string">'Space Coordinates: '</span> mat2str(coords,5) <span class="string">' mm'</span>];
3620             
3621             ctVal = ct.cubeHU{1}(cubeIx(1),cubeIx(2),cubeIx(3));
3622             cursorText{end+1,1} = [<span class="string">'HU Value: '</span> num2str(ctVal,3)];
3623         <span class="keyword">end</span>
3624         
3625         <span class="comment">%Add dose information if available</span>
3626         <span class="keyword">if</span> handles.State == 3
3627             <span class="comment">%get result structure</span>
3628             result = evalin(<span class="string">'base'</span>,<span class="string">'resultGUI'</span>);
3629             
3630             <span class="comment">%Get all result names from popup</span>
3631             resultNames = get(handles.popupDisplayOption,<span class="string">'String'</span>);
3632             
3633             <span class="comment">%Display all values of fields found in the resultGUI struct</span>
3634             <span class="keyword">for</span> runResult = 1:numel(resultNames)               
3635                 name = resultNames{runResult};
3636                 <span class="keyword">if</span> isfield(result,name)
3637                     field = result.(name);
3638                     val = field(cubeIx(1),cubeIx(2),cubeIx(3));
3639                     cursorText{end+1,1} = [name <span class="string">': '</span> num2str(val,3)];
3640                 <span class="keyword">end</span>
3641             <span class="keyword">end</span>      
3642         <span class="keyword">end</span>
3643     <span class="keyword">catch</span>
3644         cursorText{end+1,1} = <span class="string">'Error while retreiving Data!'</span>;
3645     <span class="keyword">end</span>    
3646 <span class="keyword">else</span> <span class="comment">%Profile view</span>
3647     cursorText = cell(2,1);
3648     cursorText{1} = [<span class="string">'Radiological Depth: '</span> num2str(pos(1),3) <span class="string">' mm'</span>];
3649     cursorText{2} = [get(target,<span class="string">'DisplayName'</span>) <span class="string">': '</span> num2str(pos(2),3)];
3650 <span class="keyword">end</span>
3651 
3652 
3653 
3654 <span class="comment">% --- Executes on selection change in popMenuBioOpt.</span>
3655 <a name="_sub107" href="#_subfunctions" class="code">function popMenuBioOpt_Callback(hObject, ~, handles)</a>
3656 pln = evalin(<span class="string">'base'</span>,<span class="string">'pln'</span>);
3657 contentBioOpt = get(handles.popMenuBioOpt,<span class="string">'String'</span>);
3658 NewBioOptimization = contentBioOpt(get(handles.popMenuBioOpt,<span class="string">'Value'</span>),:);
3659 
3660 <span class="keyword">if</span> handles.State &gt; 0
3661     <span class="keyword">if</span> (strcmp(pln.propOpt.bioOptimization,<span class="string">'LEMIV_effect'</span>) &amp;&amp; strcmp(NewBioOptimization,<span class="string">'LEMIV_RBExD'</span>)) ||<span class="keyword">...</span>
3662        (strcmp(pln.propOpt.bioOptimization,<span class="string">'LEMIV_RBExD'</span>) &amp;&amp; strcmp(NewBioOptimization,<span class="string">'LEMIV_effect'</span>)) 
3663        <span class="comment">% do nothing - re-optimization is still possible</span>
3664     <span class="keyword">elseif</span> ((strcmp(pln.propOpt.bioOptimization,<span class="string">'const_RBE'</span>) &amp;&amp; strcmp(NewBioOptimization,<span class="string">'none'</span>)) ||<span class="keyword">...</span>
3665            (strcmp(pln.propOpt.bioOptimization,<span class="string">'none'</span>) &amp;&amp; strcmp(NewBioOptimization,<span class="string">'const_RBE'</span>))) &amp;&amp; isequal(pln.radiationMode,<span class="string">'protons'</span>)
3666        <span class="comment">% do nothing - re-optimization is still possible</span>
3667     <span class="keyword">else</span>
3668         handles.State = 1;
3669     <span class="keyword">end</span>
3670 <span class="keyword">end</span>
3671 <a href="#_sub36" class="code" title="subfunction getPlnFromGUI(handles)">getPlnFromGUI</a>(handles);
3672 
3673 <a href="#_sub29" class="code" title="subfunction UpdateState(handles)">UpdateState</a>(handles);
3674 guidata(hObject,handles);
3675 
3676 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
3677 <a name="_sub108" href="#_subfunctions" class="code">function popMenuBioOpt_CreateFcn(hObject, eventdata, handles)</a>
3678 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
3679     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
3680 <span class="keyword">end</span>
3681 
3682 <span class="comment">% --- Executes on button press in btn3Dview.</span>
3683 <a name="_sub109" href="#_subfunctions" class="code">function btn3Dview_Callback(hObject, eventdata, handles)</a>
3684 <span class="comment">% hObject    handle to btn3Dview (see GCBO)</span>
3685 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3686 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
3687 
3688 <span class="keyword">if</span> ~isfield(handles,<span class="string">'axesFig3D'</span>) || ~isfield(handles,<span class="string">'axesFig3D'</span>) || ~isgraphics(handles.axesFig3D)
3689     handles.fig3D = figure(<span class="string">'Name'</span>,<span class="string">'matRad 3D View'</span>);
3690     handles.axesFig3D = axes(<span class="string">'Parent'</span>,handles.fig3D);
3691     view(handles.axesFig3D,3);
3692     <span class="keyword">try</span>
3693         ct = evalin(<span class="string">'base'</span>,<span class="string">'ct'</span>);
3694     
3695         xlim(handles.axesFig3D,[0 ct.resolution.x*ct.cubeDim(2)]);
3696         ylim(handles.axesFig3D,[0 ct.resolution.y*ct.cubeDim(1)]);
3697         zlim(handles.axesFig3D,[0 ct.resolution.z*ct.cubeDim(3)]);
3698     <span class="keyword">catch</span>
3699     <span class="keyword">end</span>
3700 <span class="keyword">end</span>
3701 <span class="comment">%end</span>
3702 
3703 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles);
3704 
3705 guidata(hObject,handles);
3706 
3707 <span class="comment">% --- Executes on button press in radiobtnCT.</span>
3708 <a name="_sub110" href="#_subfunctions" class="code">function radiobtnCT_Callback(hObject, eventdata, handles)</a>
3709 <span class="comment">% hObject    handle to radiobtnCT (see GCBO)</span>
3710 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3711 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
3712 
3713 <span class="comment">% Hint: get(hObject,'Value') returns toggle state of radiobtnCT</span>
3714 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles)
3715 
3716 <span class="comment">% --- Executes on button press in radiobtnPlan.</span>
3717 <a name="_sub111" href="#_subfunctions" class="code">function radiobtnPlan_Callback(hObject, eventdata, handles)</a>
3718 <span class="comment">% hObject    handle to radiobtnPlan (see GCBO)</span>
3719 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3720 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
3721 
3722 <span class="comment">% Hint: get(hObject,'Value') returns toggle state of radiobtnPlan</span>
3723 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles)
3724 
3725 
3726 <span class="comment">% --- Executes on selection change in popupmenu_windowPreset.</span>
3727 <a name="_sub112" href="#_subfunctions" class="code">function popupmenu_windowPreset_Callback(hObject, eventdata, handles)</a>
3728 <span class="comment">% hObject    handle to popupmenu_windowPreset (see GCBO)</span>
3729 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3730 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
3731 
3732 <span class="comment">% Hints: contents = cellstr(get(hObject,'String')) returns popupmenu_windowPreset contents as cell array</span>
3733 <span class="comment">%        contents{get(hObject,'Value')} returns selected item from popupmenu_windowPreset</span>
3734 
3735 selectionIndexCube      = 2; <span class="comment">% working on ct only</span>
3736 selectionIndexWindow    = get(handles.popupmenu_windowPreset,<span class="string">'Value'</span>);
3737 newCenter               = handles.windowPresets(selectionIndexWindow).center;
3738 newWidth                = handles.windowPresets(selectionIndexWindow).width;
3739 
3740 handles.dispWindow{selectionIndexCube,1}  = [newCenter - newWidth/2 newCenter + newWidth/2];
3741 handles.cBarChanged = true;
3742 guidata(hObject,handles);
3743 <a href="#_sub16" class="code" title="subfunction UpdatePlot(handles)">UpdatePlot</a>(handles);
3744 <a href="#_sub88" class="code" title="subfunction UpdateColormapOptions(handles)">UpdateColormapOptions</a>(handles);
3745 
3746 
3747 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
3748 <a name="_sub113" href="#_subfunctions" class="code">function popupmenu_windowPreset_CreateFcn(hObject, eventdata, handles)</a>
3749 <span class="comment">% hObject    handle to popupmenu_windowPreset (see GCBO)</span>
3750 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3751 <span class="comment">% handles    empty - handles not created until after all CreateFcns called</span>
3752 
3753 <span class="comment">% Hint: popupmenu controls usually have a white background on Windows.</span>
3754 <span class="comment">%       See ISPC and COMPUTER.</span>
3755 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
3756     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
3757 <span class="keyword">end</span>
3758 
3759 <span class="comment">% setup ct window list</span>
3760 <span class="comment">% data and values from CERR https://github.com/adityaapte/CERR</span>
3761 windowNames = {<span class="string">'Custom'</span>,<span class="string">'Full'</span>,<span class="string">'Abd/Med'</span>, <span class="string">'Head'</span>, <span class="string">'Liver'</span>, <span class="string">'Lung'</span>, <span class="string">'Spine'</span>, <span class="string">'Vrt/Bone'</span>};
3762 windowCenter = {NaN, NaN, -10, 45, 80, -500, 30, 400};
3763 windowWidth = {NaN, NaN, 330, 125, 305, 1500, 300, 1500};
3764 windowPresets = cell2struct([windowNames', windowCenter', windowWidth'], {<span class="string">'name'</span>, <span class="string">'center'</span>, <span class="string">'width'</span>},2);
3765 
3766 
3767 handles.windowPresets = windowPresets;
3768 
3769 selectionList = {windowPresets(:).name};
3770 set(hObject,<span class="string">'String'</span>,selectionList(:));
3771 set(hObject,<span class="string">'Value'</span>,1);
3772 
3773 
3774 guidata(hObject,handles);
3775 
3776 <span class="comment">% --- Executes on button press in checkbox_lockColormap.</span>
3777 <a name="_sub114" href="#_subfunctions" class="code">function checkbox_lockColormap_Callback(hObject, eventdata, handles)</a>
3778 <span class="comment">% hObject    handle to checkbox_lockColormap (see GCBO)</span>
3779 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3780 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
3781 
3782 <span class="comment">% Hint: get(hObject,'Value') returns toggle state of checkbox_lockColormap</span>
3783 handles.colormapLocked = get(hObject,<span class="string">'Value'</span>);
3784 
3785 <span class="keyword">if</span> handles.colormapLocked
3786     state = <span class="string">'Off'</span>; <span class="comment">%'Inactive';</span>
3787 <span class="keyword">else</span>
3788     state = <span class="string">'On'</span>;
3789 <span class="keyword">end</span>
3790 
3791 set(handles.popupmenu_chooseColorData,<span class="string">'Enable'</span>,state);
3792 set(handles.popupmenu_windowPreset,<span class="string">'Enable'</span>,state);
3793 set(handles.slider_windowWidth,<span class="string">'Enable'</span>,state);
3794 set(handles.slider_windowCenter,<span class="string">'Enable'</span>,state);
3795 set(handles.edit_windowWidth,<span class="string">'Enable'</span>,state);
3796 set(handles.edit_windowCenter,<span class="string">'Enable'</span>,state);
3797 set(handles.edit_windowRange,<span class="string">'Enable'</span>,state);
3798 set(handles.popupmenu_chooseColormap,<span class="string">'Enable'</span>,state);
3799 
3800 
3801 guidata(hObject,handles);
3802 
3803 
3804 <a name="_sub115" href="#_subfunctions" class="code">function cst = updateStructureTable(handles,cst)</a>
3805 colorAssigned = true;
3806 
3807 <span class="comment">% check whether all structures have an assigned color</span>
3808 <span class="keyword">for</span> i = 1:size(cst,1)
3809     <span class="keyword">if</span> ~isfield(cst{i,5},<span class="string">'visibleColor'</span>)
3810         colorAssigned = false;
3811         <span class="keyword">break</span>;
3812     <span class="keyword">elseif</span> isempty(cst{i,5}.visibleColor)
3813         colorAssigned = false;
3814         <span class="keyword">break</span>;
3815     <span class="keyword">end</span>
3816 <span class="keyword">end</span>
3817 
3818 <span class="comment">% assign color if color assignment is not already present or inconsistent</span>
3819 <span class="keyword">if</span> colorAssigned == false
3820   m         = 64;
3821   colorStep = ceil(m/size(cst,1));
3822   colors    = colorcube(colorStep*size(cst,1));
3823   <span class="comment">% spread individual VOI colors in the colorcube color palette</span>
3824   colors    = colors(1:colorStep:<span class="keyword">end</span>,:);
3825   
3826   <span class="keyword">for</span> i = 1:size(cst,1)
3827     cst{i,5}.visibleColor = colors(i,:);
3828   <span class="keyword">end</span>
3829 <span class="keyword">end</span>
3830 
3831 <span class="keyword">for</span> s = 1:size(cst,1)
3832     handles.VOIPlotFlag(s) = cst{s,5}.Visible;
3833     clr = dec2hex(round(cst{s,5}.visibleColor(:)*255),2)';
3834     clr = [<span class="string">'#'</span>;clr(:)]';
3835     <span class="keyword">if</span> handles.VOIPlotFlag(s)
3836         tmpString{s} = [<span class="string">'&lt;html&gt;&lt;table border=0 &gt;&lt;TR&gt;&lt;TD bgcolor='</span>,clr,<span class="string">' width=&quot;18&quot;&gt;&lt;center&gt;&amp;#10004;&lt;/center&gt;&lt;/TD&gt;&lt;TD&gt;'</span>,cst{s,2},<span class="string">'&lt;/TD&gt;&lt;/TR&gt; &lt;/table&gt;&lt;/html&gt;'</span>];
3837     <span class="keyword">else</span>
3838         tmpString{s} = [<span class="string">'&lt;html&gt;&lt;table border=0 &gt;&lt;TR&gt;&lt;TD bgcolor='</span>,clr,<span class="string">' width=&quot;18&quot;&gt;&lt;/TD&gt;&lt;TD&gt;'</span>,cst{s,2},<span class="string">'&lt;/TD&gt;&lt;/TR&gt; &lt;/table&gt;&lt;/html&gt;'</span>];
3839     <span class="keyword">end</span>
3840 <span class="keyword">end</span>
3841 set(handles.legendTable,<span class="string">'String'</span>,tmpString);
3842 
3843 <span class="comment">%-- generates the CST table</span>
3844 <a name="_sub116" href="#_subfunctions" class="code">function cst = generateCstTable(handles,cst)</a>
3845 
3846 cst = <a href="#_sub115" class="code" title="subfunction cst = updateStructureTable(handles,cst)">updateStructureTable</a>(handles,cst);
3847 
3848 cstPanel = handles.uipanel3;
3849 
3850 <span class="comment">%Get units in pixels to to calculate aspect ratio</span>
3851 cstPanelPosUnit = get(cstPanel,<span class="string">'Units'</span>);
3852 set(cstPanel,<span class="string">'Units'</span>,<span class="string">'pixels'</span>);
3853 cstPanelPosPix = get(cstPanel,<span class="string">'Position'</span>);
3854 set(cstPanel,<span class="string">'Units'</span>,cstPanelPosUnit);
3855 
3856 aspectRatio = cstPanelPosPix(3) / cstPanelPosPix(4);
3857 
3858 <span class="comment">%Parameters for line height</span>
3859 objHeight = 0.095;<span class="comment">% 22;</span>
3860 lineHeight = 0.1; <span class="comment">%25; %Height of a table line</span>
3861 yTopSep = 0.12;<span class="comment">%40; %Separation of the first line from the top</span>
3862 tableViewHeight = 1 - yTopSep; 
3863 
3864 <span class="comment">%Define the widths of the fields relatively</span>
3865 buttonW = objHeight / aspectRatio; <span class="comment">% Make button squared</span>
3866 nameW = 3.5*buttonW;
3867 typeW = 3*buttonW;
3868 opW = buttonW;
3869 <a name="_sub117" href="#_subfunctions" class="code">functionW = 6*buttonW;</a>
3870 penaltyW = 2*buttonW;
3871 paramTitleW = 4*buttonW;
3872 paramW = 2*buttonW;
3873 fieldSep = 0.25*buttonW; <span class="comment">%Separation between fields horizontally</span>
3874 
3875 
3876 <span class="comment">%Scrollbar</span>
3877 <span class="comment">%Check if a scrollbar already exists to get possible position of slider</span>
3878 cstPanelChildren = get(cstPanel,<span class="string">'Children'</span>);
3879 cstVertTableScroll = findobj(cstPanelChildren,<span class="string">'Style'</span>,<span class="string">'slider'</span>);
3880 <span class="keyword">if</span> isempty(cstVertTableScroll)
3881     sliderPos = 0;
3882 <span class="keyword">else</span>
3883     sliderPos = get(cstVertTableScroll,<span class="string">'Max'</span>) - get(cstVertTableScroll,<span class="string">'Value'</span>);
3884 <span class="keyword">end</span>
3885 
3886 ypos = @(c) tableViewHeight - c*lineHeight + sliderPos;
3887 
3888 <span class="comment">%Clean the whole panel for new setup</span>
3889 delete(cstPanelChildren);
3890 
3891 <span class="comment">%Creates a dummy axis to allow for the use of textboxes instead of uicontrol to be able to use the (la)tex interpreter</span>
3892 tmpAxes = axes(<span class="string">'Parent'</span>,cstPanel,<span class="string">'units'</span>,<span class="string">'normalized'</span>,<span class="string">'position'</span>,[0 0 1 1],<span class="string">'visible'</span>,<span class="string">'off'</span>);
3893 
3894 organTypes = {<span class="string">'OAR'</span>, <span class="string">'TARGET'</span>};
3895 
3896 <span class="comment">%columnname = {'VOI name','VOI type','priority','obj. / const.'};%,'penalty','dose', 'EUD','volume','robustness'};</span>
3897            
3898 <span class="comment">%Get all Classes &amp; classNames</span>
3899 mpkgObjectives = meta.package.fromName(<span class="string">'DoseObjectives'</span>);
3900 mpkgConstraints = meta.package.fromName(<span class="string">'DoseConstraints'</span>);
3901 classList = [mpkgObjectives.ClassList; mpkgConstraints.ClassList];
3902 
3903 classList = classList(not([classList.Abstract]));
3904 
3905 <span class="comment">%Now get the &quot;internal&quot; name from the properties</span>
3906 classNames = cell(2,numel(classList));
3907 <span class="keyword">for</span> clIx = 1:numel(classList)
3908     cl = classList(clIx);
3909     pList = cl.PropertyList; <span class="comment">%Get List of all properties</span>
3910     pNameIx = arrayfun(@(p) strcmp(p.Name,<span class="string">'name'</span>),pList); <span class="comment">%get index of the &quot;name&quot; property</span>
3911     p = pList(pNameIx); <span class="comment">%select name property</span>
3912     pName = p.DefaultValue; <span class="comment">% get value / name</span>
3913     classNames(:,clIx) = {cl.Name; pName}; <span class="comment">%Store class name and display name</span>
3914 <span class="keyword">end</span>
3915 
3916 numOfObjectives = sum(cellfun(@numel,cst(:,6)));
3917 
3918 cnt = 0;
3919 
3920 newline = <span class="string">'\n'</span>;
3921 
3922 <span class="comment">%Setup Headlines</span>
3923 xPos = 0.01; <span class="comment">%5</span>
3924 
3925 h = uicontrol(cstPanel,<span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="string">'String'</span>,<span class="string">'+/-'</span>,<span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="string">'Position'</span>,[xPos ypos(cnt) buttonW objHeight],<span class="string">'TooltipString'</span>,<span class="string">'Remove or add Constraint or Objective'</span>);
3926 tmp_pos = get(h,<span class="string">'Position'</span>);
3927 xPos = xPos + tmp_pos(3) + fieldSep;
3928 h = uicontrol(cstPanel,<span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="string">'String'</span>,<span class="string">'VOI name'</span>,<span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="string">'Position'</span>,[xPos ypos(cnt) nameW objHeight],<span class="string">'TooltipString'</span>,<span class="string">'Name of the structure with objective/constraint'</span>);
3929 tmp_pos = get(h,<span class="string">'Position'</span>);
3930 xPos = xPos + tmp_pos(3) + fieldSep;
3931 h = uicontrol(cstPanel,<span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="string">'String'</span>,<span class="string">'VOI type'</span>,<span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="string">'Position'</span>,[xPos ypos(cnt) typeW objHeight],<span class="string">'TooltipString'</span>,<span class="string">'Segmentation Classification'</span>);
3932 tmp_pos = get(h,<span class="string">'Position'</span>);
3933 xPos = xPos + tmp_pos(3) + fieldSep;
3934 h = uicontrol(cstPanel,<span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="string">'String'</span>,<span class="string">'OP'</span>,<span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="string">'Position'</span>,[xPos ypos(cnt) opW objHeight],<span class="string">'TooltipString'</span>,[<span class="string">'Overlap Priority'</span> char(10) <span class="string">'(Smaller number overlaps higher number)'</span>]);
3935 tmp_pos = get(h,<span class="string">'Position'</span>);
3936 xPos = xPos + tmp_pos(3) + fieldSep;
3937 h = uicontrol(cstPanel,<span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="string">'String'</span>,<span class="string">'Function'</span>,<span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="string">'Position'</span>,[xPos ypos(cnt) functionW objHeight],<span class="string">'TooltipString'</span>,<span class="string">'Objective/Constraint function type'</span>);
3938 tmp_pos = get(h,<span class="string">'Position'</span>);
3939 xPos = xPos + tmp_pos(3) + fieldSep;
3940 h = uicontrol(cstPanel,<span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="string">'String'</span>,<span class="string">'p'</span>,<span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="string">'Position'</span>,[xPos ypos(cnt) penaltyW objHeight],<span class="string">'TooltipString'</span>,<span class="string">'Optimization penalty'</span>);
3941 tmp_pos = get(h,<span class="string">'Position'</span>);
3942 xPos = xPos + tmp_pos(3) + fieldSep;
3943 h = uicontrol(cstPanel,<span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="string">'String'</span>,<span class="string">'| Parameters'</span>,<span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="string">'Position'</span>,[xPos ypos(cnt) paramTitleW objHeight],<span class="string">'TooltipString'</span>,<span class="string">'List of parameters'</span>,<span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>);
3944 tmp_pos = get(h,<span class="string">'Position'</span>);
3945 xPos = xPos + tmp_pos(3) + fieldSep;
3946 cnt = cnt + 1;
3947 
3948 <span class="comment">%Create Objectives / Constraints controls</span>
3949 <span class="keyword">for</span> i = 1:size(cst,1)   
3950     <span class="keyword">if</span> strcmp(cst(i,3),<span class="string">'IGNORED'</span>)~=1
3951         <span class="comment">%Compatibility Layer for old objective format</span>
3952         <span class="keyword">if</span> isstruct(cst{i,6})
3953             cst{i,6} = arrayfun(@matRad_DoseOptimizationFunction.convertOldOptimizationStruct,cst{i,6},<span class="string">'UniformOutput'</span>,false);
3954         <span class="keyword">end</span>
3955         <span class="keyword">for</span> j=1:numel(cst{i,6})
3956       
3957            obj = cst{i,6}{j};
3958            
3959            <span class="comment">%Convert to class if not</span>
3960            <span class="keyword">if</span> ~isa(obj,<span class="string">'matRad_DoseOptimizationFunction'</span>)
3961                 <span class="keyword">try</span>
3962                     obj = matRad_DoseOptimizationFunction.createInstanceFromStruct(obj);
3963                 <span class="keyword">catch</span> ME
3964                     warning(<span class="string">'Objective/Constraint not valid!\n%s'</span>,ME.message)
3965                     <span class="keyword">continue</span>;
3966                 <span class="keyword">end</span>
3967            <span class="keyword">end</span>
3968 
3969            <span class="comment">%VOI</span>
3970            xPos = 0.01;<span class="comment">%5;</span>
3971            
3972            h = uicontrol(cstPanel,<span class="string">'Style'</span>,<span class="string">'pushbutton'</span>,<span class="string">'String'</span>,<span class="string">'-'</span>,<span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="string">'Position'</span>,[xPos ypos(cnt) buttonW objHeight],<span class="string">'TooltipString'</span>,<span class="string">'Remove Objective/Constraint'</span>,<span class="string">'Callback'</span>,{@<a href="#_sub120" class="code" title="subfunction btObjRemove_Callback(hObject, ~, handles)">btObjRemove_Callback</a>,handles},<span class="keyword">...</span>
3973                <span class="string">'UserData'</span>,[i,j]);
3974            tmp_pos = get(h,<span class="string">'Position'</span>);
3975            xPos = xPos + tmp_pos(3) + fieldSep;
3976            h = uicontrol(cstPanel',<span class="string">'Style'</span>,<span class="string">'edit'</span>,<span class="string">'String'</span>,cst{i,2},<span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="string">'Position'</span>,[xPos ypos(cnt) nameW objHeight],<span class="string">'TooltipString'</span>,<span class="string">'Name'</span>,<span class="keyword">...</span>
3977                <span class="string">'Enable'</span>,<span class="string">'inactive'</span>,<span class="keyword">...</span><span class="comment"> %Disable editing of name atm</span>
3978                <span class="string">'UserData'</span>,[i,2],<span class="string">'Callback'</span>,{@<a href="#_sub123" class="code" title="subfunction editCstParams_Callback(hObject,~,handles)">editCstParams_Callback</a>,handles}); <span class="comment">%Callback added, however, editing is disabled atm</span>
3979            tmp_pos = get(h,<span class="string">'Position'</span>);
3980            xPos = xPos + tmp_pos(3) + fieldSep;
3981            h = uicontrol(cstPanel,<span class="string">'Style'</span>,<span class="string">'popupmenu'</span>,<span class="string">'String'</span>,organTypes',<span class="string">'Value'</span>,find(strcmp(cst{i,3},organTypes)),<span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="string">'Position'</span>,[xPos ypos(cnt) typeW objHeight],<span class="string">'TooltipString'</span>,<span class="string">'Segmentation Classification'</span>,<span class="keyword">...</span>
3982                <span class="string">'UserData'</span>,[i,3],<span class="string">'Callback'</span>,{@<a href="#_sub123" class="code" title="subfunction editCstParams_Callback(hObject,~,handles)">editCstParams_Callback</a>,handles});
3983            tmp_pos = get(h,<span class="string">'Position'</span>);
3984            xPos = xPos + tmp_pos(3) + fieldSep;
3985            h = uicontrol(cstPanel,<span class="string">'Style'</span>,<span class="string">'edit'</span>,<span class="string">'String'</span>,num2str(cst{i,5}.Priority),<span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="string">'Position'</span>,[xPos ypos(cnt) opW objHeight],<span class="string">'TooltipString'</span>,[<span class="string">'Overlap Priority'</span> newline <span class="string">'(Smaller number overlaps higher number)'</span>],<span class="keyword">...</span>
3986                <span class="string">'UserData'</span>,[i,5],<span class="string">'Callback'</span>,{@<a href="#_sub123" class="code" title="subfunction editCstParams_Callback(hObject,~,handles)">editCstParams_Callback</a>,handles});
3987            tmp_pos = get(h,<span class="string">'Position'</span>);
3988            xPos = xPos + tmp_pos(3) + fieldSep;
3989            
3990            h = uicontrol(cstPanel,<span class="string">'Style'</span>,<span class="string">'popupmenu'</span>,<span class="string">'String'</span>,classNames(2,:)',<span class="string">'Value'</span>,find(strcmp(obj.name,classNames(2,:))),<span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="string">'Position'</span>,[xPos ypos(cnt) functionW objHeight],<span class="string">'TooltipString'</span>,<span class="string">'Select Objective/Constraint'</span>,<span class="keyword">...</span>
3991                <span class="string">'UserData'</span>,{[i,j],classNames(1,:)},<span class="string">'Callback'</span>,{@<a href="#_sub122" class="code" title="subfunction changeObjFunction_Callback(hObject, ~, handles)">changeObjFunction_Callback</a>,handles});
3992            tmp_pos = get(h,<span class="string">'Position'</span>);
3993            xPos = xPos + tmp_pos(3) + fieldSep;
3994            
3995            <span class="comment">%Check if we have an objective to display penalty</span>
3996            <span class="keyword">if</span> isa(obj,<span class="string">'DoseObjectives.matRad_DoseObjective'</span>)
3997                h = uicontrol(cstPanel,<span class="string">'Style'</span>,<span class="string">'edit'</span>,<span class="string">'String'</span>,num2str(obj.penalty),<span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="string">'Position'</span>,[xPos ypos(cnt) penaltyW objHeight],<span class="string">'TooltipString'</span>,<span class="string">'Objective Penalty'</span>,<span class="string">'UserData'</span>,[i,j,0],<span class="string">'Callback'</span>,{@<a href="#_sub121" class="code" title="subfunction editObjParam_Callback(hObject, ~, handles)">editObjParam_Callback</a>,handles});
3998            <span class="keyword">else</span>
3999                h = uicontrol(cstPanel,<span class="string">'Style'</span>,<span class="string">'edit'</span>,<span class="string">'String'</span>,<span class="string">'----'</span>,<span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="string">'Position'</span>,[xPos ypos(cnt) penaltyW objHeight],<span class="string">'Enable'</span>,<span class="string">'off'</span>);
4000            <span class="keyword">end</span>
4001            tmp_pos = get(h,<span class="string">'Position'</span>);
4002            xPos = xPos + tmp_pos(3) + fieldSep;
4003            
4004            <span class="comment">%Iterate through parameters</span>
4005            <span class="keyword">for</span> p = 1:numel(obj.parameterNames)
4006               h = text(<span class="string">'Parent'</span>,tmpAxes,<span class="string">'String'</span>,[<span class="string">'| '</span> obj.parameterNames{p} <span class="string">':'</span>],<span class="string">'VerticalAlignment'</span>,<span class="string">'middle'</span>,<span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="string">'Position'</span>,[xPos ypos(cnt)+lineHeight/2],<span class="string">'Interpreter'</span>,<span class="string">'tex'</span>,<span class="string">'FontWeight'</span>,<span class="string">'normal'</span>,<span class="keyword">...</span>
4007                   <span class="string">'FontSize'</span>,get(cstPanel,<span class="string">'FontSize'</span>),<span class="string">'FontName'</span>,get(cstPanel,<span class="string">'FontName'</span>),<span class="string">'FontUnits'</span>,get(cstPanel,<span class="string">'FontUnits'</span>),<span class="string">'FontWeight'</span>,<span class="string">'normal'</span>);
4008               tmp_pos = get(h,<span class="string">'Extent'</span>);
4009               xPos = xPos + tmp_pos(3) + fieldSep;
4010               
4011               <span class="comment">%Check if we have a cell and therefore a parameter list</span>
4012               <span class="keyword">if</span> iscell(obj.parameterTypes{p})                  
4013                   h = uicontrol(cstPanel,<span class="string">'Style'</span>,<span class="string">'popupmenu'</span>,<span class="string">'String'</span>,obj.parameterTypes{p}',<span class="string">'Value'</span>,obj.parameters{p},<span class="string">'TooltipString'</span>,obj.parameterNames{p},<span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="string">'Position'</span>,[xPos ypos(cnt) paramW*2 objHeight],<span class="string">'UserData'</span>,[i,j,p],<span class="string">'Callback'</span>,{@<a href="#_sub121" class="code" title="subfunction editObjParam_Callback(hObject, ~, handles)">editObjParam_Callback</a>,handles});
4014               <span class="keyword">else</span>
4015                 h = uicontrol(cstPanel,<span class="string">'Style'</span>,<span class="string">'edit'</span>,<span class="string">'String'</span>,num2str(obj.parameters{p}),<span class="string">'TooltipString'</span>,obj.parameterNames{p},<span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="string">'Position'</span>,[xPos ypos(cnt) paramW objHeight],<span class="string">'UserData'</span>,[i,j,p],<span class="string">'Callback'</span>,{@<a href="#_sub121" class="code" title="subfunction editObjParam_Callback(hObject, ~, handles)">editObjParam_Callback</a>,handles});
4016               <span class="keyword">end</span>
4017               
4018               tmp_pos = get(h,<span class="string">'Position'</span>);
4019               xPos = xPos + tmp_pos(3) + fieldSep;
4020            <span class="keyword">end</span>
4021 
4022            cnt = cnt +1;
4023        <span class="keyword">end</span>
4024    <span class="keyword">end</span>   
4025 <span class="keyword">end</span>
4026 xPos = 0.01; <span class="comment">%5</span>
4027 hAdd = uicontrol(cstPanel,<span class="string">'Style'</span>,<span class="string">'pushbutton'</span>,<span class="string">'String'</span>,<span class="string">'+'</span>,<span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="string">'Position'</span>,[xPos ypos(cnt) buttonW objHeight],<span class="string">'TooltipString'</span>,<span class="string">'Add Objective/Constraint'</span>,<span class="string">'Callback'</span>,{@<a href="#_sub119" class="code" title="subfunction btObjAdd_Callback(hObject, ~, handles)">btObjAdd_Callback</a>,handles});
4028 tmp_pos = get(hAdd,<span class="string">'Position'</span>);
4029 xPos = xPos + tmp_pos(3) + fieldSep;
4030 h = uicontrol(cstPanel,<span class="string">'Style'</span>,<span class="string">'popupmenu'</span>,<span class="string">'String'</span>,cst(:,2)',<span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="string">'Position'</span>,[xPos ypos(cnt) nameW objHeight]);
4031 set(hAdd,<span class="string">'UserData'</span>,h);
4032 
4033 <span class="comment">%Calculate Scrollbar / Slider Position</span>
4034 lastPos = ypos(cnt);
4035 firstPos = ypos(0);
4036 tableHeight = abs(firstPos - lastPos);
4037 
4038 exceedFac = tableHeight / tableViewHeight; <span class="comment">%How much the current umber of rows exceeds the window height capacity</span>
4039 <span class="keyword">if</span> exceedFac &gt; 1
4040     sliderFac = exceedFac - 1; 
4041     uicontrol(cstPanel,<span class="string">'Style'</span>,<span class="string">'slider'</span>,<span class="string">'Units'</span>,<span class="string">'normalized'</span>,<span class="string">'Position'</span>,[0.975 0 0.025 1],<span class="string">'Min'</span>,0,<span class="string">'Max'</span>,ceil(sliderFac)*tableViewHeight,<span class="string">'SliderStep'</span>,[lineHeight tableViewHeight] ./ (ceil(sliderFac)*tableViewHeight),<span class="string">'Value'</span>,ceil(sliderFac)*tableViewHeight - sliderPos,<span class="string">'Callback'</span>,{@<a href="#_sub126" class="code" title="subfunction cstTableSlider_Callback(hObject, eventdata, handles)">cstTableSlider_Callback</a>,handles});
4042 <span class="keyword">end</span>
4043  
4044 
4045 <span class="comment">% --- Executes when uipanel3 is resized.</span>
4046 <a name="_sub118" href="#_subfunctions" class="code">function uipanel3_SizeChangedFcn(hObject, eventdata, handles)</a>
4047 <span class="comment">% hObject    handle to uipanel3 (see GCBO)</span>
4048 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
4049 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
4050 
4051 <span class="keyword">try</span>
4052     <a href="#_sub116" class="code" title="subfunction cst = generateCstTable(handles,cst)">generateCstTable</a>(handles,evalin(<span class="string">'base'</span>,<span class="string">'cst'</span>));
4053 <span class="keyword">catch</span>
4054 <span class="keyword">end</span>
4055 
4056 <a name="_sub119" href="#_subfunctions" class="code">function btObjAdd_Callback(hObject, ~, handles)</a>
4057 <span class="comment">% hObject    handle to btObjAdd</span>
4058 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
4059 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
4060 popupHandle = hObject.UserData;
4061 cstIndex = popupHandle.Value;
4062 
4063 cst = evalin(<span class="string">'base'</span>,<span class="string">'cst'</span>);
4064 <span class="comment">%Add Standard Objective</span>
4065 <span class="keyword">if</span> strcmp(cst{cstIndex,3},<span class="string">'TARGET'</span>)
4066     cst{cstIndex,6}{end+1} = struct(DoseObjectives.matRad_SquaredDeviation);
4067 <span class="keyword">else</span>
4068     cst{cstIndex,6}{end+1} = struct(DoseObjectives.matRad_SquaredOverdosing);
4069 <span class="keyword">end</span>
4070 
4071 assignin(<span class="string">'base'</span>,<span class="string">'cst'</span>,cst);
4072 
4073 <a href="#_sub116" class="code" title="subfunction cst = generateCstTable(handles,cst)">generateCstTable</a>(handles,cst);
4074 
4075 <a name="_sub120" href="#_subfunctions" class="code">function btObjRemove_Callback(hObject, ~, handles)</a>
4076 <span class="comment">% hObject    handle to btObjRemove (see GCBO)</span>
4077 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
4078 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
4079 ix = hObject.UserData;
4080 
4081 cst = evalin(<span class="string">'base'</span>,<span class="string">'cst'</span>);
4082 <span class="comment">%Add Standard Objective</span>
4083 
4084 cst{ix(1),6}(ix(2)) = [];
4085 
4086 assignin(<span class="string">'base'</span>,<span class="string">'cst'</span>,cst);
4087 
4088 <a href="#_sub116" class="code" title="subfunction cst = generateCstTable(handles,cst)">generateCstTable</a>(handles,cst);
4089 
4090 <a name="_sub121" href="#_subfunctions" class="code">function editObjParam_Callback(hObject, ~, handles)</a>
4091 <span class="comment">% hObject    handle to current objective parameter</span>
4092 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
4093 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
4094 ix = hObject.UserData;
4095 
4096 cst = evalin(<span class="string">'base'</span>,<span class="string">'cst'</span>);
4097 <span class="comment">%Add Standard Objective</span>
4098 
4099 <span class="comment">%if the third index is 0 we changed the penalty</span>
4100 <span class="comment">%if we have a popupmenu selection we use value</span>
4101 <span class="comment">%otherwise we use the edit string</span>
4102 
4103 <span class="keyword">if</span> ix(3) == 0
4104     cst{ix(1),6}{ix(2)}.penalty = str2double(hObject.String);
4105 <span class="keyword">elseif</span> isequal(hObject.Style,<span class="string">'popupmenu'</span>)
4106     cst{ix(1),6}{ix(2)}.parameters{ix(3)} = hObject.Value;
4107 <span class="keyword">else</span>
4108     cst{ix(1),6}{ix(2)}.parameters{ix(3)} = str2double(hObject.String);
4109 <span class="keyword">end</span>
4110     
4111 assignin(<span class="string">'base'</span>,<span class="string">'cst'</span>,cst);
4112 
4113 <a href="#_sub116" class="code" title="subfunction cst = generateCstTable(handles,cst)">generateCstTable</a>(handles,cst);
4114 
4115 <a name="_sub122" href="#_subfunctions" class="code">function changeObjFunction_Callback(hObject, ~, handles)</a>
4116 <span class="comment">% hObject    handle to objective popup</span>
4117 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
4118 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
4119 data = hObject.UserData;
4120 ix = data{1};
4121 classNames = data{2};
4122 classToCreate = classNames{hObject.Value};
4123 
4124 cst = evalin(<span class="string">'base'</span>,<span class="string">'cst'</span>);
4125 <span class="comment">%Add Standard Objective</span>
4126 
4127 <span class="comment">%We just check if the user really wanted to change the objective to be</span>
4128 <span class="comment">%user-friendly</span>
4129 currentObj = cst{ix(1),6}{ix(2)};
4130 currentClass = class(currentObj);
4131 <span class="keyword">if</span> ~strcmp(currentClass,classToCreate)    
4132     newObj = eval(classToCreate);
4133     
4134     <span class="comment">% Only if we have a penalty value for optimization, apply the new one</span>
4135     <span class="comment">% Maybe this check should be more exact?</span>
4136     <span class="keyword">if</span> (isfield(currentObj,<span class="string">'penalty'</span>) || isprop(currentObj,<span class="string">'penalty'</span>)) &amp;&amp; isprop(newObj,<span class="string">'penalty'</span>)
4137         newObj.penalty = currentObj.penalty;
4138     <span class="keyword">end</span>
4139     
4140     cst{ix(1),6}{ix(2)} = struct(newObj);
4141     
4142     assignin(<span class="string">'base'</span>,<span class="string">'cst'</span>,cst);   
4143     
4144     <a href="#_sub116" class="code" title="subfunction cst = generateCstTable(handles,cst)">generateCstTable</a>(handles,cst);
4145 <span class="keyword">end</span>
4146 
4147 <a name="_sub123" href="#_subfunctions" class="code">function editCstParams_Callback(hObject,~,handles)</a>
4148 data = hObject.UserData;
4149 ix = data(1);
4150 col = data(2);
4151 
4152 cst = evalin(<span class="string">'base'</span>,<span class="string">'cst'</span>);
4153 
4154 <span class="keyword">switch</span> col
4155     <span class="keyword">case</span> 2
4156         cst{ix,col} = hObject.String;
4157     <span class="keyword">case</span> 3
4158         cst{ix,col} = hObject.String{hObject.Value};
4159     <span class="keyword">case</span> 5
4160         cst{ix,col}.Priority = uint32(str2double(hObject.String));
4161     <span class="keyword">otherwise</span>
4162         warning(<span class="string">'Wrong column assignment in GUI based cst setting'</span>);
4163 <span class="keyword">end</span>
4164 
4165 assignin(<span class="string">'base'</span>,<span class="string">'cst'</span>,cst);
4166 
4167 <a href="#_sub116" class="code" title="subfunction cst = generateCstTable(handles,cst)">generateCstTable</a>(handles,cst);
4168 
4169     
4170 <span class="comment">% --- Executes on button press in radiobutton3Dconf.</span>
4171 <a name="_sub124" href="#_subfunctions" class="code">function radiobutton3Dconf_Callback(hObject, eventdata, handles)</a>
4172 <span class="comment">% hObject    handle to radiobutton3Dconf (see GCBO)</span>
4173 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
4174 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
4175 
4176 <span class="comment">% Hint: get(hObject,'Value') returns toggle state of radiobutton3Dconf</span>
4177 
4178 <a name="_sub125" href="#_subfunctions" class="code">function x = matRad_checkForConnectedBixelRows(stf)</a>
4179 
4180 x = true;
4181 
4182 <span class="keyword">for</span> i = 1:size(stf,2)
4183     
4184     bixelPos = reshape([stf(i).ray.rayPos_bev],3,[]);
4185    
4186     rowCoords = unique(bixelPos(3,:));
4187     
4188     <span class="keyword">for</span> j = 1:numel(rowCoords)
4189         
4190         increments = diff(bixelPos(1,rowCoords(j) == bixelPos(3,:)));
4191         
4192         <span class="comment">% if we find one not connected row -&gt; return false</span>
4193         <span class="keyword">if</span> numel(unique(increments)) &gt; 1
4194             x = false;
4195             <span class="keyword">return</span>;
4196         <span class="keyword">end</span>
4197     <span class="keyword">end</span>
4198     
4199 <span class="keyword">end</span>
4200 
4201 <span class="comment">% --- Executes on slider movement.</span>
4202 <a name="_sub126" href="#_subfunctions" class="code">function cstTableSlider_Callback(hObject, eventdata, handles)</a>
4203 <span class="comment">% hObject    handle to cstTableSlider (see GCBO)</span>
4204 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
4205 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
4206 
4207 <span class="comment">% Hints: get(hObject,'Value') returns position of slider</span>
4208 <span class="comment">%        get(hObject,'Min') and get(hObject,'Max') to determine range of slider</span>
4209 <a href="#_sub116" class="code" title="subfunction cst = generateCstTable(handles,cst)">generateCstTable</a>(handles,evalin(<span class="string">'base'</span>,<span class="string">'cst'</span>));
4210 
4211 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
4212 <a name="_sub127" href="#_subfunctions" class="code">function cstTableSlider_CreateFcn(hObject, eventdata, handles)</a>
4213 <span class="comment">% hObject    handle to cstTableSlider (see GCBO)</span>
4214 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
4215 <span class="comment">% handles    empty - handles not created until after all CreateFcns called</span>
4216 
4217 <span class="comment">% Hint: slider controls usually have a light gray background.</span>
4218 <span class="keyword">if</span> isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
4219     set(hObject,<span class="string">'BackgroundColor'</span>,[.9 .9 .9]);
4220 <span class="keyword">end</span>
4221</pre></div>
<hr><address><a href="https://e0404.github.io/matRad/" target="_parent"><img src="https://camo.githubusercontent.com/0a593ef6a04757c975b9f4634f6731ea0b019bbd/68747470733a2f2f7261776769742e636f6d2f77696b692f65303430342f6d61745261642f696d616765732f6d61747261645f626c616e6b2e737667" height="12px"/></a> | Generated by  <a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>