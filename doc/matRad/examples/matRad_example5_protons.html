<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of matRad_example5_protons</title>
  <meta name="keywords" content="matRad_example5_protons">
  <meta name="description" content="% Example: Proton Treatment Plan with subsequent Isocenter shift">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../menu.html matRad --><!-- menu.html examples -->
<h1>matRad_example5_protons
</h1>

<h2><a name="_name"></a>Purpose <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box">% Example: Proton Treatment Plan with subsequent Isocenter shift</div>

<h2><a name="_synopsis"></a>Synopsis <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box">This is a script file. </div>

<h2><a name="_description"></a>Description <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">% Example: Proton Treatment Plan with subsequent Isocenter shift

 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

 Copyright 2017 the matRad development team. 
 
 This file is part of the matRad project. It is subject to the license 
 terms in the LICENSE file found in the top-level directory of this 
 distribution and at https://github.com/e0404/matRad/LICENSES.txt. No part 
 of the matRad project, including this file, may be copied, modified, 
 propagated, or distributed except according to the terms contained in the 
 LICENSE file.

 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>Cross-reference information <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-type:disc">
<li><a href="../../matRad/matRad_calcDoseDirect.html" class="code" title="function resultGUI = matRad_calcDoseDirect(ct,stf,pln,cst,w)">matRad_calcDoseDirect</a>	matRad dose calculation wrapper bypassing dij calculation</li><li><a href="../../matRad/matRad_calcParticleDose.html" class="code" title="function dij = matRad_calcParticleDose(ct,stf,pln,cst,calcDoseDirect)">matRad_calcParticleDose</a>	matRad particle dose calculation wrapper</li><li><a href="../../matRad/matRad_fluenceOptimization.html" class="code" title="function [resultGUI,optimizer] = matRad_fluenceOptimization(dij,cst,pln)">matRad_fluenceOptimization</a>	matRad inverse planning wrapper function</li><li><a href="../../matRad/matRad_generateStf.html" class="code" title="function stf = matRad_generateStf(ct,cst,pln,visMode)">matRad_generateStf</a>	matRad steering information generation</li><li><a href="../../matRad/matRad_getIsoCenter.html" class="code" title="function isoCenter = matRad_getIsoCenter(cst,ct,visBool)">matRad_getIsoCenter</a>	computes the isocenter [mm] as the joint center of gravity</li><li><a href="../../matRad/matRad_rc.html" class="code" title="">matRad_rc</a>	matRad rc script</li><li><a href="../../matRad/tools/matRad_gammaIndex.html" class="code" title="function [gammaCube,gammaPassRateCell] = matRad_gammaIndex(cube1,cube2,resolution,criteria,slice,n,localglobal,cst)">matRad_gammaIndex</a>	gamma index calculation</li><li><a href="../../matRad/tools/matRad_getEnvironment.html" class="code" title="function [env, versionString] = matRad_getEnvironment()">matRad_getEnvironment</a>	matRad function to get the software environment matRad is running on</li><li><a href="../../matRad/tools/matRad_plotSliceWrapper.html" class="code" title="function [hCMap,hDose,hCt,hContour,hIsoDose] = matRad_plotSliceWrapper(axesHandle,ct,cst,cubeIdx,dose,plane,slice,thresh,alpha,contourColorMap,doseColorMap,doseWindow,doseIsoLevels,voiSelection,colorBarLabel,boolPlotLegend,varargin)">matRad_plotSliceWrapper</a>	matRad tool function to directly plot a complete slice of a ct with dose</li></ul>
This function is called by:
<ul style="list-style-type:disc">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>Source code <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <span class="comment">%% Example: Proton Treatment Plan with subsequent Isocenter shift</span>
0002 <span class="comment">%</span>
0003 <span class="comment">% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% Copyright 2017 the matRad development team.</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% This file is part of the matRad project. It is subject to the license</span>
0008 <span class="comment">% terms in the LICENSE file found in the top-level directory of this</span>
0009 <span class="comment">% distribution and at https://github.com/e0404/matRad/LICENSES.txt. No part</span>
0010 <span class="comment">% of the matRad project, including this file, may be copied, modified,</span>
0011 <span class="comment">% propagated, or distributed except according to the terms contained in the</span>
0012 <span class="comment">% LICENSE file.</span>
0013 <span class="comment">%</span>
0014 <span class="comment">% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0015 
0016 <span class="comment">%%</span>
0017 <span class="comment">% In this example we will show</span>
0018 <span class="comment">% (i) how to load patient data into matRad</span>
0019 <span class="comment">% (ii) how to setup a proton dose calculation</span>
0020 <span class="comment">% (iii) how to inversely optimize the pencil beam intensities directly from command window in MATLAB.</span>
0021 <span class="comment">% (iv) how to simulate a lateral patient displacement by shifting the iso-center</span>
0022 <span class="comment">% (v) how to recalculated the dose considering the shifted geometry and the previously optimized pencil beam intensities</span>
0023 <span class="comment">% (vi) how to compare the two results</span>
0024 
0025 <span class="comment">%% Patient Data Import</span>
0026 <span class="comment">% Let's begin with a clear Matlab environment and import the prostate</span>
0027 <span class="comment">% patient into your workspace</span>
0028 
0029 <a href="../../matRad/matRad_rc.html" class="code" title="">matRad_rc</a>; <span class="comment">%If this throws an error, run it from the parent directory first to set the paths</span>
0030 
0031 load(<span class="string">'PROSTATE.mat'</span>);
0032 
0033 <span class="comment">%% Treatment Plan</span>
0034 <span class="comment">% The next step is to define your treatment plan labeled as 'pln'. This</span>
0035 <span class="comment">% structure requires input from the treatment planner and defines the most</span>
0036 <span class="comment">% important cornerstones of your treatment plan.</span>
0037 
0038 <span class="comment">%%</span>
0039 <span class="comment">% First of all, we need to define what kind of radiation modality we would</span>
0040 <span class="comment">% like to use. Possible values are photons, protons or carbon. In this</span>
0041 <span class="comment">% example we would like to use protons for treatment planning. Next, we</span>
0042 <span class="comment">% need to define a treatment machine to correctly load the corresponding</span>
0043 <span class="comment">% base data. matRad features generic base data in the file</span>
0044 <span class="comment">% 'proton_Generic.mat'; consequently the machine has to be set accordingly</span>
0045 pln.radiationMode = <span class="string">'protons'</span>;        
0046 pln.machine       = <span class="string">'Generic'</span>;
0047 
0048 <span class="comment">%%</span>
0049 <span class="comment">% Define the flavor of biological optimization for treatment planning along</span>
0050 <span class="comment">% with the quantity that should be used for optimization. Possible values</span>
0051 <span class="comment">% are (none: physical optimization; const_RBExD: constant RBE of 1.1;</span>
0052 <span class="comment">% LEMIV_effect: effect-based optimization; LEMIV_RBExD: optimization of</span>
0053 <span class="comment">% RBE-weighted dose. As we use protons, we follow here the clinical</span>
0054 <span class="comment">% standard and use a constant relative biological effectiveness of 1.1.</span>
0055 <span class="comment">% Therefore we set bioOptimization to const_RBExD</span>
0056 pln.propOpt.bioOptimization = <span class="string">'const_RBExD'</span>;
0057 
0058 <span class="comment">%%</span>
0059 <span class="comment">% for particles it is possible to also calculate the LET disutribution</span>
0060 <span class="comment">% alongside the physical dose. Therefore you need to activate the</span>
0061 <span class="comment">% corresponding option during dose calculcation</span>
0062 pln.propDoseCalc.calcLET = 1;
0063                                        
0064 <span class="comment">%%</span>
0065 <span class="comment">% Now we have to set the remaining plan parameters.</span>
0066 pln.numOfFractions        = 30;
0067 pln.propStf.gantryAngles  = [90 270];
0068 pln.propStf.couchAngles   = [0 0];
0069 pln.propStf.bixelWidth    = 3;
0070 pln.propStf.numOfBeams    = numel(pln.propStf.gantryAngles);
0071 pln.propStf.isoCenter     = ones(pln.propStf.numOfBeams,1) * <a href="../../matRad/matRad_getIsoCenter.html" class="code" title="function isoCenter = matRad_getIsoCenter(cst,ct,visBool)">matRad_getIsoCenter</a>(cst,ct,0);
0072 pln.propOpt.runDAO        = 0;
0073 pln.propOpt.runSequencing = 0;
0074 
0075 <span class="comment">% dose calculation settings</span>
0076 pln.propDoseCalc.doseGrid.resolution.x = 3; <span class="comment">% [mm]</span>
0077 pln.propDoseCalc.doseGrid.resolution.y = 3; <span class="comment">% [mm]</span>
0078 pln.propDoseCalc.doseGrid.resolution.z = 3; <span class="comment">% [mm]</span>
0079 
0080 <span class="comment">%% Generate Beam Geometry STF</span>
0081 stf = <a href="../../matRad/matRad_generateStf.html" class="code" title="function stf = matRad_generateStf(ct,cst,pln,visMode)">matRad_generateStf</a>(ct,cst,pln);
0082 
0083 <span class="comment">%% Dose Calculation</span>
0084 <span class="comment">% Lets generate dosimetric information by pre-computing dose influence</span>
0085 <span class="comment">% matrices for unit beamlet intensities. Having dose influences available</span>
0086 <span class="comment">% allows for subsequent inverse optimization.</span>
0087 dij = <a href="../../matRad/matRad_calcParticleDose.html" class="code" title="function dij = matRad_calcParticleDose(ct,stf,pln,cst,calcDoseDirect)">matRad_calcParticleDose</a>(ct,stf,pln,cst);
0088 
0089 <span class="comment">%% Inverse Optimization for IMPT</span>
0090 <span class="comment">% The goal of the fluence optimization is to find a set of bixel/spot</span>
0091 <span class="comment">% weights which yield the best possible dose distribution according to the</span>
0092 <span class="comment">% clinical objectives and constraints underlying the radiation treatment</span>
0093 resultGUI = <a href="../../matRad/matRad_fluenceOptimization.html" class="code" title="function [resultGUI,optimizer] = matRad_fluenceOptimization(dij,cst,pln)">matRad_fluenceOptimization</a>(dij,cst,pln);
0094 
0095 <span class="comment">%% Plot the Resulting Dose Slice</span>
0096 <span class="comment">% Let's plot the transversal iso-center dose slice</span>
0097 slice = round(pln.propStf.isoCenter(1,3)./ct.resolution.z);
0098 figure
0099 imagesc(resultGUI.RBExDose(:,:,slice)),colorbar,colormap(jet)
0100 
0101 <span class="comment">%% Plot the Resulting Beam Dose Slice</span>
0102 <span class="comment">% Let's plot the transversal iso-center dose slice of beam 1 and beam 2</span>
0103 <span class="comment">% separately</span>
0104 figure
0105 subplot(121),imagesc(resultGUI.RBExDose_beam1(:,:,slice)),colorbar,colormap(jet),title(<span class="string">'dose of beam 1'</span>)
0106 subplot(122),imagesc(resultGUI.RBExDose_beam2(:,:,slice)),colorbar,colormap(jet),title(<span class="string">'dose of beam 2'</span>)
0107 
0108 <span class="comment">%% and the corresponding LET distribution</span>
0109 <span class="comment">% Transversal iso-center slice</span>
0110 figure
0111 imagesc(resultGUI.LET(:,:,slice)),colormap(jet),colorbar,title(<span class="string">'LET [keV/µm]'</span>)
0112 
0113 <span class="comment">%%</span>
0114 <span class="comment">% Now let's simulate a patient shift in y direction for both beams</span>
0115 stf(1).isoCenter(2) = stf(1).isoCenter(2) - 4;
0116 stf(2).isoCenter(2) = stf(2).isoCenter(2) - 4;
0117 pln.propStf.isoCenter       = reshape([stf.isoCenter],[3 pln.propStf.numOfBeams])';
0118 
0119 <span class="comment">%% Recalculate Plan</span>
0120 <span class="comment">% Let's use the existing optimized pencil beam weights and recalculate the RBE weighted dose</span>
0121 resultGUI_isoShift = <a href="../../matRad/matRad_calcDoseDirect.html" class="code" title="function resultGUI = matRad_calcDoseDirect(ct,stf,pln,cst,w)">matRad_calcDoseDirect</a>(ct,stf,pln,cst,resultGUI.w);
0122 
0123 <span class="comment">%%  Visual Comparison of results</span>
0124 <span class="comment">% Let's compare the new recalculation against the optimization result.</span>
0125 plane = 3;
0126 doseWindow = [0 max([resultGUI.RBExDose(:); resultGUI_isoShift.RBExDose(:)])];
0127 
0128 figure,title(<span class="string">'original plan'</span>)
0129 <a href="../../matRad/tools/matRad_plotSliceWrapper.html" class="code" title="function [hCMap,hDose,hCt,hContour,hIsoDose] = matRad_plotSliceWrapper(axesHandle,ct,cst,cubeIdx,dose,plane,slice,thresh,alpha,contourColorMap,doseColorMap,doseWindow,doseIsoLevels,voiSelection,colorBarLabel,boolPlotLegend,varargin)">matRad_plotSliceWrapper</a>(gca,ct,cst,1,resultGUI.RBExDose,plane,slice,[],0.75,colorcube,[],doseWindow,[]);
0130 figure,title(<span class="string">'shifted plan'</span>)
0131 <a href="../../matRad/tools/matRad_plotSliceWrapper.html" class="code" title="function [hCMap,hDose,hCt,hContour,hIsoDose] = matRad_plotSliceWrapper(axesHandle,ct,cst,cubeIdx,dose,plane,slice,thresh,alpha,contourColorMap,doseColorMap,doseWindow,doseIsoLevels,voiSelection,colorBarLabel,boolPlotLegend,varargin)">matRad_plotSliceWrapper</a>(gca,ct,cst,1,resultGUI_isoShift.RBExDose,plane,slice,[],0.75,colorcube,[],doseWindow,[]);
0132  
0133 absDiffCube = resultGUI.RBExDose-resultGUI_isoShift.RBExDose;
0134 figure,title(<span class="string">'absolute difference'</span>)
0135 <a href="../../matRad/tools/matRad_plotSliceWrapper.html" class="code" title="function [hCMap,hDose,hCt,hContour,hIsoDose] = matRad_plotSliceWrapper(axesHandle,ct,cst,cubeIdx,dose,plane,slice,thresh,alpha,contourColorMap,doseColorMap,doseWindow,doseIsoLevels,voiSelection,colorBarLabel,boolPlotLegend,varargin)">matRad_plotSliceWrapper</a>(gca,ct,cst,1,absDiffCube,plane,slice,[],[],colorcube);
0136 
0137 <span class="comment">% Let's plot single profiles that are perpendicular to the beam direction</span>
0138 ixProfileY = round(pln.propStf.isoCenter(1,2)./ct.resolution.y);
0139 
0140 profileOrginal = resultGUI.RBExDose(:,ixProfileY,slice);
0141 profileShifted = resultGUI_isoShift.RBExDose(:,ixProfileY,slice);
0142 
0143 figure,plot(profileOrginal,<span class="string">'LineWidth'</span>,2),grid on,hold on, 
0144        plot(profileShifted,<span class="string">'LineWidth'</span>,2),legend({<span class="string">'original profile'</span>,<span class="string">'shifted profile'</span>}),
0145        xlabel(<span class="string">'mm'</span>),ylabel(<span class="string">'Gy(RBE)'</span>),title(<span class="string">'profile plot'</span>)
0146        
0147 <span class="comment">%% Quantitative Comparison of results</span>
0148 <span class="comment">% Compare the two dose cubes using a gamma-index analysis. The gamma index</span>
0149 <span class="comment">% is a composite quality distribution equally taking into account a dose</span>
0150 <span class="comment">% difference and a distance to agreement criterion in order to quantify</span>
0151 <span class="comment">% differences between two dose cubes. A gamma-index value of smaller than 1</span>
0152 <span class="comment">% indicates a successful test and a value greater than 1 illustrates a</span>
0153 <span class="comment">% failed test.</span>
0154 
0155 doseDifference  = 2;
0156 distToAgreement = 2;
0157 n               = 1;
0158 
0159 [gammaCube,gammaPassRateCell] = <a href="../../matRad/tools/matRad_gammaIndex.html" class="code" title="function [gammaCube,gammaPassRateCell] = matRad_gammaIndex(cube1,cube2,resolution,criteria,slice,n,localglobal,cst)">matRad_gammaIndex</a>(<span class="keyword">...</span>
0160     resultGUI_isoShift.RBExDose,resultGUI.RBExDose,<span class="keyword">...</span>
0161     [ct.resolution.x, ct.resolution.y, ct.resolution.z],<span class="keyword">...</span>
0162     [doseDifference distToAgreement],slice,n,<span class="string">'global'</span>,cst);
0163 
0164 
0165 [env, ~] = <a href="../../matRad/tools/matRad_getEnvironment.html" class="code" title="function [env, versionString] = matRad_getEnvironment()">matRad_getEnvironment</a>();
0166 <span class="comment">% Let's plot the gamma index histogram</span>
0167 figure
0168 hist(gammaCube(gammaCube&gt;0),100)
0169 title(<span class="string">'gamma index histogram'</span>)
0170 
0171 
0172</pre></div>
<hr><address><a href="https://e0404.github.io/matRad/" target="_parent"><img src="https://camo.githubusercontent.com/0a593ef6a04757c975b9f4634f6731ea0b019bbd/68747470733a2f2f7261776769742e636f6d2f77696b692f65303430342f6d61745261642f696d616765732f6d61747261645f626c616e6b2e737667" height="12px"/></a> | Generated by  <a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>